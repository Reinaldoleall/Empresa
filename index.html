<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>...</title>
    <!-- Ícones Lucide -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Google Fonts: Outfit -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Adicione ESTE SCRIPT AQUI -->
    <script>
        // Funções globais auxiliares que precisam estar disponíveis imediatamente
        function escapeHtml(text) {
            if (!text) return "";
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }
    </script>



    <!-- EMAIL JS SDK -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
    <script type="text/javascript">
        (function () {
            // Inicialização do EmailJS
            emailjs.init({
                publicKey: "R3g1RYJL5OzVQi7vD",
                blockHeadless: false,
                limitRate: {
                    id: 'app',
                    throttle: 10000 // 10 segundos
                }
            });

            // VARIÁVEIS GLOBAIS DE WORKSPACE - ADICIONADO PARA COLABORAÇÃO
            window.currentWorkspaceOwnerId = null;
            window.currentWorkspaceName = "Meu Workspace";
            window.availableWorkspaces = [];
        })();
    </script>
    <script src="cnpj-service.js"></script>

</head>
<style>
    /* ========== VARIÁVEIS CSS ========== */
    :root {
        --primary: #6750a4;
        --primary-variant: #7b61ff;
        --secondary: #625b71;
        --tertiary: #7d5260;
        --error: #ba1a1a;
        --success: #0d904f;
        --warning: #ff9800;
        --info: #2196f3;

        --surface: #fef7ff;
        --surface-variant: #e7e0ec;
        --background: #fef7ff;

        --on-primary: #ffffff;
        --on-secondary: #ffffff;
        --on-surface: #1c1b1f;
        --on-surface-variant: #49454f;
        --on-error: #ffffff;
        --on-success: #ffffff;

        --outline: #79747e;
        --outline-variant: #c4c7c5;

        --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.12);
        --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.1);
        --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.1);

        --radius-sm: 4px;
        --radius-md: 8px;
        --radius-lg: 12px;
        --radius-xl: 16px;
        --radius-full: 999px;

        --font-family: 'Outfit', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
        --transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* ========== RESET & BASE ========== */
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        -webkit-tap-highlight-color: transparent;
        max-width: 100vw;
    }

    html,
    body {
        width: 100%;
        height: 100%;
        overflow-x: hidden;
        position: relative;
    }

    body {
        font-family: var(--font-family);
        font-size: 16px;
        line-height: 1.5;
        color: var(--on-surface);
        background: var(--background);
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        text-rendering: optimizeLegibility;
        max-width: 100vw;
        overflow-x: hidden;
    }

    /* ========== UTILITIES ========== */
    .hidden {
        display: none !important;
    }

    .fade-in {
        animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }

    .loading-spinner {
        animation: spin 1s linear infinite;
    }

    /* ========== SCROLLBAR ========== */
    ::-webkit-scrollbar {
        width: 6px;
        height: 6px;
    }

    ::-webkit-scrollbar-track {
        background: var(--surface-variant);
        border-radius: var(--radius-full);
    }

    ::-webkit-scrollbar-thumb {
        background: var(--outline);
        border-radius: var(--radius-full);
    }

    ::-webkit-scrollbar-thumb:hover {
        background: var(--outline-variant);
    }

    /* ========== AUTH SCREEN ========== */
    #auth-screen {
        width: 100vw;
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 20px;
        position: relative;
        overflow: hidden;
    }

    .auth-background {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(135deg, var(--primary) 0%, var(--primary-variant) 100%);
        z-index: 1;
    }

    .auth-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.3);
        z-index: 2;
    }

    .auth-box {
        width: 100%;
        max-width: 400px;
        background: var(--surface);
        border-radius: var(--radius-xl);
        padding: 32px;
        box-shadow: var(--shadow-lg);
        position: relative;
        z-index: 3;
        margin: 0;
        overflow: hidden;
    }

    .logo-container {
        text-align: center;
        margin-bottom: 32px;
    }

    .logo {
        width: 64px;
        height: 64px;
        background: linear-gradient(135deg, var(--primary), var(--primary-variant));
        border-radius: var(--radius-lg);
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 16px;
    }

    .logo-icon {
        color: var(--on-primary);
        width: 32px;
        height: 32px;
    }

    .brand-name {
        font-size: 24px;
        font-weight: 700;
        color: var(--on-surface);
        margin-bottom: 4px;
    }

    .brand-subtitle {
        font-size: 14px;
        color: var(--on-surface-variant);
        font-weight: 400;
    }

    /* ========== FORM ELEMENTS ========== */
    #auth-form {
        display: flex;
        flex-direction: column;
        gap: 20px;
    }

    .input-group {
        display: flex;
        flex-direction: column;
        gap: 6px;
    }

    .input-group label {
        font-size: 14px;
        font-weight: 500;
        color: var(--on-surface);
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .std-input {
        width: 100%;
        padding: 14px 16px;
        border: 1px solid var(--outline-variant);
        border-radius: var(--radius-lg);
        font-family: var(--font-family);
        font-size: 16px;
        color: var(--on-surface);
        background: var(--surface);
        transition: var(--transition);
        -webkit-appearance: none;
        appearance: none;
    }

    .std-input:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(103, 80, 164, 0.1);
    }

    .std-input::placeholder {
        color: var(--outline);
    }

    .std-input[readonly] {
        background-color: #f8f9fa;
        border-color: #e9ecef;
        cursor: not-allowed;
    }

    .std-input.auto-filled {
        background-color: #e8f5e8;
        border-color: #28a745;
    }

    select.std-input {
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%2349454f' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 16px center;
        background-size: 16px;
        padding-right: 48px;
    }

    /* ========== BUTTONS ========== */
    .btn-main {
        width: 100%;
        padding: 16px 24px;
        background: linear-gradient(135deg, var(--primary), var(--primary-variant));
        color: var(--on-primary);
        border: none;
        border-radius: var(--radius-xl);
        font-family: var(--font-family);
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: var(--transition);
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        min-height: 56px;
    }

    .btn-main:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
    }

    .btn-main:active {
        transform: translateY(0);
    }

    .btn-main:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    .btn-link {
        background: transparent;
        border: none;
        color: var(--primary);
        font-family: var(--font-family);
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 8px;
        border-radius: var(--radius-md);
        transition: var(--transition);
    }

    .btn-link:hover {
        background: rgba(103, 80, 164, 0.1);
    }

    .btn-cancel {
        padding: 12px 24px;
        border: 1px solid var(--outline-variant);
        background: var(--surface);
        color: var(--on-surface);
        border-radius: var(--radius-lg);
        font-family: var(--font-family);
        font-size: 16px;
        font-weight: 500;
        cursor: pointer;
        transition: var(--transition);
        min-width: 120px;
    }

    .btn-cancel:hover {
        background: var(--surface-variant);
    }

    .btn-danger {
        padding: 12px 24px;
        border: none;
        background: var(--error);
        color: var(--on-error);
        border-radius: var(--radius-lg);
        font-family: var(--font-family);
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: var(--transition);
        min-width: 120px;
    }

    .btn-danger:hover {
        background: #a01818;
    }

    /* ========== APP LAYOUT ========== */
    #app-screen {
        width: 100vw;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    .content-area {
        flex: 1;
        padding: 16px;
        overflow-y: auto;
        width: 100%;
        max-width: 100vw;
        transition: opacity 0.3s ease;
    }

    .content-area.hidden {
        display: none;
        opacity: 0;
    }

    .section-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 20px;
        flex-wrap: wrap;
        gap: 12px;
    }

    .section-title {
        font-size: 20px;
        font-weight: 700;
        color: var(--on-surface);
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .counter-badge {
        background: var(--primary);
        color: var(--on-primary);
        font-size: 12px;
        font-weight: 600;
        padding: 2px 8px;
        border-radius: var(--radius-full);
    }

    /* ========== HEADER ========== */
    .app-header {
        width: 100%;
        background: var(--surface);
        border-bottom: 1px solid var(--outline-variant);
        padding: 0;
        position: sticky;
        top: 0;
        z-index: 1000;
        display: flex;
        flex-direction: column;
        box-shadow: var(--shadow-sm);
    }

    .app-header.scrolled {
        box-shadow: var(--shadow-md);
    }

    /* Header Top */
    .header-top {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px 16px;
        gap: 16px;
    }

    .header-brand {
        display: flex;
        align-items: center;
        gap: 12px;
        flex: 1;
        min-width: 0;
    }

    .brand-icon {
        width: 40px;
        height: 40px;
        border-radius: var(--radius-md);
        background: linear-gradient(135deg, var(--primary), var(--primary-variant));
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }

    .brand-icon i {
        color: var(--on-primary);
        width: 20px;
        height: 20px;
    }

    .brand-info {
        display: flex;
        flex-direction: column;
        min-width: 0;
    }

    /* Header Actions */
    .header-actions {
        display: flex;
        align-items: center;
        gap: 8px;
        flex-shrink: 0;
    }

    .notification-wrapper {
        position: relative;
    }

    .notification-badge {
        position: absolute;
        top: -4px;
        right: -4px;
        width: 8px;
        height: 8px;
        background: var(--error);
        border-radius: 50%;
        border: 2px solid var(--surface);
        animation: pulse 2s infinite;
    }

    @keyframes pulse {

        0%,
        100% {
            opacity: 1;
        }

        50% {
            opacity: 0.5;
        }
    }

    /* User Profile */
    .user-profile {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 6px 12px;
        border-radius: var(--radius-full);
        background: var(--surface-variant);
        border: none;
        cursor: pointer;
        transition: var(--transition);
    }

    .user-profile:hover {
        background: var(--outline-variant);
    }

    .user-avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: linear-gradient(135deg, var(--primary), var(--primary-variant));
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--on-primary);
        font-weight: 600;
        font-size: 14px;
        flex-shrink: 0;
    }

    .user-name {
        font-size: 14px;
        font-weight: 500;
        color: var(--on-surface);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 100px;
    }

    /* Navigation */
    .header-nav {
        width: 100%;
        border-top: 1px solid var(--outline-variant);
        background: var(--surface);
    }

    .nav-container {
        display: flex;
        overflow-x: auto;
        scrollbar-width: none;
        -ms-overflow-style: none;
        padding: 0 16px;
        gap: 2px;
    }

    .nav-container::-webkit-scrollbar {
        display: none;
    }

    .nav-item {
        flex: 0 0 auto;
        padding: 14px 16px;
        background: transparent;
        border: none;
        border-bottom: 2px solid transparent;
        font-family: var(--font-family);
        font-size: 14px;
        font-weight: 500;
        color: var(--on-surface-variant);
        cursor: pointer;
        transition: var(--transition);
        display: flex;
        align-items: center;
        gap: 8px;
        white-space: nowrap;
        position: relative;
    }

    .nav-item:hover {
        color: var(--primary);
        background: rgba(103, 80, 164, 0.05);
    }

    .nav-item.active {
        color: var(--primary);
        border-bottom-color: var(--primary);
        font-weight: 600;
    }

    .nav-item i {
        width: 16px;
        height: 16px;
    }

    /* User Dropdown */
    .user-dropdown {
        position: absolute;
        top: calc(100% + 8px);
        right: 16px;
        background: var(--surface);
        border: 1px solid var(--outline-variant);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-lg);
        min-width: 200px;
        z-index: 1001;
        display: none;
        opacity: 0;
        transform: translateY(-10px);
        transition: opacity 0.2s, transform 0.2s;
    }

    .user-dropdown.show {
        display: block;
        opacity: 1;
        transform: translateY(0);
    }

    .dropdown-header {
        padding: 16px;
        border-bottom: 1px solid var(--outline-variant);
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .dropdown-header .user-avatar {
        width: 40px;
        height: 40px;
        font-size: 16px;
    }

    .dropdown-user-info {
        flex: 1;
        min-width: 0;
    }

    .dropdown-user-info .user-name {
        font-size: 14px;
        font-weight: 600;
        max-width: none;
    }

    .dropdown-user-email {
        font-size: 12px;
        color: var(--on-surface-variant);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .dropdown-menu {
        padding: 8px 0;
    }

    .dropdown-item {
        width: 100%;
        padding: 12px 16px;
        border: none;
        background: transparent;
        text-align: left;
        font-family: var(--font-family);
        font-size: 14px;
        color: var(--on-surface);
        cursor: pointer;
        transition: var(--transition);
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .dropdown-item:hover {
        background: var(--surface-variant);
    }

    .dropdown-item.logout {
        color: var(--error);
    }

    .dropdown-item.logout:hover {
        background: rgba(186, 26, 26, 0.1);
    }

    /* Status Bar */
    .header-status {
        padding: 8px 16px;
        background: var(--surface-variant);
        border-top: 1px solid var(--outline-variant);
        display: none;
    }

    .status-items {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 16px;
        flex-wrap: wrap;
    }

    .status-item {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 13px;
        color: var(--on-surface-variant);
    }

    .status-value {
        font-weight: 600;
        color: var(--on-surface);
    }

    /* ========== METRICS GRID ========== */
    .metrics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 12px;
        margin-bottom: 24px;
    }



    .metric-card {
        background: var(--surface);
        border: 1px solid var(--outline-variant);
        border-radius: var(--radius-lg);
        padding: 16px;
        display: flex;
        align-items: center;
        gap: 12px;
        cursor: pointer;
        transition: var(--transition);
        min-width: 0;
    }

    .metric-card:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
        border-color: var(--primary);
    }

    .metric-card.active {
        border-color: var(--primary);
        background: rgba(103, 80, 164, 0.05);
    }

    .metric-icon {
        width: 48px;
        height: 48px;
        border-radius: var(--radius-lg);
        background: rgba(103, 80, 164, 0.1);
        color: var(--primary);
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }

    .metric-content {
        flex: 1;
        min-width: 0;
    }

    .metric-value {
        font-size: 24px;
        font-weight: 800;
        color: var(--on-surface);
        line-height: 1.2;
    }

    .metric-label {
        font-size: 12px;
        color: var(--on-surface-variant);
        font-weight: 500;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    /* ========== CARDS ========== */
    .card {
        background: var(--surface);
        border: 1px solid var(--outline-variant);
        border-radius: var(--radius-lg);
        padding: 16px;
        display: flex;
        align-items: flex-start;
        gap: 12px;
        transition: var(--transition);
        position: relative;
        width: 100%;
        max-width: 100%;
        overflow: hidden;
        animation: fadeInUp 0.3s ease;
    }

    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .card:hover {
        border-color: var(--primary);
        box-shadow: var(--shadow-sm);
    }

    .card.urgent {
        border-left: 4px solid var(--error);
    }

    .card.highlighted {
        animation: pulseHighlight 2s;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(103, 80, 164, 0.2);
    }

    @keyframes pulseHighlight {

        0%,
        100% {
            box-shadow: 0 0 0 3px rgba(103, 80, 164, 0.2);
        }

        50% {
            box-shadow: 0 0 0 6px rgba(103, 80, 164, 0.1);
        }
    }

    .card.completed-card {
        opacity: 0.7;
        background: var(--surface-variant);
    }

    .card-content {
        flex: 1;
        min-width: 0;
    }

    .card-header-row {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 8px;
        flex-wrap: wrap;
        gap: 8px;
    }

    .card-company {
        font-size: 12px;
        color: var(--on-surface-variant);
        display: flex;
        align-items: center;
        gap: 4px;
        font-weight: 500;
    }

    .deadline-badge {
        font-size: 11px;
        font-weight: 600;
        padding: 4px 8px;
        border-radius: var(--radius-full);
        display: inline-flex;
        align-items: center;
        gap: 4px;
        white-space: nowrap;
    }

    .deadline-badge.urgent {
        background: rgba(186, 26, 26, 0.1);
        color: var(--error);
    }

    .deadline-badge.normal {
        background: rgba(33, 150, 243, 0.1);
        color: var(--info);
    }

    .card-title {
        font-size: 16px;
        font-weight: 600;
        color: var(--on-surface);
        margin-bottom: 6px;
        word-break: break-word;
    }

    .card-desc {
        font-size: 14px;
        color: var(--on-surface-variant);
        line-height: 1.4;
        word-break: break-word;
    }

    .card-actions {
        display: flex;
        gap: 8px;
        flex-shrink: 0;
    }

    .check-btn,
    .delete-btn {
        width: 40px;
        height: 40px;
        border-radius: var(--radius-full);
        border: none;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: var(--transition);
        flex-shrink: 0;
    }

    .check-btn {
        background: rgba(13, 144, 79, 0.1);
        color: var(--success);
    }

    .check-btn:hover {
        background: rgba(13, 144, 79, 0.2);
    }

    .delete-btn {
        background: rgba(186, 26, 26, 0.1);
        color: var(--error);
    }

    .delete-btn:hover {
        background: rgba(186, 26, 26, 0.2);
    }

    /* ========== TASK LIST ========== */
    .task-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
        width: 100%;
    }

    .task-list>div:not(.card) {
        width: 100%;
        text-align: center;
        padding: 40px 20px;
    }

    /* ========== COMPANY GRID ========== */
    .company-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 16px;
        width: 100%;
    }

    .company-card {
        background: var(--surface);
        border: 1px solid var(--outline-variant);
        border-radius: var(--radius-lg);
        padding: 20px;
        transition: var(--transition);
        position: relative;
        overflow: hidden;
    }

    .company-card:hover {
        border-color: var(--primary);
        box-shadow: var(--shadow-sm);
    }

    .company-card h4 {
        font-size: 18px;
        font-weight: 700;
        color: var(--on-surface);
        margin-bottom: 12px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
        word-break: break-word;
    }

    .company-badge {
        font-size: 11px;
        font-weight: 700;
        padding: 4px 10px;
        border-radius: var(--radius-full);
        white-space: nowrap;
    }

    .badge-simples {
        background: rgba(13, 144, 79, 0.1);
        color: var(--success);
    }

    .badge-presumido {
        background: rgba(33, 150, 243, 0.1);
        color: var(--info);
    }

    .badge-real {
        background: rgba(103, 80, 164, 0.1);
        color: var(--primary);
    }

    .badge-mei {
        background: rgba(255, 152, 0, 0.1);
        color: var(--warning);
    }

    .badge-ltda {
        background: rgba(125, 82, 96, 0.1);
        color: var(--tertiary);
    }

    .company-card p {
        font-size: 14px;
        color: var(--on-surface-variant);
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 6px;
        word-break: break-word;
    }

    .company-actions {
        display: flex;
        gap: 8px;
        margin-top: 16px;
        justify-content: flex-end;
    }

    /* ========== COMPANY FILTER ========== */
    .company-filter-container {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .company-filter-label {
        font-size: 14px;
        font-weight: 500;
        color: var(--on-surface);
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .company-filter-select {
        width: 100%;
        padding: 12px 16px;
        border: 1px solid var(--outline-variant);
        border-radius: var(--radius-lg);
        font-family: var(--font-family);
        font-size: 16px;
        color: var(--on-surface);
        background: var(--surface);
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%2349454f' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 16px center;
        background-size: 16px;
        padding-right: 48px;
    }

    .company-filter-clear {
        background: transparent;
        border: none;
        color: var(--error);
        font-family: var(--font-family);
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 8px;
        border-radius: var(--radius-md);
        transition: var(--transition);
        align-self: flex-start;
    }

    .company-filter-clear:hover {
        background: rgba(186, 26, 26, 0.1);
    }

    #kpi-revenue {
        display: none;
    }

    /* ========== COMPANY TASKS SECTION ========== */
    .company-tasks-section {
        margin-top: 32px;
        width: 100%;
    }

    .company-tasks-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 16px;
        flex-wrap: wrap;
        gap: 12px;
    }

    .company-tasks-title {
        font-size: 18px;
        font-weight: 700;
        color: var(--on-surface);
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .company-tasks-count {
        font-size: 14px;
        font-weight: 500;
        color: var(--on-surface-variant);
        background: var(--surface-variant);
        padding: 2px 10px;
        border-radius: var(--radius-full);
    }

    .company-tasks-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .company-task-item {
        background: var(--surface);
        border: 1px solid var(--outline-variant);
        border-radius: var(--radius-lg);
        padding: 16px;
        display: flex;
        align-items: center;
        gap: 16px;
        transition: var(--transition);
        width: 100%;
    }

    .company-task-item.completed {
        opacity: 0.7;
        background: var(--surface-variant);
    }

    .company-task-content {
        flex: 1;
        min-width: 0;
    }

    .company-task-title {
        font-size: 16px;
        font-weight: 600;
        color: var(--on-surface);
        margin-bottom: 8px;
        word-break: break-word;
    }

    .company-task-info {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        align-items: center;
    }

    .company-task-status {
        font-size: 12px;
        font-weight: 600;
        padding: 4px 10px;
        border-radius: var(--radius-full);
        display: inline-flex;
        align-items: center;
        gap: 4px;
    }

    .company-task-status.pending {
        background: rgba(255, 152, 0, 0.1);
        color: var(--warning);
    }

    .company-task-status.completed {
        background: rgba(13, 144, 79, 0.1);
        color: var(--success);
    }

    .company-task-deadline {
        font-size: 12px;
        color: var(--on-surface-variant);
        display: flex;
        align-items: center;
        gap: 4px;
    }

    .company-task-actions {
        display: flex;
        gap: 8px;
        flex-shrink: 0;
    }

    .company-task-action-btn {
        padding: 8px 16px;
        border: 1px solid var(--outline-variant);
        background: var(--surface);
        color: var(--on-surface);
        border-radius: var(--radius-lg);
        font-family: var(--font-family);
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: var(--transition);
        display: flex;
        align-items: center;
        gap: 6px;
        white-space: nowrap;
    }

    .company-task-action-btn:hover {
        background: var(--surface-variant);
    }

    .company-task-action-btn.view {
        border-color: var(--primary);
        color: var(--primary);
        background: rgba(103, 80, 164, 0.1);
    }

    /* ========== NOTES ========== */
    .notes-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 16px;
        width: 100%;
    }

    .note-card {
        background: var(--surface);
        border: 1px solid var(--outline-variant);
        border-radius: var(--radius-lg);
        padding: 20px;
        transition: var(--transition);
        cursor: pointer;
        min-height: 140px;
        display: flex;
        flex-direction: column;
    }

    .note-card:hover {
        border-color: var(--primary);
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
    }

    .empty-state {
        text-align: center;
        padding: 48px 24px;
        color: var(--on-surface-variant);
    }

    .empty-state p {
        margin: 16px 0;
        font-size: 16px;
    }

    /* ========== DASHBOARD ========== */
    .dashboard-split {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
        gap: 20px;
        width: 100%;
    }

    .glass-panel {
        background: var(--surface);
        border: 1px solid var(--outline-variant);
        border-radius: var(--radius-lg);
        padding: 20px;
        box-shadow: var(--shadow-sm);
        width: 100%;
    }

    .chart-wrapper {
        position: relative;
        width: 100%;
        height: 220px;
    }

    /* ========== FLOATING ACTION BUTTON ========== */
    .fab {
        position: fixed;
        bottom: 24px;
        right: 24px;
        width: 56px;
        height: 56px;
        border-radius: var(--radius-full);
        background: linear-gradient(135deg, var(--primary), var(--primary-variant));
        color: var(--on-primary);
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: var(--shadow-lg);
        transition: var(--transition);
        z-index: 1000;
    }

    .fab:hover {
        transform: scale(1.1);
        box-shadow: var(--shadow-md);
    }

    /* ========== MODALS ========== */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 16px;
        z-index: 1000;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
    }

    .modal {
        width: 100%;
        max-width: 600px;
        max-height: 90vh;
        background: var(--surface);
        border-radius: var(--radius-xl);
        overflow: hidden;
        display: flex;
        flex-direction: column;
        box-shadow: var(--shadow-lg);
        animation: modalSlideUp 0.3s ease;
    }

    @keyframes modalSlideUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .modal-header {
        padding: 24px 24px 16px;
        border-bottom: 1px solid var(--outline-variant);
        display: flex;
        align-items: center;
        justify-content: space-between;
        flex-shrink: 0;
    }

    .modal-header h3 {
        font-size: 20px;
        font-weight: 700;
        color: var(--on-surface);
    }

    .modal-header button {
        width: 40px;
        height: 40px;
        border-radius: var(--radius-full);
        border: none;
        background: var(--surface-variant);
        color: var(--on-surface);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: var(--transition);
    }

    .modal-header button:hover {
        background: var(--outline-variant);
    }

    .modal-body {
        padding: 24px;
        overflow-y: auto;
        flex: 1;
        -webkit-overflow-scrolling: touch;
    }

    .modal-footer {
        padding: 16px 24px;
        border-top: 1px solid var(--outline-variant);
        display: flex;
        align-items: center;
        justify-content: flex-end;
        gap: 12px;
        flex-shrink: 0;
        flex-wrap: wrap;
    }

    /* Delete Confirmation Modal */
    .delete-confirm-icon {
        width: 64px;
        height: 64px;
        border-radius: var(--radius-full);
        background: rgba(186, 26, 26, 0.1);
        color: var(--error);
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 20px;
    }

    .delete-confirm-title {
        font-size: 20px;
        font-weight: 700;
        color: var(--on-surface);
        text-align: center;
        margin-bottom: 8px;
    }

    .delete-confirm-message {
        font-size: 16px;
        color: var(--on-surface-variant);
        text-align: center;
        margin-bottom: 24px;
        line-height: 1.4;
    }

    .delete-confirm-actions {
        display: flex;
        gap: 12px;
        justify-content: center;
        flex-wrap: wrap;
    }

    /* Note Section */
    .note-section {
        margin-bottom: 20px;
        width: 100%;
    }

    .note-section-title {
        font-size: 16px;
        font-weight: 600;
        color: var(--on-surface);
        margin-bottom: 12px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .note-section-content {
        background: var(--surface-variant);
        border-radius: var(--radius-lg);
        padding: 16px;
    }

    .note-section-content p {
        margin-bottom: 8px;
        line-height: 1.5;
        word-break: break-word;
    }

    .note-section-content strong {
        color: var(--on-surface);
        font-weight: 600;
    }

    /* ========== PINS/ETIQUETAS ========== */
    .colors-grid {
        display: grid;
        grid-template-columns: repeat(6, 1fr);
        gap: 8px;
    }

    .color-option {
        width: 100%;
        aspect-ratio: 1;
        border-radius: var(--radius-full);
        cursor: pointer;
        transition: var(--transition);
        border: 2px solid transparent;
    }

    .color-option:hover {
        transform: scale(1.1);
    }

    .color-option.selected {
        border-color: var(--on-surface);
        box-shadow: var(--shadow-sm);
    }

    .pins-list {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .pin-item {
        background: var(--surface);
        border: 1px solid var(--outline-variant);
        border-left: 4px solid;
        border-radius: var(--radius-lg);
        padding: 12px;
        display: flex;
        align-items: center;
        gap: 12px;
        transition: var(--transition);
    }

    .pin-color-dot {
        width: 12px;
        height: 12px;
        border-radius: var(--radius-full);
        flex-shrink: 0;
    }

    .pin-content {
        flex: 1;
        min-width: 0;
    }

    .pin-title {
        font-size: 14px;
        font-weight: 600;
        color: var(--on-surface);
        margin-bottom: 4px;
        word-break: break-word;
    }

    .pin-comment {
        font-size: 12px;
        color: var(--on-surface-variant);
        line-height: 1.4;
        word-break: break-word;
    }

    .pin-date {
        font-size: 11px;
        color: var(--outline);
        margin-top: 4px;
    }

    /* Pins on Cards */
    .card-pins {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        display: flex;
        gap: 2px;
        padding: 8px;
        pointer-events: none;
        z-index: 1;
        flex-wrap: wrap;
        max-width: 100%;
        overflow: hidden;
    }

    .card,
    .company-card,
    .note-card {
        position: relative;
        overflow: visible;
    }

    .card-content,
    .company-card>*:not(.card-pins) {
        position: relative;
        z-index: 0;
    }

    .pin-badge {
        width: 30px;
        height: 20px;
        top: -8px;
        border-radius: 0 0 2px 2px;
        cursor: pointer;
        pointer-events: auto;
        transition: all 0.2s ease;
        flex-shrink: 0;
        position: relative;
    }

    .pin-badge:hover {
        transform: scale(1.3);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    .pin-badge:hover::after {
        content: attr(data-title);
        position: absolute;
        top: -30px;
        left: 50%;
        transform: translateX(-50%);
        background: var(--on-surface);
        color: var(--surface);
        padding: 4px 8px;
        border-radius: var(--radius-sm);
        font-size: 11px;
        font-weight: 500;
        white-space: nowrap;
        z-index: 100;
        box-shadow: var(--shadow-sm);
    }

    /* Pin Tooltips */
    .pin-tooltip {
        position: fixed !important;
        background: white !important;
        border: 1px solid var(--outline-variant) !important;
        border-radius: var(--radius-md) !important;
        padding: 12px !important;
        box-shadow: var(--shadow-lg) !important;
        z-index: 9999 !important;
        max-width: 280px !important;
        min-width: 200px !important;
        font-size: 13px !important;
        line-height: 1.4 !important;
        animation: fadeIn 0.15s ease !important;
        pointer-events: none !important;
    }

    .pin-tooltip::before {
        content: '';
        position: absolute;
        bottom: -8px;
        left: 50%;
        transform: translateX(-50%);
        width: 0;
        height: 0;
        border-left: 8px solid transparent;
        border-right: 8px solid transparent;
        border-top: 8px solid white;
        filter: drop-shadow(0 2px 1px rgba(0, 0, 0, 0.1));
    }

    .pin-tooltip::after {
        content: '';
        position: absolute;
        bottom: -9px;
        left: 50%;
        transform: translateX(-50%);
        width: 0;
        height: 0;
        border-left: 9px solid transparent;
        border-right: 9px solid transparent;
        border-top: 9px solid var(--outline-variant);
        z-index: -1;
    }

    /* ========== TOAST NOTIFICATIONS ========== */
    #toast-container {
        position: fixed;
        top: 24px;
        right: 24px;
        z-index: 10000;
        display: flex;
        flex-direction: column;
        gap: 12px;
        max-width: calc(100vw - 48px);
    }

    .toast {
        padding: 14px 20px;
        border-radius: var(--radius-lg);
        font-size: 14px;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 8px;
        animation: toastSlideIn 0.3s ease;
        max-width: 400px;
        word-break: break-word;
    }

    @keyframes toastSlideIn {
        from {
            opacity: 0;
            transform: translateX(100%);
        }

        to {
            opacity: 1;
            transform: translateX(0);
        }
    }

    .toast.success {
        background: rgba(13, 144, 79, 0.1);
        color: var(--success);
        border: 1px solid rgba(13, 144, 79, 0.2);
    }

    .toast.warning {
        background: rgba(255, 152, 0, 0.1);
        color: var(--warning);
        border: 1px solid rgba(255, 152, 0, 0.2);
    }

    .toast.error {
        background: rgba(186, 26, 26, 0.1);
        color: var(--error);
        border: 1px solid rgba(186, 26, 26, 0.2);
    }

    /* ========== EFFECTS ========== */
    .pressing {
        animation: pressEffect 2s ease;
        background: var(--surface-variant) !important;
    }

    @keyframes pressEffect {

        0%,
        100% {
            background: var(--surface);
        }

        50% {
            background: var(--surface-variant);
        }
    }

    /* Ripple Effect */
    .ripple {
        position: relative;
        overflow: hidden;
    }

    .ripple::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 5px;
        height: 5px;
        background: rgba(255, 255, 255, 0.5);
        opacity: 0;
        border-radius: 100%;
        transform: scale(1, 1) translate(-50%, -50%);
        transform-origin: 50% 50%;
    }

    .ripple:focus:not(:active)::after {
        animation: ripple 1s ease-out;
    }

    @keyframes ripple {
        0% {
            transform: scale(0, 0);
            opacity: 0.5;
        }

        20% {
            transform: scale(25, 25);
            opacity: 0.3;
        }

        100% {
            opacity: 0;
            transform: scale(40, 40);
        }
    }

    /* ========== REPORT BUTTONS ========== */
    .report-buttons .icon-btn {
        transition: all 0.3s ease;
        padding: 8px 12px !important;
        border-radius: 8px !important;
        border: none !important;
        cursor: pointer !important;
    }

    .report-buttons .icon-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    .report-buttons .icon-btn:active {
        transform: translateY(0) !important;
    }

    .weekly-report-btn:hover {
        background: #2563eb !important;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
    }

    .monthly-report-btn:hover {
        background: #7c3aed !important;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(124, 58, 237, 0.3);
    }

    /* ========== RESPONSIVE DESIGN ========== */
    @media (max-width: 1024px) {
        .user-name {
            display: none;
        }

        .user-profile {
            padding: 6px;
        }

        .nav-item {
            padding: 12px 14px;
            font-size: 13px;
        }
    }

    @media (max-width: 768px) {
        :root {
            --radius-lg: 12px;
            --radius-xl: 16px;
        }

        body {
            font-size: 15px;
        }

        .header-top {
            padding: 10px 12px;
            gap: 12px;
        }

        .brand-icon {
            width: 36px;
            height: 36px;
        }

        .brand-name {
            font-size: 15px;
        }

        .brand-subtitle {
            font-size: 11px;
        }

        .nav-container {
            padding: 0 12px;
        }

        .nav-item {
            padding: 12px 10px;
            font-size: 12px;
            gap: 6px;
        }

        .nav-item i {
            width: 14px;
            height: 14px;
        }

        .user-profile {
            min-width: 40px;
            justify-content: center;
        }

        .user-dropdown {
            right: 12px;
            min-width: 180px;
        }

        .auth-box {
            padding: 24px;
            margin: 0;
            border-radius: var(--radius-lg);
        }

        .metrics-grid {
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }

        .metric-card {
            padding: 12px;
            flex-direction: column;
            text-align: center;
            gap: 8px;
        }

        .metric-icon {
            width: 40px;
            height: 40px;
        }

        .metric-value {
            font-size: 20px;
        }

        .metric-label {
            font-size: 11px;
        }

        .company-grid,
        .notes-grid {
            grid-template-columns: 1fr;
            gap: 12px;
        }

        .dashboard-split {
            grid-template-columns: 1fr;
            gap: 16px;
        }

        .fab {
            width: 56px;
            height: 56px;
            bottom: 16px;
            right: 16px;
        }

        .modal {
            max-height: 85vh;
            margin: 0;
            border-radius: var(--radius-lg);
        }

        .modal-header {
            padding: 20px 16px 12px;
        }

        .modal-body {
            padding: 16px;
        }

        .modal-footer {
            padding: 12px 16px;
        }

        .colors-grid {
            grid-template-columns: repeat(4, 1fr);
        }

        .section-title {
            font-size: 18px;
        }

        .card-title {
            font-size: 15px;
        }

        .card-desc {
            font-size: 13px;
        }

        .company-card h4 {
            font-size: 16px;
        }

        .company-card p {
            font-size: 13px;
        }

        .btn-main {
            padding: 14px 20px;
            min-height: 52px;
        }

        .std-input {
            padding: 12px 14px;
            font-size: 15px;
        }

        input[type="date"],
        input[type="month"],
        input[type="datetime-local"] {
            min-height: 48px;
        }

        /* Prevent zoom on iOS */
        input,
        select,
        textarea {
            font-size: 16px !important;
        }

        /* iOS specific adjustments */
        @supports (-webkit-touch-callout: none) {
            .modal-overlay {
                height: -webkit-fill-available;
            }

            #auth-screen {
                min-height: -webkit-fill-available;
            }

            .fab {
                bottom: max(16px, env(safe-area-inset-bottom));
            }
        }
    }

    @media (max-width: 480px) {
        .header-brand {
            gap: 8px;
        }

        .brand-icon {
            width: 32px;
            height: 32px;
        }

        .brand-icon i {
            width: 16px;
            height: 16px;
        }

        .brand-name {
            font-size: 14px;
        }

        .nav-item span:not(.icon) {
            display: none;
        }

        .nav-item {
            padding: 12px 16px;
            justify-content: center;
        }

        .nav-item i {
            width: 18px;
            height: 18px;
        }

        .user-dropdown {
            right: 8px;
            min-width: 160px;
        }

        .auth-box {
            padding: 20px;
        }

        .metrics-grid {
            grid-template-columns: 1fr;
        }

        .nav-tab {
            padding: 8px 12px;
            font-size: 13px;
        }

        .modal-header h3 {
            font-size: 18px;
        }

        .btn-main,
        .btn-cancel,
        .btn-danger {
            padding: 12px 16px;
            font-size: 15px;
        }

        .company-task-action-btn {
            padding: 6px 12px;
            font-size: 13px;
        }

        .delete-confirm-actions {
            flex-direction: column;
            width: 100%;
        }

        .btn-cancel,
        .btn-danger {
            width: 100%;
        }
    }

    @media (max-width: 360px) {
        .auth-box {
            padding: 20px;
        }

        .metrics-grid {
            grid-template-columns: 1fr;
        }

        .nav-tab {
            padding: 8px 12px;
            font-size: 13px;
        }

        .modal-header h3 {
            font-size: 18px;
        }

        .btn-main,
        .btn-cancel,
        .btn-danger {
            padding: 12px 16px;
            font-size: 15px;
        }

        .company-task-action-btn {
            padding: 6px 12px;
            font-size: 13px;
        }

        .delete-confirm-actions {
            flex-direction: column;
            width: 100%;
        }

        .btn-cancel,
        .btn-danger {
            width: 100%;
        }
    }

    @media (max-height: 500px) and (orientation: landscape) {
        .auth-box {
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal {
            max-height: 95vh;
        }

        .modal-body {
            max-height: 60vh;
        }
    }

    /* ========== SAFE AREA INSETS ========== */
    @supports (padding: max(0px)) {

        body,
        .app-header,
        .fab {
            padding-left: max(0px, env(safe-area-inset-left));
            padding-right: max(0px, env(safe-area-inset-right));
        }

        .fab {
            margin-bottom: env(safe-area-inset-bottom);
        }

        #auth-screen {
            padding-left: max(20px, env(safe-area-inset-left));
            padding-right: max(20px, env(safe-area-inset-right));
        }
    }

    /* ========== COMPANY MODAL SPECIFIC ========== */
    #modal-company .modal {
        max-height: 85vh;
    }

    #modal-company .modal-body {
        display: flex;
        flex-direction: column;
        gap: 16px;
        max-height: 60vh;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
        padding-right: 8px;
        padding-top: 8px;
    }

    #modal-company .modal-body::-webkit-scrollbar {
        width: 6px;
    }

    #modal-company .modal-body::-webkit-scrollbar-track {
        background: var(--surface-variant);
        border-radius: var(--radius-full);
        margin: 4px 0;
    }

    #modal-company .modal-body::-webkit-scrollbar-thumb {
        background: var(--outline);
        border-radius: var(--radius-full);
    }

    #modal-company .modal-body::-webkit-scrollbar-thumb:hover {
        background: var(--outline-variant);
    }

    #modal-company .input-group {
        min-width: 0;
    }

    #modal-company .std-input {
        width: 100%;
    }

    #modal-company textarea.std-input {
        min-height: 80px;
        resize: vertical;
    }

    #modal-company .input-group:not(:last-child) {
        margin-bottom: 4px;
    }

    #modal-company .std-input:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 2px rgba(103, 80, 164, 0.2);
    }

    #modal-company .modal-footer {
        flex-shrink: 0;
        background: var(--surface);
        border-top: 1px solid var(--outline-variant);
    }

    #modal-company .modal-footer button {
        flex: 1;
        min-width: 120px;
    }

    @media (max-width: 768px) {
        #modal-company .modal {
            max-height: 90vh;
            margin: 0;
        }

        #modal-company .modal-body {
            max-height: 65vh;
            gap: 12px;
        }

        #modal-company .input-group label {
            font-size: 13px;
        }

        #modal-company .std-input {
            font-size: 14px;
            padding: 12px;
        }
    }

    @media (max-height: 600px) {
        #modal-company .modal {
            max-height: 95vh;
        }

        #modal-company .modal-body {
            max-height: 70vh;
        }
    }

    @media (max-width: 480px) {
        #modal-company .modal-footer {
            flex-direction: column;
            gap: 8px;
        }

        #modal-company .modal-footer button {
            width: 100%;
        }
    }

    /* ========== API INFO TOOLTIP ========== */
    .api-info-tooltip {
        position: relative;
        display: inline-block;
    }

    .api-info-tooltip .tooltip-text {
        visibility: hidden;
        width: 200px;
        background-color: #555;
        color: #fff;
        text-align: center;
        border-radius: 6px;
        padding: 5px;
        position: absolute;
        z-index: 1;
        bottom: 125%;
        left: 50%;
        margin-left: -100px;
        opacity: 0;
        transition: opacity 0.3s;
        font-size: 12px;
    }

    .api-info-tooltip:hover .tooltip-text {
        visibility: visible;
        opacity: 1;
    }

    /* ========== PADRÃO PARA TODOS OS BOTÕES DE AÇÃO ========== */

    /* BOTÃO DE EXCLUIR/LIXEIRA (SEMPRE VERMELHO) */
    button.delete-btn,
    button[onclick*="delete"],
    button[onclick*="Delete"],
    button[onclick*="excluir"],
    button[onclick*="Excluir"],
    button.btn-danger:not(.btn-main),
    button[style*="color: var(--danger)"],
    button[style*="color: #ef4444"],
    button[style*="color: #dc2626"],
    button[style*="color: red"] {
        background: rgba(239, 68, 68, 0.1) !important;
        color: #ef4444 !important;
        border: 1px solid rgba(239, 68, 68, 0.3) !important;
        border-radius: var(--radius-full) !important;
        padding: 8px !important;
        min-width: 40px !important;
        min-height: 40px !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
    }

    /* ÍCONE DE LIXEIRA NOS BOTÕES DE EXCLUIR */
    button.delete-btn i[data-lucide],
    button[onclick*="delete"] i[data-lucide],
    button[onclick*="Delete"] i[data-lucide],
    button[onclick*="excluir"] i[data-lucide],
    button[onclick*="Excluir"] i[data-lucide] {
        color: #ef4444 !important;
        width: 18px !important;
        height: 18px !important;
    }

    /* HOVER DO BOTÃO EXCLUIR */
    button.delete-btn:hover:not(:disabled),
    button[onclick*="delete"]:hover:not(:disabled),
    button[onclick*="Delete"]:hover:not(:disabled),
    button[onclick*="excluir"]:hover:not(:disabled),
    button[onclick*="Excluir"]:hover:not(:disabled) {
        background: rgba(239, 68, 68, 0.2) !important;
        border-color: #ef4444 !important;
        transform: translateY(-2px) !important;
    }

    /* ======================================================== */

    /* BOTÃO DE CANCELAR/X (SEMPRE CINZA/NEUTRO) */
    button[onclick*="closeModals"],
    button[onclick*="cancel"],
    button[onclick*="Cancel"],
    button.btn-cancel,
    button[style*="color: var(--text-sec)"],
    button[style*="color: #64748b"],
    button[style*="color: #6b7280"] {
        background: rgba(100, 116, 139, 0.1) !important;
        color: #64748b !important;
        border: 1px solid rgba(100, 116, 139, 0.3) !important;
        border-radius: var(--radius-full) !important;
        padding: 8px !important;
        min-width: 40px !important;
        min-height: 40px !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
    }

    /* ÍCONE DE X NOS BOTÕES DE CANCELAR */
    button[onclick*="closeModals"] i[data-lucide],
    button[onclick*="cancel"] i[data-lucide],
    button[onclick*="Cancel"] i[data-lucide] {
        color: #64748b !important;
        width: 18px !important;
        height: 18px !important;
    }

    /* HOVER DO BOTÃO CANCELAR */
    button[onclick*="closeModals"]:hover:not(:disabled),
    button[onclick*="cancel"]:hover:not(:disabled),
    button[onclick*="Cancel"]:hover:not(:disabled),
    button.btn-cancel:hover:not(:disabled) {
        background: rgba(100, 116, 139, 0.2) !important;
        border-color: #64748b !important;
        transform: translateY(-2px) !important;
    }

    /* ======================================================== */

    /* BOTÃO DE EDITAR/CANETINHA (SEMPRE AZUL) */
    button[onclick*="edit"],
    button[onclick*="Edit"],
    button[onclick*="editar"],
    button[onclick*="Editar"],
    button[onclick*="openTaskModal"],
    button[onclick*="openCompanyModal"],
    button[onclick*="openNoteModal"],
    button.icon-btn:not(.delete-btn):not([onclick*="delete"]):not([onclick*="closeModals"]) {
        background: rgba(59, 130, 246, 0.1) !important;
        color: #3b82f6 !important;
        border: 1px solid rgba(59, 130, 246, 0.3) !important;
        border-radius: var(--radius-full) !important;
        padding: 8px !important;
        min-width: 40px !important;
        min-height: 40px !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
    }

    /* ÍCONE DE CANETINHA NOS BOTÕES DE EDITAR */
    button[onclick*="edit"] i[data-lucide],
    button[onclick*="Edit"] i[data-lucide],
    button[onclick*="editar"] i[data-lucide],
    button[onclick*="Editar"] i[data-lucide],
    button[onclick*="openTaskModal"] i[data-lucide],
    button[onclick*="openCompanyModal"] i[data-lucide],
    button[onclick*="openNoteModal"] i[data-lucide],
    button.icon-btn:not(.delete-btn):not([onclick*="delete"]):not([onclick*="closeModals"]) i[data-lucide] {
        color: #3b82f6 !important;
        width: 18px !important;
        height: 18px !important;
    }

    /* HOVER DO BOTÃO EDITAR */
    button[onclick*="edit"]:hover:not(:disabled),
    button[onclick*="Edit"]:hover:not(:disabled),
    button[onclick*="editar"]:hover:not(:disabled),
    button[onclick*="Editar"]:hover:not(:disabled),
    button[onclick*="openTaskModal"]:hover:not(:disabled),
    button[onclick*="openCompanyModal"]:hover:not(:disabled),
    button[onclick*="openNoteModal"]:hover:not(:disabled),
    button.icon-btn:not(.delete-btn):not([onclick*="delete"]):not([onclick*="closeModals"]):hover:not(:disabled) {
        background: rgba(59, 130, 246, 0.2) !important;
        border-color: #3b82f6 !important;
        transform: translateY(-2px) !important;
    }

    /* ======================================================== */

    /* CORREÇÃO ESPECÍFICA PARA BOTÕES NOS CARDS */

    /* Botões de ação nos cards de tarefa */
    .card .card-actions button,
    .company-card .company-actions button,
    .note-card button {
        width: 40px !important;
        height: 40px !important;
        padding: 0 !important;
        border-radius: var(--radius-full) !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        margin: 0 !important;
    }

    /* Remove espaçamento extra entre botões */
    .card-actions,
    .company-actions {
        gap: 8px !important;
        display: flex !important;
    }

    /* ======================================================== */

    /* CORREÇÃO PARA BOTÕES NOS MODAIS */

    /* Footer do modal */
    .modal-footer button {
        min-width: 120px !important;
        min-height: 44px !important;
        border-radius: var(--radius-lg) !important;
        padding: 10px 20px !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        gap: 8px !important;
    }

    /* Botões específicos no modal */
    #btn-delete-task,
    #btn-delete-company,
    #btn-delete-note,
    #btn-delete-pin {
        background: rgba(239, 68, 68, 0.1) !important;
        color: #ef4444 !important;
        border: 1px solid rgba(239, 68, 68, 0.3) !important;
    }

    #btn-delete-task i,
    #btn-delete-company i,
    #btn-delete-note i,
    #btn-delete-pin i {
        color: #ef4444 !important;
        width: 16px !important;
        height: 16px !important;
    }

    /* Botão de cancelar no modal */
    .modal-footer button[onclick*="closeModals"]:not(.btn-main) {
        background: rgba(100, 116, 139, 0.1) !important;
        color: #64748b !important;
        border: 1px solid rgba(100, 116, 139, 0.3) !important;
    }

    /* Botão salvar no modal */
    .modal-footer .btn-main {
        background: linear-gradient(135deg, var(--primary), var(--primary-variant)) !important;
        color: white !important;
        border: none !important;
    }

    /* ======================================================== */

    /* REMOVE ESTILOS INLINE PROBLEMÁTICOS */
    button[style*="padding: 4px"],
    button[style*="padding: 6px"],
    button[style*="padding: 8px"] {
        padding: 8px !important;
    }

    button[style*="border: 1px solid var(--border)"],
    button[style*="border: 1px solid #e2e8f0"] {
        border: 1px solid rgba(100, 116, 139, 0.3) !important;
    }

    /* Remove cores de fundo específicas */
    button[style*="background: #f8fafc"],
    button[style*="background: #f1f5f9"],
    button[style*="background: white"] {
        background: rgba(59, 130, 246, 0.1) !important;
    }

    /* ======================================================== */

    /* ÍCONES PADRÃO PARA CADA TIPO */

    /* Garante que botões de excluir tenham ícone de lixeira */
    button.delete-btn i[data-lucide]:not([class*="trash"]):not([data-lucide*="trash"])::before {
        content: "" !important;
    }

    button.delete-btn i[data-lucide] {
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%23ef4444' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M3 6h18'/%3E%3Cpath d='M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6'/%3E%3Cpath d='M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2'/%3E%3C/svg%3E") !important;
        background-repeat: no-repeat !important;
        background-position: center !important;
        background-size: 18px !important;
    }

    /* Garante que botões de cancelar tenham ícone de X */
    button[onclick*="closeModals"] i[data-lucide]:not([class*="x"]):not([data-lucide*="x"])::before {
        content: "" !important;
    }

    button[onclick*="closeModals"] i[data-lucide] {
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%2364748b' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cline x1='18' y1='6' x2='6' y2='18'/%3E%3Cline x1='6' y1='6' x2='18' y2='18'/%3E%3C/svg%3E") !important;
        background-repeat: no-repeat !important;
        background-position: center !important;
        background-size: 18px !important;
    }

    /* Garante que botões de editar tenham ícone de caneta */
    button[onclick*="openTaskModal"] i[data-lucide]:not([class*="pencil"]):not([data-lucide*="pencil"])::before,
    button[onclick*="openCompanyModal"] i[data-lucide]:not([class*="pencil"]):not([data-lucide*="pencil"])::before,
    button[onclick*="openNoteModal"] i[data-lucide]:not([class*="pencil"]):not([data-lucide*="pencil"])::before {
        content: "" !important;
    }

    button[onclick*="openTaskModal"] i[data-lucide],
    button[onclick*="openCompanyModal"] i[data-lucide],
    button[onclick*="openNoteModal"] i[data-lucide] {
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%233b82f6' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7'/%3E%3Cpath d='M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z'/%3E%3C/svg%3E") !important;
        background-repeat: no-repeat !important;
        background-position: center !important;
        background-size: 18px !important;
    }

    /* ======================================================== */

    /* RESPONSIVIDADE */

    @media (max-width: 768px) {

        button.delete-btn,
        button[onclick*="delete"],
        button[onclick*="closeModals"],
        button[onclick*="edit"],
        button.icon-btn {
            min-width: 36px !important;
            min-height: 36px !important;
            padding: 6px !important;
        }

        .card .card-actions button,
        .company-card .company-actions button {
            width: 36px !important;
            height: 36px !important;
        }

        .modal-footer button {
            min-width: 100px !important;
            min-height: 40px !important;
            padding: 8px 16px !important;
        }
    }

    .notification-badge {
        position: absolute;
        top: -6px;
        right: -6px;
        min-width: 18px;
        min-height: 18px;
        padding: 2px 4px;
        background: var(--error);
        color: var(--on-error);
        font-size: 10px;
        font-weight: 700;
        border-radius: 50%;
        border: 2px solid var(--surface);
        display: flex;
        align-items: center;
        justify-content: center;
        animation: pulse 2s infinite;
    }

    /* Adicione ao seu CSS existente */
    .notification-dropdown {
        position: absolute;
        top: calc(100% + 8px);
        right: 0;
        background: var(--surface);
        border: 1px solid var(--outline-variant);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-lg);
        width: 380px;
        max-height: 500px;
        overflow-y: auto;
        z-index: 1001;
        display: none;
        animation: dropdownSlide 0.2s ease;
    }

    @keyframes dropdownSlide {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .notification-dropdown.show {
        display: block;
    }

    .notification-header {
        padding: 16px;
        border-bottom: 1px solid var(--outline-variant);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .notification-header h4 {
        font-size: 16px;
        font-weight: 600;
        color: var(--on-surface);
    }

    .notification-clear {
        background: transparent;
        border: none;
        color: var(--primary);
        font-size: 13px;
        font-weight: 500;
        cursor: pointer;
        padding: 4px 8px;
        border-radius: var(--radius-md);
        transition: var(--transition);
    }

    .notification-clear:hover {
        background: rgba(103, 80, 164, 0.1);
    }

    .notification-list {
        max-height: 400px;
        overflow-y: auto;
    }

    .notification-item {
        padding: 16px;
        border-bottom: 1px solid var(--surface-variant);
        cursor: pointer;
        transition: var(--transition);
        position: relative;
    }

    .notification-item:hover {
        background: var(--surface-variant);
    }

    .notification-item.unread {
        background: rgba(59, 130, 246, 0.05);
        border-left: 3px solid var(--info);
    }

    .notification-item.urgent {
        background: rgba(239, 68, 68, 0.05);
        border-left: 3px solid var(--error);
    }

    .notification-icon {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 12px;
        flex-shrink: 0;
    }

    .notification-icon.info {
        background: rgba(59, 130, 246, 0.1);
        color: var(--info);
    }

    .notification-icon.warning {
        background: rgba(245, 158, 11, 0.1);
        color: var(--warning);
    }

    .notification-icon.error {
        background: rgba(239, 68, 68, 0.1);
        color: var(--error);
    }

    .notification-icon.success {
        background: rgba(16, 185, 129, 0.1);
        color: var(--success);
    }

    .notification-content {
        flex: 1;
        min-width: 0;
    }

    .notification-title {
        font-weight: 600;
        color: var(--on-surface);
        margin-bottom: 4px;
        font-size: 14px;
    }

    .notification-desc {
        font-size: 13px;
        color: var(--on-surface-variant);
        line-height: 1.4;
    }

    .notification-time {
        font-size: 11px;
        color: var(--outline);
        margin-top: 4px;
        display: flex;
        align-items: center;
        gap: 4px;
    }

    .notification-badge-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: var(--error);
        position: absolute;
        top: 16px;
        right: 16px;
    }

    .notification-empty {
        padding: 40px 20px;
        text-align: center;
        color: var(--on-surface-variant);
    }

    .notification-empty i {
        opacity: 0.5;
        margin-bottom: 12px;
    }

    /* NOTIFICATION DROPDOWN */
    .notification-dropdown {
        position: absolute;
        top: 60px;
        right: 16px;
        background: var(--surface);
        border: 1px solid var(--outline-variant);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-lg);
        width: 380px;
        max-height: 500px;
        overflow-y: auto;
        z-index: 1001;
        display: none;
        animation: dropdownSlide 0.2s ease;
    }

    .notification-dropdown.show {
        display: block;
    }

    .notification-header {
        padding: 16px;
        border-bottom: 1px solid var(--outline-variant);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .notification-header h4 {
        font-size: 16px;
        font-weight: 600;
        color: var(--on-surface);
    }

    .notification-clear {
        background: transparent;
        border: none;
        color: var(--primary);
        font-size: 13px;
        font-weight: 500;
        cursor: pointer;
        padding: 4px 8px;
        border-radius: var(--radius-md);
        transition: var(--transition);
    }

    .notification-clear:hover {
        background: rgba(103, 80, 164, 0.1);
    }

    .notification-list {
        max-height: 400px;
        overflow-y: auto;
    }

    .notification-item {
        padding: 16px;
        border-bottom: 1px solid var(--surface-variant);
        cursor: pointer;
        transition: var(--transition);
        position: relative;
    }

    .notification-item:hover {
        background: var(--surface-variant);
    }

    .notification-item.unread {
        background: rgba(59, 130, 246, 0.05);
        border-left: 3px solid var(--info);
    }

    .notification-item.urgent {
        background: rgba(239, 68, 68, 0.05);
        border-left: 3px solid var(--error);
    }

    .notification-icon {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 12px;
        flex-shrink: 0;
    }

    .notification-icon.info {
        background: rgba(59, 130, 246, 0.1);
        color: var(--info);
    }

    .notification-icon.warning {
        background: rgba(245, 158, 11, 0.1);
        color: var(--warning);
    }

    .notification-icon.error {
        background: rgba(239, 68, 68, 0.1);
        color: var(--error);
    }

    .notification-icon.success {
        background: rgba(16, 185, 129, 0.1);
        color: var(--success);
    }

    .notification-content {
        flex: 1;
        min-width: 0;
    }

    .notification-title {
        font-weight: 600;
        color: var(--on-surface);
        margin-bottom: 4px;
        font-size: 14px;
    }

    .notification-desc {
        font-size: 13px;
        color: var(--on-surface-variant);
        line-height: 1.4;
    }

    .notification-time {
        font-size: 11px;
        color: var(--outline);
        margin-top: 4px;
        display: flex;
        align-items: center;
        gap: 4px;
    }

    .notification-badge-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: var(--error);
        position: absolute;
        top: 16px;
        right: 16px;
    }

    .notification-empty {
        padding: 40px 20px;
        text-align: center;
        color: var(--on-surface-variant);
    }

    .notification-empty i {
        opacity: 0.5;
        margin-bottom: 12px;
    }

    @keyframes dropdownSlide {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Header scrolled effect */
    .app-header.scrolled {
        box-shadow: var(--shadow-md);
        backdrop-filter: blur(10px);
        background: rgba(255, 255, 255, 0.95);
    }

    body.theme-dark .app-header.scrolled {
        background: rgba(20, 18, 24, 0.95);
    }
</style>

<body>

    <div id="toast-container"></div>

    <!-- LOGIN SCREEN -->
    <div id="auth-screen">
        <!-- Imagem de fundo -->
        <div class="auth-background"></div>
        <div class="auth-overlay"></div>

        <div class="auth-box fade-in">
            <!-- Logo e branding melhorados -->
            <div class="logo-container">
                <div class="logo">
                    <i data-lucide="calculator" class="logo-icon"></i>
                </div>
                <h1 class="brand-name">Gestor Contábil Pro</h1>
                <p class="brand-subtitle">Gestão profissional para escritórios</p>
            </div>

            <form id="auth-form">
                <div class="input-group">
                    <label for="email">
                        <i data-lucide="mail" width="16"></i> E-mail
                    </label>
                    <input type="email" id="email" class="std-input" placeholder="seu@email.com" required>
                </div>
                <div class="input-group">
                    <label for="password">
                        <i data-lucide="lock" width="16"></i> Senha
                    </label>
                    <input type="password" id="password" class="std-input" placeholder="••••••••" required>
                    <div style="text-align: right; margin-top: 5px;">
                        <button type="button" id="toggle-password" style="font-size: 0.8rem; color: var(--primary);">
                            <i data-lucide="eye" width="14"></i> Mostrar senha
                        </button>
                    </div>
                </div>

                <button type="submit" id="auth-btn" class="btn-main">
                    <i data-lucide="log-in" width="18"></i>
                    <span id="auth-btn-text">Entrar no Sistema</span>
                </button>
            </form>

            <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border);">
                <button id="toggle-auth-mode" class="btn-link">
                    <i data-lucide="user-plus" width="14"></i>
                    <span id="toggle-auth-text">Criar uma nova conta</span>
                </button>
            </div>
        </div>
    </div>

    <!-- APP SCREEN -->
    <div id="app-screen" class="hidden">
        <header class="app-header">
            <div class="brand">
                <i data-lucide="layout-grid"></i>
                <span>Escritório</span>
            </div>

            <nav class="nav-tabs">
                <button class="nav-tab active" onclick="switchTab('tasks')">
                    <i data-lucide="check-square" width="18"></i> Tarefas
                </button>
                <button class="nav-tab" onclick="switchTab('companies')">
                    <i data-lucide="building-2" width="18"></i> Empresas
                </button>
                <button class="nav-tab" onclick="switchTab('notes')">
                    <i data-lucide="notebook" width="18"></i> Notas
                </button>
                <button class="nav-tab" onclick="switchTab('dashboard')">
                    <i data-lucide="pie-chart" width="18"></i> Dashboard
                </button>
            </nav>

            <div class="user-actions">
                <button class="icon-btn" id="notification-btn" title="Notificações"
                    style="position: relative; margin-right: 10px;">
                    <i data-lucide="bell" width="20"></i>
                    <span id="notification-badge" class="hidden"
                        style="position: absolute; top: -2px; right: -2px; width: 8px; height: 8px; background: var(--danger); border-radius: 50%;"></span>
                </button>
                <button class="logout-btn" id="logout-btn" title="Sair">
                    <i data-lucide="log-out" width="20"></i>
                </button>
            </div>
        </header>

        <!-- NOTIFICATION DROPDOWN -->
        <div class="notification-dropdown hidden" id="notification-dropdown">
            <div class="notification-header">
                <h4>Notificações</h4>
                <button class="notification-clear" onclick="NotificationSystem.markAllAsRead()">
                    Limpar todas
                </button>
            </div>
            <div class="notification-list" id="notification-list">
                <!-- Notificações serão renderizadas aqui -->
            </div>
        </div>

        <!-- VIEW: TAREFAS -->
        <!-- VIEW: TAREFAS -->
        <main id="view-tasks" class="content-area fade-in">
            <!-- Dashboard Metrics com filtros -->
            <div class="metrics-grid">
                <div class="metric-card" id="filter-today" onclick="setTaskFilter('today')">
                    <div class="metric-icon">
                        <i data-lucide="clock"></i>
                    </div>
                    <div class="metric-content">
                        <div class="metric-value" id="today-tasks">0</div>
                        <div class="metric-label">Para hoje</div>
                    </div>
                </div>
                <div class="metric-card" id="filter-urgent" onclick="setTaskFilter('urgent')">
                    <div class="metric-icon">
                        <i data-lucide="alert-circle"></i>
                    </div>
                    <div class="metric-content">
                        <div class="metric-value" id="urgent-tasks">0</div>
                        <div class="metric-label">Urgentes</div>
                    </div>
                </div>
                <div class="metric-card" id="filter-completed" onclick="setTaskFilter('completed')">
                    <div class="metric-icon">
                        <i data-lucide="trending-up"></i>
                    </div>
                    <div class="metric-content">
                        <div class="metric-value" id="completed-today">0</div>
                        <div class="metric-label">Concluídas hoje</div>
                    </div>
                </div>
                <div class="metric-card active" id="filter-all" onclick="setTaskFilter('all')">
                    <div class="metric-icon">
                        <i data-lucide="list"></i>
                    </div>
                    <div class="metric-content">
                        <div class="metric-value" id="all-tasks">0</div>
                        <div class="metric-label">Todas</div>
                    </div>
                </div>
            </div>

            <div class="section-header"
                style="justify-content: space-between; align-items: center; gap: 10px; margin-top: 20px;">
                <div style="flex: 1;">
                    <div class="section-title">
                        <span id="filter-title">Pendências</span> <span id="pending-count"
                            class="counter-badge">0</span>
                    </div>
                    <div id="filter-info" style="font-size: 0.85rem; color: var(--on-surface-variant);">
                        <i data-lucide="filter"></i> <span id="current-filter">Todas as tarefas</span>
                    </div>
                </div>
                <div class="search-box" style="position: relative; max-width: 250px; width: 100%;">
                    <i data-lucide="search"
                        style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--on-surface-variant); width: 16px;"></i>
                    <input type="text" id="task-search" placeholder="Buscar tarefas..."
                        style="width: 100%; padding: 10px 12px 10px 36px; border-radius: var(--radius-lg); border: 1px solid var(--outline-variant); background: var(--surface); font-family: inherit; font-size: 0.9rem;"
                        oninput="searchTasks(this.value)">
                </div>
            </div>

            <div id="pending-list" class="task-list" style="margin-top: 20px;"></div>

            <div class="section-title" style="margin-top: 40px; margin-bottom: 16px; color: var(--on-surface-variant);">
                <i data-lucide="archive" width="16"></i> Histórico Recente
            </div>
            <div id="completed-list" class="task-list"></div>
        </main>

        <!-- VIEW: EMPRESAS -->
        <main id="view-companies" class="content-area hidden fade-in">
            <!-- Filtro de Empresa -->
            <div style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;">
                <!-- Filtro de Empresa (Dropdown) -->
                <div class="company-filter-container" style="flex: 1; min-width: 200px;">
                    <div class="company-filter-label">
                        <i data-lucide="filter" width="16"></i> Filtrar tarefas:
                    </div>
                    <select id="company-filter-select" class="company-filter-select" onchange="filterCompanyTasks()">
                        <option value="">Todas as empresas</option>
                        <!-- Options populated via JS -->
                    </select>
                    <button id="company-filter-clear" class="company-filter-clear hidden"
                        onclick="clearCompanyFilter()">
                        <i data-lucide="x" width="14"></i> Limpar
                    </button>
                </div>

                <!-- Search Box -->
                <div class="search-box" style="position: relative; flex: 1; min-width: 200px;">
                    <i data-lucide="search"
                        style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-sec); width: 16px;"></i>
                    <input type="text" id="company-search" placeholder="Buscar empresas (Nome, CNPJ)..."
                        style="width: 100%; padding: 12px 12px 12px 40px; border-radius: 12px; border: 1px solid var(--border); background: white; font-family: inherit; font-size: 0.95rem; box-shadow: var(--shadow-sm);"
                        oninput="searchCompanies(this.value)">
                </div>
            </div>

            <div class="section-header">
                <div class="section-title">
                    Carteira de Clientes <span id="company-count" class="counter-badge">0</span>
                </div>
            </div>

            <div id="company-list" class="company-grid"></div>

            <!-- Seção de tarefas da empresa filtrada -->
            <div id="company-tasks-section" class="company-tasks-section hidden">
                <div class="company-tasks-header">
                    <div class="company-tasks-title">
                        <i data-lucide="list-checks" width="18"></i>
                        <span id="company-tasks-title">Tarefas da Empresa</span>
                        <span id="company-tasks-count" class="company-tasks-count">0</span>
                    </div>
                </div>
                <div id="company-tasks-list" class="company-tasks-list"></div>
            </div>

            <div id="empty-companies" class="hidden"
                style="text-align: center; padding: 50px; border: 2px dashed var(--border); border-radius: 8px; color: var(--text-sec);">
                <i data-lucide="building" width="48" style="margin-bottom: 10px; opacity: 0.5;"></i>
                <p>Nenhuma empresa cadastrada.</p>
                <p style="font-size: 0.8rem;">Cadastre seus clientes para vincular tarefas.</p>
            </div>
        </main>

        <!-- VIEW: NOTAS -->
        <main id="view-notes" class="content-area hidden fade-in">
            <div class="section-header">
                <div class="section-title">
                    Suas Anotações
                </div>
                <!-- Botão Nova Nota -->

            </div>

            <div id="empty-notes" class="empty-state hidden">
                <i data-lucide="notebook" width="48" style="color: var(--text-sec); opacity: 0.5;"></i>
                <p>Nenhuma anotação ainda</p>

            </div>

            <div id="notes-list" class="notes-grid"
                style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; align-items: start;">
                <!-- Notes populated via JS -->
            </div>
        </main>

        <!-- VIEW: DASHBOARD -->
        <main id="view-dashboard" class="content-area hidden fade-in">
            <div class="dashboard-header"
                style="margin-bottom: 24px; display: flex; justify-content: space-between; align-items: flex-end; flex-wrap: wrap; gap: 16px;">
                <div>
                    <h2 class="section-title" style="font-size: 1.5rem; margin-bottom: 4px;">Visão Geral do Escritório
                    </h2>
                    <div id="dashboard-date" style="color: var(--on-surface-variant); font-size: 0.9rem;">Carregando
                        data...</div>
                </div>

                <div style="display: flex; gap: 10px;">
                    <button onclick="ReportSystem.generateWeeklyReport()" class="btn-main"
                        style="min-height: 40px; padding: 0 16px; font-size: 0.9rem; background: var(--secondary);">
                        <i data-lucide="file-text" width="16"></i> Relatório Semanal
                    </button>
                    <button onclick="DashboardManager.refresh()" class="icon-btn" title="Atualizar Dados"
                        style="background: var(--surface); border: 1px solid var(--outline-variant);">
                        <i data-lucide="refresh-cw" width="18"></i>
                    </button>
                </div>
            </div>

            <div class="metrics-grid"
                style="grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 16px; margin-bottom: 24px;">
                <div class="metric-card"
                    style="background: linear-gradient(135deg, #6750a4, #7d5260); color: white; border: none;">
                    <div class="metric-icon" style="background: rgba(255,255,255,0.2); color: white;">
                        <i data-lucide="building-2"></i>
                    </div>
                    <div class="metric-content">
                        <div class="metric-value" id="kpi-companies">0</div>
                        <div class="metric-label" style="color: rgba(255,255,255,0.9);">Empresas Ativas</div>
                    </div>
                </div>

                <div class="metric-card" style="border-left: 4px solid var(--warning);">
                    <div class="metric-icon" style="background: #fff8e1; color: var(--warning);">
                        <i data-lucide="clock"></i>
                    </div>
                    <div class="metric-content">
                        <div class="metric-value" id="kpi-pending">0</div>
                        <div class="metric-label">Pendências Totais</div>
                    </div>
                </div>

                <div class="metric-card" style="border-left: 4px solid var(--success);">
                    <div class="metric-icon" style="background: #e8f5e9; color: var(--success);">
                        <i data-lucide="activity"></i>
                    </div>
                    <div class="metric-content">
                        <div class="metric-value" id="kpi-efficiency">0%</div>
                        <div class="metric-label">Eficiência Mensal</div>
                    </div>
                </div>

                <div class="metric-card" style="display: none;">
                    <div class="metric-icon" style="background: #e3f2fd; color: var(--info);">
                        <i data-lucide="dollar-sign"></i>
                    </div>
                    <div class="metric-content">
                        <div class="metric-value" id="kpi-revenue">R$ 0,00</div>
                        <div class="metric-label">Receita Estimada</div>
                    </div>
                </div>
            </div>

            <div class="dashboard-split"
                style="grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); margin-bottom: 24px;">
                <div class="glass-panel" style="position: relative;">
                    <h3
                        style="font-size: 1.1rem; font-weight: 600; margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
                        <i data-lucide="pie-chart" width="18" style="color: var(--primary);"></i> Distribuição
                        Tributária
                    </h3>
                    <div style="height: 250px; width: 100%;">
                        <canvas id="chart-regimes"></canvas>
                    </div>
                </div>

                <div class="glass-panel" style="position: relative;">
                    <h3
                        style="font-size: 1.1rem; font-weight: 600; margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
                        <i data-lucide="bar-chart-2" width="18" style="color: var(--primary);"></i> Status das
                        Obrigações
                    </h3>
                    <div style="height: 250px; width: 100%;">
                        <canvas id="chart-tasks"></canvas>
                    </div>
                </div>
            </div>

            <div class="dashboard-split">
                <div class="deadlines-section glass-panel" style="border-top: 4px solid var(--info);">
                    <div class="section-header" style="margin-bottom: 15px;">
                        <div class="section-title" style="font-size: 1rem;">
                            <i data-lucide="calendar" style="color: var(--info);"></i> Próximos 7 Dias
                        </div>
                        <span class="counter-badge" id="count-upcoming">0</span>
                    </div>
                    <div id="dashboard-upcoming-list" class="task-list" style="max-height: 300px; overflow-y: auto;">
                        <p style="text-align: center; color: var(--outline); padding: 20px;">Carregando...</p>
                    </div>
                </div>

                <div class="alerts-section glass-panel" style="border-top: 4px solid var(--error);">
                    <div class="section-header" style="margin-bottom: 15px;">
                        <div class="section-title" style="color: var(--error); font-size: 1rem;">
                            <i data-lucide="alert-triangle"></i> Atenção Necessária
                        </div>
                        <span class="counter-badge" id="count-alerts" style="background: var(--error);">0</span>
                    </div>
                    <div id="dashboard-alerts-list" class="task-list" style="max-height: 300px; overflow-y: auto;">
                        <p style="text-align: center; color: var(--outline); padding: 20px;">Tudo certo por aqui!</p>
                    </div>
                </div>
            </div>
        </main>


        <!-- FAB -->
        <button id="main-fab" class="fab" onclick="handleFabClick()">
            <i data-lucide="plus" width="28"></i>
        </button>
    </div>

    <!-- MODAL: TAREFA -->
    <div id="modal-task" class="modal-overlay hidden">
        <div class="modal">
            <div class="modal-header">
                <h3 id="modal-task-title">Nova Tarefa</h3>
                <button onclick="closeModals()"><i data-lucide="x"></i></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="task-id">

                <div class="input-group">
                    <label>Empresa / Cliente *</label>
                    <select id="task-company" class="std-input" required>
                        <option value="">Selecione a Empresa...</option>
                        <!-- Options populated via JS -->
                    </select>
                </div>

                <div class="input-group">
                    <label>Título da Demanda *</label>
                    <input type="text" id="task-title" class="std-input" placeholder="Ex: Fechamento Folha, DAS, IR...">
                </div>

                <div class="input-group">
                    <label>Categoria da Tarefa *</label>
                    <select id="task-category" class="std-input" required>
                        <option value="">Selecione...</option>
                        <option value="FISCAL">Fiscal</option>
                        <option value="TRABALHISTA">Trabalhista</option>
                        <option value="CONTABIL">Contábil</option>
                        <option value="MUNICIPAL">Municipal</option>
                        <option value="OUTROS">Outros</option>
                    </select>
                </div>

                <div class="input-group">
                    <label>Obrigação Específica</label>
                    <select id="task-obligation" class="std-input" onchange="updateTaskFields()">
                        <option value="">Selecione...</option>
                        <option value="DAS">DAS (Simples Nacional)</option>
                        <option value="GPS">GPS (Funcionários)</option>
                        <option value="IRPJ">IRPJ (Lucro Presumido/Real)</option>
                        <option value="CSLL">CSLL</option>
                        <option value="PIS_COFINS">PIS/COFINS</option>
                        <option value="EFD">EFD Contribuições</option>
                        <option value="DIRF">DIRF</option>
                        <option value="DCTF">DCTF</option>
                        <option value="RAIS">RAIS</option>
                        <option value="CAGED">CAGED</option>
                        <option value="SEFIP">SEFIP</option>
                        <option value="DARF">DARF</option>
                    </select>
                </div>

                <div class="input-group">
                    <label>Prazo Limite</label>
                    <input type="date" id="task-deadline" class="std-input">
                </div>

                <div class="input-group">
                    <label>Periodicidade</label>
                    <select id="task-periodicity" class="std-input">
                        <option value="UNICA">Única</option>
                        <option value="MENSAL">Mensal</option>
                        <option value="TRIMESTRAL">Trimestral</option>
                        <option value="ANUAL">Anual</option>
                    </select>
                </div>

                <div class="input-group">
                    <label>Mês/Ano de Referência</label>
                    <input type="month" id="task-reference" class="std-input">
                </div>

                <div class="input-group">
                    <label>Valor (R$)</label>
                    <input type="number" step="0.01" id="task-value" class="std-input" placeholder="0,00">
                </div>

                <div class="input-group">
                    <label>Status do Pagamento</label>
                    <select id="task-payment-status" class="std-input">
                        <option value="PENDENTE">Pendente</option>
                        <option value="PAGO">Pago</option>
                        <option value="ATRASADO">Atrasado</option>
                        <option value="ISENTO">Isento</option>
                    </select>
                </div>

                <div class="input-group">
                    <label>Detalhes (Opcional)</label>
                    <textarea id="task-desc" class="std-input" rows="3"
                        placeholder="Prazos, protocolos, obs..."></textarea>
                </div>

                <div class="input-group">
                    <label>Link/Referência do Arquivo</label>
                    <input type="url" id="task-file-link" class="std-input" placeholder="https://drive.google.com/...">
                </div>

                <div class="input-group">
                    <label>Observações Internas</label>
                    <textarea id="task-internal-notes" class="std-input" rows="2"
                        placeholder="Anotações para a equipe..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" id="btn-delete-task" class="hidden"
                    style="color: var(--danger); margin-right: auto; font-weight: 600;" onclick="confirmDeleteTask()">
                    <i data-lucide="trash-2" width="16"></i> Excluir Tarefa
                </button>
                <button onclick="closeModals()"
                    style="color: var(--text-sec); font-weight: 600; padding: 0 15px;">Cancelar</button>
                <button onclick="saveTask()" class="btn-main" style="width: auto; padding: 10px 24px;">Salvar
                    Tarefa</button>
            </div>
        </div>
    </div>

    <!-- MODAL: EMPRESA -->
    <div id="modal-company" class="modal-overlay hidden">
        <div class="modal">
            <div class="modal-header">
                <h3 id="modal-company-title">Cadastrar Empresa</h3>
                <button onclick="closeModals()"><i data-lucide="x"></i></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="company-id">

                <div class="input-group">
                    <label>Razão Social / Nome Fantasia *</label>
                    <input type="text" id="company-name" class="std-input" placeholder="Ex: Padaria Central LTDA">
                </div>

                <div class="input-group">
                    <label>CNPJ (Opcional)</label>
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <input type="text" id="company-cnpj" class="std-input" placeholder="00.000.000/0001-00"
                            style="flex: 1;">
                        <button type="button" class="btn-cnpj-search"
                            style="padding: 10px 16px; background: var(--primary); color: white; border: none; border-radius: var(--radius-lg); cursor: pointer; display: flex; align-items: center; gap: 6px; white-space: nowrap;">
                            <i data-lucide="search" width="16"></i> Consultar
                        </button>
                    </div>
                </div>

                <!-- Adicione loading após o campo CNPJ -->
                <div id="cnpj-loading" class="hidden" style="margin-top: 8px; display: none;">
                    <div style="display: flex; align-items: center; gap: 8px; color: var(--primary); font-size: 14px;">
                        <i data-lucide="loader-2" width="16" style="animation: spin 1s linear infinite;"></i>
                        <span>Consultando CNPJ na Receita Federal...</span>
                    </div>
                </div>
                <!-- Adicione esses campos SE QUISER, depois do campo CNPJ: -->

                <div class="input-group">
                    <label>Razão Social (será preenchido automaticamente)</label>
                    <input type="text" id="company-nome" class="std-input" readonly>
                </div>

                <div class="input-group">
                    <label>Nome Fantasia</label>
                    <input type="text" id="company-fantasia" class="std-input" readonly>
                </div>

                <div class="input-group">
                    <label>Município/UF</label>
                    <input type="text" id="company-city-state" class="std-input" readonly>
                </div>

                <div class="input-group">
                    <label>Situação Cadastral</label>
                    <input type="text" id="company-situation" class="std-input" readonly>
                </div>
                <div class="input-group">
                    <label>Tipo da Empresa *</label>
                    <select id="company-type" class="std-input" required>
                        <option value="">Selecione...</option>
                        <option value="MEI">MEI (Microempreendedor Individual)</option>
                        <option value="EI">EI (Empresário Individual)</option>
                        <option value="LTDA">LTDA (Sociedade Limitada)</option>
                        <option value="EIRELI">EIRELI</option>
                        <option value="SA">SA (Sociedade Anônima)</option>
                    </select>
                </div>

                <div class="input-group">
                    <label>Regime Tributário *</label>
                    <select id="company-regime" class="std-input" required onchange="updateRegimeFields()">
                        <option value="">Selecione...</option>
                        <option value="SIMPLES">Simples Nacional</option>
                        <option value="PRESUMIDO">Lucro Presumido</option>
                        <option value="REAL">Lucro Real</option>
                    </select>
                </div>

                <!-- Campos específicos para Lucro Presumido -->
                <div id="presumido-fields" style="display: none;">
                    <div class="input-group">
                        <label>Percentual de Presunção</label>
                        <select id="company-percentual" class="std-input">
                            <option value="8">Comércio: 8%</option>
                            <option value="12">Indústria: 12%</option>
                            <option value="32">Serviços: 32%</option>
                            <option value="custom">Personalizado</option>
                        </select>
                    </div>
                </div>

                <div class="input-group">
                    <label>CNAE Principal</label>
                    <input type="text" id="company-cnae" class="std-input" placeholder="Ex: 47.81-4-01">
                </div>

                <div class="input-group">
                    <label>Telefone / Contato</label>
                    <input type="text" id="company-phone" class="std-input" placeholder="(00) 00000-0000">
                </div>

                <div class="input-group">
                    <label>Data de Abertura</label>
                    <input type="date" id="company-open-date" class="std-input">
                </div>

                <div class="input-group">
                    <label>Endereço Completo</label>
                    <textarea id="company-address" class="std-input" rows="2"
                        placeholder="Rua, número, bairro, cidade..."></textarea>
                </div>

                <div class="input-group">
                    <label>E-mail</label>
                    <input type="email" id="company-email" class="std-input" placeholder="contato@empresa.com">
                </div>

                <div class="input-group">
                    <label>Responsável Legal</label>
                    <input type="text" id="company-responsible" class="std-input"
                        placeholder="Nome do sócio/administrador">
                </div>

                <div class="input-group">
                    <label>Tem Funcionários?</label>
                    <select id="company-has-employees" class="std-input">
                        <option value="">Selecione...</option>
                        <option value="true">Sim</option>
                        <option value="false">Não</option>
                    </select>
                </div>

                <div class="input-group">
                    <label>Situação</label>
                    <select id="company-status" class="std-input">
                        <option value="ATIVA">Ativa</option>
                        <option value="BAIXADA">Baixada</option>
                        <option value="SUSPENSA">Suspensa</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" id="btn-delete-company" class="hidden"
                    style="color: var(--danger); margin-right: auto; font-weight: 600;"
                    onclick="confirmDeleteCompany()">
                    <i data-lucide="trash-2" width="16"></i> Excluir Empresa
                </button>
                <button onclick="closeModals()"
                    style="color: var(--text-sec); font-weight: 600; padding: 0 15px;">Cancelar</button>
                <button onclick="saveCompany()" class="btn-main" style="width: auto; padding: 10px 24px;">Salvar
                    Empresa</button>
            </div>
        </div>
    </div>

    <!-- MODAL: NOVA/EDITAR NOTA -->
    <div id="modal-note" class="modal-overlay hidden">
        <div class="modal">
            <div class="modal-header">
                <h3 id="modal-note-title">Nova Anotação</h3>
                <button onclick="closeModals()"><i data-lucide="x"></i></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="note-id">
                <div class="input-group">
                    <label>Título *</label>
                    <input type="text" id="note-title" class="std-input" placeholder="Ex: Ideia para campanha...">
                </div>

                <!-- Conteúdo -->
                <div class="input-group">
                    <label>Conteúdo</label>
                    <textarea id="note-content" class="std-input" rows="6"
                        placeholder="Detalhes da anotação..."></textarea>
                </div>

                <!-- Lembrete Principal -->
                <div class="input-group">
                    <label>Lembrete Principal (Opcional)</label>
                    <input type="datetime-local" id="note-reminder" class="std-input">
                </div>

                <div class="input-group" style="flex-direction: row; align-items: center; gap: 8px;">
                    <input type="checkbox" id="note-email-notify">
                    <label for="note-email-notify" style="margin: 0; font-weight: normal;">Notificar por E-mail</label>
                </div>

                <!-- SEÇÃO DE COMENTÁRIOS (Apenas para edição) -->
                <div id="note-comments-section" class="hidden"
                    style="margin-top: 20px; border-top: 1px solid var(--border); padding-top: 15px;">
                    <h4 style="margin-bottom: 10px; font-size: 0.95rem; color: var(--text-main);">Comentários &
                        Atualizações</h4>

                    <!-- Lista de Comentários -->
                    <div id="note-comments-list"
                        style="margin-bottom: 15px; display: flex; flex-direction: column; gap: 10px;">
                        <!-- Comentários serão renderizados aqui -->
                    </div>

                    <!-- Novo Comentário -->
                    <div style="background: var(--bg-sec); padding: 10px; border-radius: 8px;">
                        <textarea id="new-comment-text" class="std-input" rows="2"
                            placeholder="Adicionar um comentário ou atualização..."
                            style="margin-bottom: 8px; font-size: 0.85rem;"></textarea>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <input type="datetime-local" id="new-comment-reminder" class="std-input"
                                style="font-size: 0.8rem; padding: 6px;">
                            <button onclick="saveNoteComment()" class="btn-main"
                                style="padding: 6px 12px; font-size: 0.8rem;">Adicionar</button>
                        </div>
                    </div>
                </div>

            </div>
            <div class="modal-footer" style="justify-content: space-between; align-items: center;">
                <button type="button" id="btn-delete-note" class="hidden icon-btn"
                    style="color: var(--danger); border: 1px solid var(--border); padding: 8px; border-radius: 6px;"
                    onclick="confirmDeleteNote()" title="Excluir Nota">
                    <i data-lucide="trash-2" width="20"></i>
                </button>

                <div style="display: flex; gap: 10px; margin-left: auto;">
                    <button onclick="closeModals()" class="icon-btn"
                        style="color: var(--text-sec); border: 1px solid var(--border); padding: 8px; border-radius: 6px;"
                        title="Cancelar">
                        <i data-lucide="x" width="20"></i>
                    </button>
                    <button onclick="saveNote()" class="btn-main"
                        style="width: auto; padding: 8px 12px; display: flex; align-items: center; justify-content: center;"
                        title="Salvar Nota">
                        <i data-lucide="check" width="20"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL: CONFIRMAÇÃO DE EXCLUSÃO -->
    <div id="modal-delete-confirm" class="modal-overlay hidden">
        <div class="modal" style="max-width: 400px; text-align: center;">
            <div class="modal-body">
                <div class="delete-confirm-icon">
                    <i data-lucide="alert-triangle" width="32"></i>
                </div>
                <div class="delete-confirm-title" id="delete-confirm-title">Excluir Item</div>
                <div class="delete-confirm-message" id="delete-confirm-message">Tem certeza que deseja excluir este
                    item?</div>
                <div class="delete-confirm-actions">
                    <button class="btn-cancel" onclick="closeModals()">Cancelar</button>
                    <button class="btn-danger" id="btn-confirm-delete" onclick="confirmDelete()">Sim, Excluir</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL: NOTA RÁPIDA DO CARD -->
    <div id="modal-card-note" class="modal-overlay hidden">
        <div class="modal" style="max-width: 500px;">
            <div class="modal-header">
                <h3>Nota Rápida</h3>
                <button onclick="closeModals()"><i data-lucide="x"></i></button>
            </div>
            <div class="modal-body">
                <div id="card-note-content">
                    <!-- Conteúdo será preenchido via JavaScript -->
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL: PIN/ETIQUETA -->
    <div id="modal-pin" class="modal-overlay hidden">
        <div class="modal" style="max-width: 500px;">
            <div class="modal-header">
                <h3 id="modal-pin-title">Nova Etiqueta</h3>
                <button onclick="closeModals()"><i data-lucide="x"></i></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="pin-id">
                <input type="hidden" id="pin-target-type"> <!-- 'task' ou 'company' -->
                <input type="hidden" id="pin-target-id">

                <div class="input-group">
                    <label>Título da Etiqueta *</label>
                    <input type="text" id="pin-title" class="std-input"
                        placeholder="Ex: Pendência, Importante, Revisar...">
                </div>

                <div class="input-group">
                    <label>Cor da Etiqueta</label>
                    <div id="pin-colors" class="colors-grid">
                        <!-- Cores serão geradas via JS -->
                    </div>
                </div>

                <div class="input-group">
                    <label>Comentário</label>
                    <textarea id="pin-comment" class="std-input" rows="4"
                        placeholder="Adicione um comentário ou observação..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" id="btn-delete-pin" class="hidden"
                    style="color: var(--danger); margin-right: auto; font-weight: 600;" onclick="confirmDeletePin()">
                    <i data-lucide="trash-2" width="16"></i> Excluir Etiqueta
                </button>
                <button onclick="closeModals()"
                    style="color: var(--text-sec); font-weight: 600; padding: 0 15px;">Cancelar</button>
                <button onclick="savePin()" class="btn-main" style="width: auto; padding: 10px 24px;">Salvar
                    Etiqueta</button>
            </div>
        </div>
    </div>
    <!-- NOTIFICATION DROPDOWN -->
    <div class="notification-dropdown hidden" id="notification-dropdown">
        <div class="notification-header">
            <h4>Notificações</h4>
            <div>
                <button class="notification-clear" onclick="NotificationSystem.markAllAsRead()"
                    style="margin-right: 10px;">
                    Limpar todas
                </button>
                <button class="notification-clear" onclick="NotificationSystem.showAllNotifications()">
                    Ver todas
                </button>
            </div>
        </div>
        <div class="notification-list" id="notification-list">
            <div class="notification-empty">
                <i data-lucide="bell" width="32"></i>
                <p>Nenhuma notificação</p>
                <p style="font-size: 12px; margin-top: 4px;">Tudo em dia!</p>
            </div>
        </div>
    </div>
    <!-- LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";

        import {
            setDoc,
            orderBy,
            limit
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, serverTimestamp, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyByyM8RvGNM5pyrQIQ7nCH6mmgYAIpq0bc",
            authDomain: "rifas-c414b.firebaseapp.com",
            projectId: "rifas-c414b",
            storageBucket: "rifas-c414b.firebasestorage.app",
            messagingSenderId: "770195193538",
            appId: "1:770195193538:web:48e585ac5661d27f3dc55b"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        window.__app_id = 'gestor-contabil-pro';
        const appId = window.__app_id || 'gestor-contabil-pro';



        // STATE
        let currentUser = null;
        let isLoginMode = true;
        let currentTab = 'tasks';
        let allTasks = [];
        let allCompanies = [];
        let allNotes = []; // Array para notas
        let allPins = []; // Array para armazenar todas as etiquetas
        let unsubTasks = null;
        let unsubCompanies = null;
        let unsubNotes = null;
        let unsubInvites = null; // Para convites
        let unsubPins = null; // Para unsubscribe do Firestore
        let currentTaskFilter = 'all'; // 'all', 'today', 'urgent', 'completed'
        let deletePending = { type: null, id: null }; // Para controlar exclusões pendentes
        let selectedCompanyId = null; // Para controlar qual empresa está sendo filtrada
        let taskToHighlight = null; // Para controlar qual tarefa destacar ao navegar
        let pressTimer = null; // Timer para pressão longa
        let currentPressingCard = null; // Card atualmente pressionado
        let currentNoteItem = null; // Item atual para nota
        let currentTaskSearch = ''; // Busca de tarefas
        let currentCompanySearch = ''; // Busca de empresas

        function initInvitesSystem() {
            if (!currentUser) return;

            // Limpar listener anterior se existir
            if (unsubInvites) {
                unsubInvites();
                unsubInvites = null;
            }

            // Verificar se usuário tem convites pendentes
            checkForPendingInvites();

            // Observar convites em tempo real
            const invitesRef = collection(db, 'artifacts', appId, 'collaborators');
            const q = query(
                invitesRef,
                where('email', '==', currentUser.email),
                where('status', '==', 'pending')
            );

            unsubInvites = onSnapshot(q, (snapshot) => {
                if (!snapshot.empty) {
                    showInviteNotification(snapshot.docs.length);
                } else {
                    showInviteNotification(0);
                    document.getElementById('invite-badge')?.classList.add('hidden');
                }
            });
        }
        async function checkForPendingInvites() {
            try {
                const user = auth.currentUser;
                if (!user) return;

                const invites = await CollaboratorManager.listMyInvites();
                const inviteBadge = document.getElementById('invite-badge');

                if (inviteBadge) {
                    if (invites.length > 0) {
                        inviteBadge.textContent = invites.length > 99 ? '99+' : invites.length;
                        inviteBadge.classList.remove('hidden');

                        // Adicionar animação
                        inviteBadge.style.animation = 'pulse 2s infinite';

                        // Também mostrar no badge de notificações
                        if (window.NotificationSystem) {
                            window.NotificationSystem.updateNotificationBadge();
                        }
                    } else {
                        inviteBadge.classList.add('hidden');
                    }
                }

                return invites;
            } catch (error) {
                console.error('Erro ao verificar convites:', error);
                return [];
            }
        }

        window.handleOpenInvites = async function () {
            // Fechar dropdown
            document.getElementById('user-dropdown')?.classList.remove('show');

            // Verificar convites
            const invites = await checkForPendingInvites();

            // Abrir modal, mesmo se vazio (feedback visual)
            openInvitesModal(invites);
        };

        function openInvitesModal(invites) {
            // Se não passar convites, tenta pegar
            if (!invites && window.CollaboratorManager) {
                checkForPendingInvites().then(list => openInvitesModal(list));
                return;
            }

            // Criar modal se não existir (na verdade cria sempre novo para simplificar)
            // Remover anterior se existir
            const existing = document.getElementById('modal-invites-dynamic');
            if (existing) existing.remove();

            const modal = document.createElement('div');
            modal.id = 'modal-invites-dynamic';
            modal.className = 'modal-overlay';
            modal.style.zIndex = '99999';

            modal.innerHTML = `
                <div class="modal">
                    <div class="modal-header">
                        <h3>Convites Pendentes</h3>
                        <button onclick="document.getElementById('modal-invites-dynamic').remove()"><i data-lucide="x"></i></button>
                    </div>
                    <div class="modal-body" id="invites-list-container">
                        ${invites && invites.length > 0 ? '' : '<p style="text-align:center; color:var(--text-sec); padding:20px;">Você não tem convites pendentes.</p>'}
                    </div>
                    <div class="modal-footer">
                        <button onclick="document.getElementById('modal-invites-dynamic').remove()" class="btn-main">Fechar</button>
                    </div>
                </div>
             `;

            document.body.appendChild(modal);

            if (invites && invites.length > 0) {
                renderInvitesList(invites, document.getElementById('invites-list-container'));
            }

            lucide.createIcons();
        }

        function renderInvitesList(invites, container) {
            container.innerHTML = invites.map(invite => `
                <div class="invite-item" style="
                    background: var(--surface-variant);
                    padding: 16px;
                    border-radius: 12px;
                    margin-bottom: 12px;
                    border: 1px solid var(--outline-variant);
                ">
                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                        <div>
                            <div style="font-weight: 600; margin-bottom: 4px;">Convite de Colaboração</div>
                            <div style="font-size: 14px; color: var(--on-surface-variant);">
                                Convidado por: <strong>${invite.invitedBy}</strong>
                            </div>
                            <div style="font-size: 12px; color: var(--outline); margin-top: 4px;">
                                Em: ${invite.invitedAtFormatted}
                            </div>
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button onclick="rejectInvite('${invite.id}')" 
                                    style="padding: 8px 16px; border: 1px solid var(--error); color: var(--error); background: transparent; border-radius: 6px; cursor: pointer; font-weight: 500;">
                                Recusar
                            </button>
                            <button onclick="acceptInvite('${invite.id}', '${invite.workspaceOwnerId}')" 
                                    style="padding: 8px 16px; background: var(--primary); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;">
                                Aceitar
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        window.acceptInvite = async function (inviteId, workspaceOwnerId) {
            if (!confirm('Deseja aceitar este convite?')) return;

            try {
                await CollaboratorManager.acceptInvite(inviteId);
                showToast('Convite aceito com sucesso!', 'success');
                document.getElementById('modal-invites-dynamic')?.remove();

                // Se quiser trocar de workspace automaticamente:
                // CollaboratorManager.switchWorkspace(workspaceOwnerId, ...);
                // Mas melhor deixar usuário escolher.

                checkForPendingInvites(); // Atualizar badge
            } catch (error) {
                console.error('Erro ao aceitar convite:', error);
                showToast('Erro ao aceitar convite: ' + error.message, 'error');
            }
        };

        window.rejectInvite = async function (inviteId) {
            if (!confirm('Deseja recusar este convite?')) return;

            try {
                // Implementar rejeição se CollaboratorManager tiver (add if missing)
                // Assumindo que removeCollaborator ou similar serve, ou criar rejectInvite específico
                // Por enquanto, vou remover o documento do convite
                await deleteDoc(doc(db, 'artifacts', appId, 'collaborators', inviteId));

                showToast('Convite recusado.', 'info');
                document.getElementById('modal-invites-dynamic')?.remove();
                checkForPendingInvites();
            } catch (error) {
                console.error('Erro ao recusar convite:', error);
                showToast('Erro ao recusar convite', 'error');
            }
        };


        function showInviteModal(invites) {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.style.zIndex = '99999';

            let invitesHtml = '';
            invites.forEach(invite => {
                invitesHtml += `
      <div class="invite-item" style="
        background: var(--surface-variant);
        padding: 16px;
        border-radius: 12px;
        margin-bottom: 12px;
        border: 1px solid var(--outline-variant);
      ">
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <div>
            <div style="font-weight: 600; margin-bottom: 4px;">Convite de colaboração</div>
            <div style="font-size: 14px; color: var(--on-surface-variant);">
              Convidado por: ${invite.invitedBy}
            </div>
            <div style="font-size: 12px; color: var(--outline); margin-top: 4px;">
              Enviado em: ${invite.invitedAtFormatted}
            </div>
          </div>
          <div style="display: flex; gap: 8px;">
            <button onclick="acceptInvite('${invite.id}')" class="btn-main" style="padding: 8px 16px;">
              Aceitar
            </button>
            <button onclick="rejectInvite('${invite.id}')" class="btn-cancel" style="padding: 8px 16px;">
              Recusar
            </button>
          </div>
        </div>
      </div>
    `;
            });

            modal.innerHTML = `
    <div class="modal" style="max-width: 500px;">
      <div class="modal-header">
        <h3><i data-lucide="mail"></i> Convites Pendentes</h3>
        <button onclick="this.closest('.modal-overlay').remove()">
          <i data-lucide="x"></i>
        </button>
      </div>
      <div class="modal-body">
        <p style="margin-bottom: 16px;">Você tem ${invites.length} convite(s) para colaborar em escritórios:</p>
        ${invitesHtml}
      </div>
      <div class="modal-footer">
        <button onclick="this.closest('.modal-overlay').remove()" class="btn-main">
          Fechar
        </button>
      </div>
    </div>
  `;

            document.body.appendChild(modal);
            lucide.createIcons();
        }
        window.acceptInvite = async function (inviteId) {
            const success = await CollaboratorManager.acceptInvite(inviteId);
            if (success) {
                // Fechar modal e recarregar dados
                document.querySelector('.modal-overlay')?.remove();
                location.reload(); // Recarrega para aplicar permissões
            }
        };
        window.rejectInvite = async function (inviteId) {
            if (!confirm('Tem certeza que deseja recusar este convite?')) return;

            try {
                const user = auth.currentUser;
                if (!user) return;

                const inviteRef = doc(db, 'artifacts', appId, 'collaborators', inviteId);
                await updateDoc(inviteRef, {
                    status: 'rejected',
                    rejectedAt: serverTimestamp(),
                    rejectedBy: user.email
                });

                showToast('Convite recusado', 'success');
                document.querySelector('.modal-overlay')?.remove();
            } catch (error) {
                console.error('Erro ao recusar convite:', error);
                showToast('Erro ao recusar convite', 'error');
            }
        };
        const CollaboratorManager = {
            async addCollaborator(email, permissionLevel = 'editor') {
                try {
                    const user = auth.currentUser;
                    if (!user) {
                        showToast('Usuário não autenticado', 'error');
                        return false;
                    }

                    const collaboratorDoc = {
                        email: email.toLowerCase().trim(),
                        ownerId: user.uid,
                        ownerEmail: user.email,
                        invitedBy: user.email,
                        invitedAt: serverTimestamp(),
                        permissionLevel: permissionLevel, // 'viewer', 'editor', 'admin'
                        status: 'pending', // 'pending', 'active', 'rejected', 'revoked'
                        workspaceId: appId,
                        lastNotified: serverTimestamp()
                    };

                    // Verificar se já existe convite pendente
                    const existingInvites = await this.listCollaborators();
                    const alreadyInvited = existingInvites.find(c =>
                        c.email.toLowerCase() === email.toLowerCase() && c.status === 'pending'
                    );

                    if (alreadyInvited) {
                        showToast('Já existe um convite pendente para este e-mail', 'warning');
                        return false;
                    }

                    await addDoc(
                        collection(db, 'artifacts', appId, 'collaborators'),
                        collaboratorDoc
                    );

                    // Enviar email de convite
                    try {
                        await emailjs.send(
                            "service_xh93ndo",
                            "template_akjxe6i",
                            {
                                to_email: email,
                                subject: `🎯 Convite para colaborar no escritório de ${user.email}`,
                                message: `Você foi convidado por ${user.email} para colaborar no escritório.`,
                                invite_link: window.location.href,
                                owner_name: user.email.split('@')[0]
                            }
                        );
                    } catch (emailError) {
                        console.log('Email não enviado, mas convite foi criado:', emailError);
                    }

                    showToast(`Convite enviado para ${email}`, 'success');
                    return true;
                } catch (error) {
                    console.error('Erro ao adicionar colaborador:', error);
                    showToast('Erro ao enviar convite: ' + error.message, 'error');
                    return false;
                }
            },

            async listCollaborators() {
                try {
                    const user = auth.currentUser;
                    if (!user) {
                        showToast('Usuário não autenticado', 'error');
                        return [];
                    }

                    const collaboratorsRef = collection(db, 'artifacts', appId, 'collaborators');
                    const q = query(collaboratorsRef, where('ownerId', '==', user.uid));
                    const snapshot = await getDocs(q);

                    return snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data(),
                        invitedAtFormatted: doc.data().invitedAt?.toDate?.().toLocaleDateString('pt-BR') || 'N/A'
                    }));
                } catch (error) {
                    console.error('Erro ao listar colaboradores:', error);
                    showToast('Erro ao carregar colaboradores', 'error');
                    return [];
                }
            },

            async updateCollaborator(collaboratorId, updates) {
                try {
                    const user = auth.currentUser;
                    if (!user) return false;

                    const collabRef = doc(db, 'artifacts', appId, 'collaborators', collaboratorId);
                    await updateDoc(collabRef, {
                        ...updates,
                        updatedAt: serverTimestamp()
                    });

                    showToast('Permissões atualizadas', 'success');
                    return true;
                } catch (error) {
                    console.error('Erro ao atualizar colaborador:', error);
                    showToast('Erro ao atualizar', 'error');
                    return false;
                }
            },

            async removeCollaborator(collaboratorId) {
                try {
                    const user = auth.currentUser;
                    if (!user) return false;

                    const collabRef = doc(db, 'artifacts', appId, 'collaborators', collaboratorId);
                    await deleteDoc(collabRef);

                    showToast('Colaborador removido', 'success');
                    return true;
                } catch (error) {
                    console.error('Erro ao remover colaborador:', error);
                    showToast('Erro ao remover', 'error');
                    return false;
                }
            },

            async getMyPermissions() {
                try {
                    const user = auth.currentUser;
                    if (!user) return null;

                    // Se é o dono, tem todas as permissões
                    if (user.email === currentUser?.email) {
                        return { permissionLevel: 'owner', canEdit: true, canDelete: true, canInvite: true };
                    }

                    const collaboratorsRef = collection(db, 'artifacts', appId, 'collaborators');
                    const q = query(
                        collaboratorsRef,
                        where('email', '==', user.email),
                        where('status', '==', 'active')
                    );
                    const snapshot = await getDocs(q);

                    if (snapshot.empty) return null;

                    const data = snapshot.docs[0].data();
                    return {
                        permissionLevel: data.permissionLevel,
                        canEdit: ['editor', 'admin'].includes(data.permissionLevel),
                        canDelete: data.permissionLevel === 'admin',
                        canInvite: data.permissionLevel === 'admin'
                    };
                } catch (error) {
                    console.error('Erro ao obter permissões:', error);
                    return null;
                }
            },

            // NOVA FUNÇÃO: Aceitar convite
            async acceptInvite(inviteId) {
                try {
                    const user = auth.currentUser;
                    if (!user) return false;

                    const inviteRef = doc(db, 'artifacts', appId, 'collaborators', inviteId);
                    await updateDoc(inviteRef, {
                        status: 'active',
                        acceptedAt: serverTimestamp(),
                        acceptedBy: user.email
                    });

                    showToast('Convite aceito! Agora você pode colaborar neste escritório.', 'success');
                    return true;
                } catch (error) {
                    console.error('Erro ao aceitar convite:', error);
                    showToast('Erro ao aceitar convite', 'error');
                    return false;
                }
            },

            // NOVA FUNÇÃO: Listar meus convites recebidos
            async listMyInvites() {
                try {
                    const user = auth.currentUser;
                    if (!user) return [];

                    const collaboratorsRef = collection(db, 'artifacts', appId, 'collaborators');
                    const q = query(
                        collaboratorsRef,
                        where('email', '==', user.email),
                        where('status', '==', 'pending')
                    );

                    const snapshot = await getDocs(q);
                    return snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data(),
                        invitedAtFormatted: doc.data().invitedAt?.toDate?.().toLocaleDateString('pt-BR') || 'N/A'
                    }));
                } catch (error) {
                    console.error('Erro ao listar convites:', error);
                    return [];
                }
            },

            // NOVA FUNÇÃO: Listar workspaces acessíveis
            async listAccessibleWorkspaces() {
                try {
                    const user = auth.currentUser;
                    if (!user) return [];

                    // 1. Workspace Próprio
                    const workspaces = [{
                        ownerId: user.uid,
                        ownerEmail: user.email,
                        name: 'Meu Escritório',
                        isOwner: true,
                        permission: 'owner'
                    }];

                    // 2. Workspaces Compartilhados (onde sou colaborador ativo)
                    const collaboratorsRef = collection(db, 'artifacts', appId, 'collaborators');
                    const q = query(
                        collaboratorsRef,
                        where('email', '==', user.email),
                        where('status', '==', 'active')
                    );

                    const snapshot = await getDocs(q);
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        workspaces.push({
                            ownerId: data.ownerId,
                            ownerEmail: data.ownerEmail,
                            name: `Escritório de ${data.ownerEmail.split('@')[0]}`,
                            isOwner: false,
                            permission: data.permissionLevel
                        });
                    });

                    window.availableWorkspaces = workspaces;
                    return workspaces;
                } catch (error) {
                    console.error('Erro ao listar workspaces:', error);
                    return [];
                }
            },

            // NOVA FUNÇÃO: Trocar de Workspace
            async switchWorkspace(ownerId, name) {
                if (window.currentWorkspaceOwnerId === ownerId) return;

                // Salvar estado
                window.currentWorkspaceOwnerId = ownerId;
                window.currentWorkspaceName = name;

                // Mostrar feedback visual
                const appScreen = document.getElementById('app-screen');
                appScreen.style.opacity = '0.5';
                showToast(`Alternando para ${name}...`, 'info');

                // Limpar listeners antigos
                if (unsubTasks) unsubTasks();
                if (unsubCompanies) unsubCompanies();
                if (unsubPins) unsubPins();
                if (unsubNotes) unsubNotes();

                // Recarregar dados do novo workspace
                setTimeout(() => {
                    subscribeData();
                    updateHeaderLayout(); // Atualizar cabeçalho com novo nome
                    appScreen.style.opacity = '1';
                    showToast(`Você está agora em: ${name}`, 'success');
                }, 500);
            }
        };


        const AuditLogger = {
            async logAction(action, entityType, entityId, changes, previousData = null, additionalInfo = {}) {
                try {
                    const user = auth.currentUser;
                    if (!user) return;

                    const auditLog = {
                        userId: user.uid,
                        userEmail: user.email,
                        userName: user.displayName || user.email.split('@')[0],
                        action: action, // 'create', 'update', 'delete', 'view', 'share', 'invite'
                        entityType: entityType, // 'task', 'company', 'note', 'pin', 'collaborator'
                        entityId: entityId,
                        changes: changes, // { field: { old: 'valor', new: 'valor' } }
                        previousData: previousData,
                        timestamp: serverTimestamp(),
                        workspaceId: appId,
                        userAgent: navigator.userAgent,
                        ...additionalInfo
                    };

                    // Log local para debug
                    console.log(`📝 Audit Log: ${action} ${entityType} by ${user.email}`);


                    // Salvar no Firestore
                    const logRef = await addDoc(
                        collection(db, 'artifacts', appId, 'audit_logs'),
                        auditLog
                    );

                    // Atualizar o documento original com info de quem editou
                    await this.updateEntityWithAuditInfo(entityType, entityId, user);

                    return logRef.id;
                } catch (error) {
                    console.error('❌ Erro ao registrar log:', error);
                    // Fallback: armazenar localmente se falhar
                    this.storeLocally(action, entityType, entityId, changes, error);
                }
            },

            async updateEntityWithAuditInfo(entityType, entityId, user) {
                try {
                    const updateData = {
                        lastUpdatedBy: user.email,
                        lastUpdatedAt: serverTimestamp(),
                        updatedByUserId: user.uid
                    };

                    let entityRef;
                    switch (entityType) {
                        case 'task':
                            entityRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'tasks', entityId);
                            break;
                        case 'company':
                            entityRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'companies', entityId);
                            break;
                        case 'note':
                            entityRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'notes', entityId);
                            break;
                        case 'pin':
                            entityRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'pins', entityId);
                            break;
                        default:
                            return;
                    }

                    await updateDoc(entityRef, updateData);
                } catch (error) {
                    console.error('Erro ao atualizar entidade com info de auditoria:', error);
                }
            },

            async autoLogUpdate(entityType, entityId, oldData, newData) {
                const changes = {};

                // Comparar cada campo
                Object.keys(newData).forEach(key => {
                    const oldVal = oldData ? oldData[key] : undefined;
                    const newVal = newData[key];

                    // Comparação profunda
                    if (JSON.stringify(oldVal) !== JSON.stringify(newVal)) {
                        changes[key] = {
                            old: oldVal,
                            new: newVal,
                            changedAt: new Date().toISOString()
                        };
                    }
                });

                if (Object.keys(changes).length > 0) {
                    await this.logAction('update', entityType, entityId, changes, oldData);
                }

                return changes;
            },

            async getEntityHistory(entityType, entityId, limit = 20) {
                try {
                    const historyRef = collection(db, 'artifacts', appId, 'audit_logs');
                    const q = query(
                        historyRef,
                        where('entityType', '==', entityType),
                        where('entityId', '==', entityId),
                        orderBy('timestamp', 'desc'),
                        limit(limit)
                    );

                    const snapshot = await getDocs(q);
                    return snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data(),
                        timestampFormatted: doc.data().timestamp?.toDate?.().toLocaleString('pt-BR') || 'N/A'
                    }));
                } catch (error) {
                    console.error('Erro ao obter histórico:', error);
                    return [];
                }
            },

            storeLocally(action, entityType, entityId, changes, error) {
                try {
                    const localLogs = JSON.parse(localStorage.getItem('audit_logs_pending') || '[]');
                    localLogs.push({
                        action,
                        entityType,
                        entityId,
                        changes,
                        error: error.message,
                        timestamp: new Date().toISOString(),
                        userEmail: currentUser?.email || 'unknown'
                    });

                    localStorage.setItem('audit_logs_pending', JSON.stringify(localLogs.slice(-50))); // Limitar a 50 logs
                } catch (e) {
                    console.error('Erro ao salvar log local:', e);
                }
            },

            async retryPendingLogs() {
                try {
                    const pendingLogs = JSON.parse(localStorage.getItem('audit_logs_pending') || '[]');
                    if (pendingLogs.length === 0) return;

                    for (const log of pendingLogs) {
                        try {
                            await this.logAction(log.action, log.entityType, log.entityId, log.changes);
                        } catch (error) {
                            console.error('Falha ao reprocessar log pendente:', error);
                        }
                    }

                    // Limpar logs processados
                    localStorage.removeItem('audit_logs_pending');
                } catch (error) {
                    console.error('Erro ao reprocessar logs pendentes:', error);
                }
            }
        };

        const RealTimeCollaboration = {
            activeUsers: new Map(),
            editingLocks: new Map(),

            async init() {
                if (!currentUser) return;

                // Subscrever para usuários ativos
                await this.subscribeToActiveUsers();

                // Subscrever para bloqueios de edição
                await this.subscribeToEditingLocks();

                // Iniciar heartbeat
                this.startHeartbeat();

                // Reprocessar logs pendentes
                setTimeout(() => AuditLogger.retryPendingLogs(), 5000);
            },

            async subscribeToActiveUsers() {
                const activeUsersRef = collection(db, 'artifacts', appId, 'active_users');
                const userDocRef = doc(activeUsersRef, currentUser.uid);

                // Marcar como ativo
                await setDoc(userDocRef, {
                    userId: currentUser.uid,
                    userEmail: currentUser.email,
                    lastSeen: serverTimestamp(),
                    status: 'online',
                    workspaceId: appId
                }, { merge: true });

                // Observar outros usuários
                onSnapshot(activeUsersRef, (snapshot) => {
                    this.activeUsers.clear();
                    snapshot.forEach(doc => {
                        if (doc.id !== currentUser.uid) {
                            const data = doc.data();
                            this.activeUsers.set(doc.id, {
                                ...data,
                                isOnline: data.status === 'online',
                                lastSeenFormatted: data.lastSeen?.toDate?.().toLocaleTimeString('pt-BR') || 'offline'
                            });
                        }
                    });

                    this.updateActiveUsersUI();
                });

                // Cleanup ao sair
                window.addEventListener('beforeunload', async () => {
                    await updateDoc(userDocRef, { status: 'offline' });
                });
            },

            async subscribeToEditingLocks() {
                const locksRef = collection(db, 'artifacts', appId, 'editing_locks');
                const q = query(locksRef, where('workspaceId', '==', appId));

                onSnapshot(q, (snapshot) => {
                    this.editingLocks.clear();
                    snapshot.forEach(doc => {
                        const lock = doc.data();
                        this.editingLocks.set(lock.entityId, {
                            ...lock,
                            isActive: lock.expiresAt?.toDate() > new Date()
                        });
                    });

                    this.updateEditingIndicators();
                });
            },

            async acquireLock(entityType, entityId) {
                try {
                    const lockRef = doc(collection(db, 'artifacts', appId, 'editing_locks'), `${entityType}_${entityId}`);

                    const lockData = {
                        entityType,
                        entityId,
                        userId: currentUser.uid,
                        userEmail: currentUser.email,
                        acquiredAt: serverTimestamp(),
                        expiresAt: new Date(Date.now() + 5 * 60000), // 5 minutos
                        workspaceId: appId
                    };

                    await setDoc(lockRef, lockData, { merge: true });

                    // Renovar lock periodicamente
                    const renewInterval = setInterval(async () => {
                        if (this.editingLocks.get(entityId)?.userId === currentUser.uid) {
                            await updateDoc(lockRef, { expiresAt: new Date(Date.now() + 5 * 60000) });
                        } else {
                            clearInterval(renewInterval);
                        }
                    }, 60000); // Renovar a cada minuto

                    return true;
                } catch (error) {
                    console.error('Erro ao adquirir lock:', error);
                    return false;
                }
            },

            async releaseLock(entityType, entityId) {
                try {
                    const lockRef = doc(db, 'artifacts', appId, 'editing_locks', `${entityType}_${entityId}`);
                    await deleteDoc(lockRef);
                    return true;
                } catch (error) {
                    console.error('Erro ao liberar lock:', error);
                    return false;
                }
            },

            startHeartbeat() {
                setInterval(async () => {
                    if (!currentUser) return;

                    const userDocRef = doc(db, 'artifacts', appId, 'active_users', currentUser.uid);
                    await updateDoc(userDocRef, {
                        lastSeen: serverTimestamp()
                    });
                }, 30000); // Atualizar a cada 30 segundos
            },

            updateActiveUsersUI() {
                const container = document.getElementById('active-users-indicator');
                if (!container) return;

                const onlineCount = Array.from(this.activeUsers.values()).filter(u => u.isOnline).length;

                if (onlineCount > 0) {
                    container.innerHTML = `
        <div style="display: flex; align-items: center; gap: 8px; padding: 4px 8px; 
                    background: var(--surface-variant); border-radius: 12px;">
          <div style="display: flex;">
            ${Array.from(this.activeUsers.values())
                            .filter(u => u.isOnline)
                            .slice(0, 3)
                            .map(user => `
                <div style="width: 24px; height: 24px; border-radius: 50%; 
                            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
                            color: white; display: flex; align-items: center; 
                            justify-content: center; font-size: 10px; font-weight: bold;
                            margin-left: -8px; border: 2px solid white;">
                  ${user.userEmail.charAt(0).toUpperCase()}
                </div>
              `).join('')}
          </div>
          <span style="font-size: 12px; color: var(--on-surface-variant);">
            +${onlineCount} online
          </span>
        </div>
      `;
                    container.classList.remove('hidden');
                } else {
                    container.classList.add('hidden');
                }
            },

            updateEditingIndicators() {
                // Remover indicadores antigos
                document.querySelectorAll('.editing-indicator').forEach(el => el.remove());

                // Adicionar novos indicadores
                this.editingLocks.forEach((lock, entityId) => {
                    if (lock.isActive && lock.userId !== currentUser.uid) {
                        const element = document.querySelector(`[data-task-id="${entityId}"], 
                                               [data-company-id="${entityId}"],
                                               [data-note-id="${entityId}"]`);
                        if (element) {
                            const indicator = document.createElement('div');
                            indicator.className = 'editing-indicator';
                            indicator.innerHTML = `
            <div style="position: absolute; top: -5px; right: -5px; z-index: 1000;
                        background: #f59e0b; color: white; padding: 2px 6px; 
                        border-radius: 10px; font-size: 10px; display: flex; 
                        align-items: center; gap: 3px; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">
              <i data-lucide="pencil" width="8"></i>
              ${lock.userEmail.split('@')[0]}
            </div>
          `;
                            element.style.position = 'relative';
                            element.appendChild(indicator);
                            lucide.createIcons();
                        }
                    }
                });
            },

            showCollaborationModal() {
                const modal = document.createElement('div');
                modal.className = 'modal-overlay';
                modal.innerHTML = `
      <div class="modal" style="max-width: 700px;">
        <div class="modal-header">
          <h3><i data-lucide="users"></i> Trabalho Colaborativo</h3>
          <button onclick="this.closest('.modal-overlay').remove()"><i data-lucide="x"></i></button>
        </div>
        <div class="modal-body">
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <!-- Usuários Online -->
            <div>
              <h4 style="margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                <i data-lucide="wifi" style="color: #10b981;"></i> Online Agora
              </h4>
              <div id="online-users-list" style="max-height: 200px; overflow-y: auto;">
                ${this.renderOnlineUsersList()}
              </div>
            </div>
            
            <!-- Atividade Recente -->
            <div>
              <h4 style="margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                <i data-lucide="activity"></i> Atividade Recente
              </h4>
              <div id="recent-activity" style="max-height: 200px; overflow-y: auto; font-size: 13px;">
                Carregando...
              </div>
            </div>
          </div>
          
          <!-- Documentos sendo editados -->
          <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--outline-variant);">
            <h4 style="margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
              <i data-lucide="lock" style="color: #f59e0b;"></i> Editando Agora
            </h4>
            <div id="editing-now" style="display: flex; flex-wrap: wrap; gap: 10px;">
              ${this.renderEditingNow()}
            </div>
          </div>
        </div>
      </div>
    `;

                document.body.appendChild(modal);

                // Carregar atividade recente
                setTimeout(() => this.loadRecentActivity(), 100);

                lucide.createIcons();
            },

            renderOnlineUsersList() {
                const onlineUsers = Array.from(this.activeUsers.values()).filter(u => u.isOnline);

                if (onlineUsers.length === 0) {
                    return '<p style="color: var(--text-sec); text-align: center; padding: 20px;">Ninguém online no momento</p>';
                }

                return onlineUsers.map(user => `
      <div style="display: flex; align-items: center; justify-content: space-between; 
                  padding: 8px 12px; background: var(--surface-variant); 
                  border-radius: 8px; margin-bottom: 8px;">
        <div style="display: flex; align-items: center; gap: 10px;">
          <div style="width: 32px; height: 32px; border-radius: 50%; 
                      background: linear-gradient(135deg, #3b82f6, #8b5cf6);
                      color: white; display: flex; align-items: center; 
                      justify-content: center; font-weight: bold;">
            ${user.userEmail.charAt(0).toUpperCase()}
          </div>
          <div>
            <div style="font-weight: 500;">${user.userEmail}</div>
            <div style="font-size: 11px; color: var(--text-sec);">
              Ativo agora
            </div>
          </div>
        </div>
        <div style="width: 8px; height: 8px; border-radius: 50%; background: #10b981;"></div>
      </div>
    `).join('');
            },

            renderEditingNow() {
                const activeLocks = Array.from(this.editingLocks.values())
                    .filter(lock => lock.isActive && lock.userId !== currentUser.uid)
                    .slice(0, 5);

                if (activeLocks.length === 0) {
                    return '<p style="color: var(--text-sec); text-align: center; width: 100%; padding: 10px;">Nenhuma edição em andamento</p>';
                }

                return activeLocks.map(lock => `
      <div style="flex: 1; min-width: 150px; padding: 12px; background: #fff8e1; 
                  border: 1px solid #f59e0b; border-radius: 8px;">
        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
          <i data-lucide="pencil" width="14" style="color: #f59e0b;"></i>
          <span style="font-weight: 600; font-size: 13px;">${lock.entityType}</span>
        </div>
        <div style="font-size: 12px; color: #666;">
          <div><strong>Editando:</strong> ${lock.userEmail.split('@')[0]}</div>
          <div style="margin-top: 4px; font-size: 11px;">
            ${new Date(lock.expiresAt?.toDate()).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })}
          </div>
        </div>
      </div>
    `).join('');
            },

            async loadRecentActivity() {
                try {
                    const activityRef = collection(db, 'artifacts', appId, 'audit_logs');
                    const q = query(
                        activityRef,
                        orderBy('timestamp', 'desc'),
                        limit(10)
                    );

                    const snapshot = await getDocs(q);
                    const activityList = document.getElementById('recent-activity');

                    if (snapshot.empty) {
                        activityList.innerHTML = '<p style="color: var(--text-sec); text-align: center;">Nenhuma atividade recente</p>';
                        return;
                    }

                    activityList.innerHTML = snapshot.docs.map(doc => {
                        const data = doc.data();
                        const icon = this.getActionIcon(data.action);
                        const color = this.getActionColor(data.action);
                        const time = data.timestamp?.toDate().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }) || 'Agora';

                        return `
          <div style="display: flex; align-items: center; gap: 10px; padding: 8px; 
                      border-bottom: 1px solid var(--surface-variant);">
            <div style="width: 24px; height: 24px; border-radius: 50%; background: ${color}20; 
                        display: flex; align-items: center; justify-content: center;">
              <i data-lucide="${icon}" width="12" style="color: ${color};"></i>
            </div>
            <div style="flex: 1;">
              <div style="font-size: 12px;">
                <strong>${data.userEmail?.split('@')[0]}</strong> ${this.getActionText(data.action)} 
                ${data.entityType}
              </div>
              <div style="font-size: 10px; color: var(--text-sec);">${time}</div>
            </div>
          </div>
        `;
                    }).join('');

                    lucide.createIcons();
                } catch (error) {
                    console.error('Erro ao carregar atividade:', error);
                }
            },

            getActionIcon(action) {
                const icons = {
                    'create': 'plus-circle',
                    'update': 'edit-2',
                    'delete': 'trash-2',
                    'view': 'eye',
                    'share': 'share-2',
                    'invite': 'user-plus'
                };
                return icons[action] || 'activity';
            },

            getActionColor(action) {
                const colors = {
                    'create': '#10b981',
                    'update': '#3b82f6',
                    'delete': '#ef4444',
                    'view': '#6b7280',
                    'share': '#8b5cf6',
                    'invite': '#ec4899'
                };
                return colors[action] || '#6b7280';
            },

            getActionText(action) {
                const texts = {
                    'create': 'criou',
                    'update': 'atualizou',
                    'delete': 'excluiu',
                    'view': 'visualizou',
                    'share': 'compartilhou',
                    'invite': 'convidou'
                };
                return texts[action] || 'realizou ação em';
            }
        };

        // ============================================
        // MODAL DE COLABORADORES COMPLETO
        // ============================================

        function initCollaboratorsModal() {
            const modal = document.createElement('div');
            modal.id = 'modal-collaborators';
            modal.className = 'modal-overlay hidden';
            modal.innerHTML = `
    <div class="modal" style="max-width: 800px;">
      <div class="modal-header">
        <h3><i data-lucide="users"></i> Gerenciar Colaboradores</h3>
        <button onclick="closeModals()"><i data-lucide="x"></i></button>
      </div>
      
      <div class="modal-body">
        <div style="margin-bottom: 32px;">
          <h4 style="margin-bottom: 12px; color: var(--primary);">👥 Colaboração em Tempo Real</h4>
          <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
            <div id="active-users-indicator" class="hidden"></div>
            <button onclick="RealTimeCollaboration.showCollaborationModal()" class="btn-main" style="padding: 8px 16px; font-size: 14px;">
              <i data-lucide="activity"></i> Ver Atividade
            </button>
            <button onclick="exportAuditLogs()" class="btn-cancel" style="padding: 8px 16px; font-size: 14px;">
              <i data-lucide="download"></i> Exportar Logs
            </button>
          </div>
        </div>
        
        <!-- Adicionar novo colaborador -->
        <div style="margin-bottom: 32px; padding: 20px; background: var(--surface-variant); border-radius: var(--radius-lg);">
          <h4 style="margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
            <i data-lucide="user-plus"></i> Convidar Novo Colaborador
          </h4>
          <div style="display: flex; gap: 12px; align-items: flex-end; flex-wrap: wrap;">
            <div style="flex: 1; min-width: 200px;">
              <label style="display: block; margin-bottom: 6px; font-size: 14px; color: var(--on-surface-variant);">
                E-mail do colaborador
              </label>
              <input type="email" id="collaborator-email" class="std-input" placeholder="colaborador@empresa.com">
            </div>
            
            <div style="width: 180px;">
              <label style="display: block; margin-bottom: 6px; font-size: 14px; color: var(--on-surface-variant);">
                Permissão
              </label>
              <select id="collaborator-permission" class="std-input">
                <option value="viewer">🔍 Somente leitura</option>
                <option value="editor" selected>✏️ Editor</option>
                <option value="admin">👑 Administrador</option>
              </select>
            </div>
            
            <button onclick="addNewCollaborator()" class="btn-main" style="height: 44px; padding: 0 20px;">
              <i data-lucide="send"></i> Enviar Convite
            </button>
          </div>
          
          <div style="margin-top: 16px; padding: 12px; background: rgba(59, 130, 246, 0.1); border-radius: 8px;">
            <div style="display: flex; align-items: flex-start; gap: 8px;">
              <i data-lucide="info" width="16" style="color: #3b82f6; margin-top: 2px;"></i>
              <div style="font-size: 13px; color: var(--on-surface-variant);">
                <strong>Permissões:</strong> 
                <span style="color: #3b82f6;">Visualizar</span> • 
                <span style="color: #10b981;">Editar</span> • 
                <span style="color: #ef4444;">Excluir</span> • 
                <span style="color: #8b5cf6;">Convidar</span>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Lista de colaboradores -->
        <div>
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
            <h4 style="display: flex; align-items: center; gap: 8px;">
              <i data-lucide="users"></i> Colaboradores
              <span id="collaborator-count" class="counter-badge" style="margin-left: 8px;">0</span>
            </h4>
            <button onclick="refreshCollaboratorsList()" class="icon-btn" title="Atualizar lista">
              <i data-lucide="refresh-cw" width="18"></i>
            </button>
          </div>
          
          <div id="collaborators-list" style="max-height: 300px; overflow-y: auto;">
            <div style="text-align: center; padding: 40px; color: var(--on-surface-variant);">
              <i data-lucide="users" width="48" style="opacity: 0.5; margin-bottom: 12px;"></i>
              <p>Nenhum colaborador convidado ainda.</p>
              <p style="font-size: 0.9rem; margin-top: 8px;">Convide alguém para começar a colaborar!</p>
            </div>
          </div>
        </div>
        
        <!-- Histórico de auditoria -->
        <div style="margin-top: 32px; padding-top: 24px; border-top: 1px solid var(--outline-variant);">
          <h4 style="margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
            <i data-lucide="history"></i> Histórico de Atividade Recente
          </h4>
          <div id="audit-history" style="max-height: 300px; overflow-y: auto;">
            <div style="text-align: center; padding: 20px; color: var(--on-surface-variant);">
              <i data-lucide="loader" width="20" class="loading-spinner"></i>
              <p style="margin-top: 8px;">Carregando histórico...</p>
            </div>
          </div>
        </div>
      </div>
      
      <div class="modal-footer">
        <button onclick="closeModals()" class="btn-cancel">Fechar</button>
        <button onclick="openAuditSettings()" class="btn-main">
          <i data-lucide="settings"></i> Configurações
        </button>
      </div>
    </div>
  `;

            document.body.appendChild(modal);
        }
        // Cores disponíveis para pins
        const PIN_COLORS = [
            '#ef4444', // Vermelho
            '#f59e0b', // Laranja
            '#10b981', // Verde
            '#3b82f6', // Azul
            '#8b5cf6', // Roxo
            '#ec4899', // Rosa
            '#6366f1', // Índigo
            '#14b8a6', // Turquesa
            '#84cc16', // Lima
            '#f97316', // Laranja escuro
            '#06b6d4', // Ciano
            '#8b5cf6'  // Violeta
        ];

        const TASK_TEMPLATES = {
            FISCAL: {
                SIMPLES: [
                    {
                        id: 'DAS_SIMPLES',
                        title: 'DAS - Simples Nacional',
                        obligation: 'DAS',
                        periodicity: 'MENSAL',
                        category: 'FISCAL',
                        description: 'Pagamento do Documento de Arrecadação do Simples Nacional - Anexo conforme atividade',
                        value: null,
                        deadlineDay: 20,
                        autoGenerate: true,
                        tags: ['imposto', 'federal', 'obrigatório'],
                        estimatedTime: 30, // minutos
                        instructions: 'Verificar anexo correto, calcular valor, gerar DAS no site do Simples Nacional'
                    }
                ],
                PRESUMIDO: [
                    {
                        id: 'IRPJ_PRESUMIDO',
                        title: 'IRPJ - Lucro Presumido',
                        obligation: 'IRPJ',
                        periodicity: 'TRIMESTRAL',
                        category: 'FISCAL',
                        description: 'Declaração do Imposto de Renda da Pessoa Jurídica - Trimestral',
                        value: null,
                        deadlineDay: 30,
                        autoGenerate: true,
                        tags: ['imposto', 'federal', 'trimestral'],
                        estimatedTime: 120,
                        instructions: 'Calcular presunção conforme atividade, preencir DCTF, pagar DARF'
                    },
                    {
                        id: 'PIS_COFINS_PRESUMIDO',
                        title: 'PIS/COFINS - Não Cumulativo',
                        obligation: 'PIS_COFINS',
                        periodicity: 'MENSAL',
                        category: 'FISCAL',
                        description: 'Contribuições PIS e COFINS - Regime não cumulativo',
                        value: null,
                        deadlineDay: 20,
                        autoGenerate: true,
                        estimatedTime: 90
                    }
                ],
                REAL: [
                    {
                        id: 'EFD_CONTRIB',
                        title: 'EFD Contribuições',
                        obligation: 'EFD',
                        periodicity: 'MENSAL',
                        category: 'FISCAL',
                        description: 'Escrituração Fiscal Digital de Contribuições',
                        value: null,
                        deadlineDay: 15,
                        autoGenerate: true,
                        estimatedTime: 180
                    }
                ]
            },
            TRABALHISTA: {
                default: [
                    {
                        id: 'GPS_FUNCIONARIOS',
                        title: 'GPS - Funcionários',
                        obligation: 'GPS',
                        periodicity: 'MENSAL',
                        category: 'TRABALHISTA',
                        description: 'Guia da Previdência Social para funcionários',
                        value: null,
                        deadlineDay: 20,
                        autoGenerate: true,
                        conditions: ['hasEmployees'],
                        estimatedTime: 45
                    },
                    {
                        id: 'FOLHA_PAGAMENTO',
                        title: 'Folha de Pagamento',
                        obligation: 'FOLHA',
                        periodicity: 'MENSAL',
                        category: 'TRABALHISTA',
                        description: 'Processamento completo da folha de pagamento',
                        value: null,
                        deadlineDay: 30,
                        autoGenerate: true,
                        conditions: ['hasEmployees'],
                        estimatedTime: 60
                    },
                    {
                        id: 'RAIS_ANUAL',
                        title: 'RAIS - Anual',
                        obligation: 'RAIS',
                        periodicity: 'ANUAL',
                        category: 'TRABALHISTA',
                        description: 'Relação Anual de Informações Sociais',
                        value: null,
                        deadlineDay: 31,
                        month: 1, // Janeiro
                        autoGenerate: true,
                        conditions: ['hasEmployees'],
                        estimatedTime: 120
                    }
                ]
            },
            CONTABIL: {
                default: [
                    {
                        id: 'BALANCO_MENSAL',
                        title: 'Balanço Mensal',
                        obligation: 'BALANCO',
                        periodicity: 'MENSAL',
                        category: 'CONTABIL',
                        description: 'Fechamento contábil mensal e conciliação bancária',
                        value: null,
                        deadlineDay: 10,
                        autoGenerate: true,
                        estimatedTime: 240
                    },
                    {
                        id: 'DRE_TRIMESTRAL',
                        title: 'DRE - Demonstrativo de Resultados',
                        obligation: 'DRE',
                        periodicity: 'TRIMESTRAL',
                        category: 'CONTABIL',
                        description: 'Demonstração do Resultado do Exercício',
                        value: null,
                        deadlineDay: 30,
                        autoGenerate: true,
                        estimatedTime: 180
                    }
                ]
            },
            MUNICIPAL: {
                default: [
                    {
                        id: 'ISS_MENSAL',
                        title: 'ISS - Municipal',
                        obligation: 'ISS',
                        periodicity: 'MENSAL',
                        category: 'MUNICIPAL',
                        description: 'Imposto Sobre Serviços - Prefeitura Municipal',
                        value: null,
                        deadlineDay: 15,
                        autoGenerate: true,
                        estimatedTime: 30
                    }
                ]
            }
        };

        // ============================================
        // FUNÇÕES PARA PRESSÃO LONGA (2 SEGUNDOS)
        // ============================================

        // Inicializar detecção de pressão longa em todos os cards
        function initLongPress() {
            document.addEventListener('mousedown', startPressTimer);
            document.addEventListener('touchstart', startPressTimer);

            document.addEventListener('mouseup', cancelPressTimer);
            document.addEventListener('mouseleave', cancelPressTimer);
            document.addEventListener('touchend', cancelPressTimer);
            document.addEventListener('touchcancel', cancelPressTimer);
        }

        // Iniciar timer para pressão longa
        function startPressTimer(e) {
            // Encontrar o card mais próximo
            const card = e.target.closest('.card, .company-card');
            if (!card) return;

            currentPressingCard = card;

            pressTimer = setTimeout(() => {
                showCardNote(card);
            }, 2000); // 2 segundos

            // Adicionar efeito visual
            card.classList.add('pressing');
        }

        // Cancelar timer se soltar antes de 2 segundos
        function cancelPressTimer(e) {
            if (pressTimer) {
                clearTimeout(pressTimer);
                pressTimer = null;
            }

            if (currentPressingCard) {
                currentPressingCard.classList.remove('pressing');
                currentPressingCard = null;
            }
        }


        // Mostrar modal com nota do card
        function showCardNote(card) {
            currentPressingCard = null;
            card.classList.remove('pressing');

            // Verificar se é card de tarefa ou empresa
            if (card.classList.contains('card')) {
                // É uma tarefa
                const taskId = card.querySelector('.check-btn')?.getAttribute('onclick')?.match(/'([^']+)'/)?.[1];
                if (taskId) {
                    const task = allTasks.find(t => t.id === taskId);
                    if (task) openCardNoteModal(task, 'task');
                }
            } else if (card.classList.contains('company-card')) {
                // É uma empresa
                const companyId = card.querySelector('.icon-btn')?.getAttribute('onclick')?.match(/'([^']+)'/)?.[1];
                if (companyId) {
                    const company = allCompanies.find(c => c.id === companyId);
                    if (company) openCardNoteModal(company, 'company');
                }
            }
        }

        // Abrir modal de nota do card
        function openCardNoteModal(item, type) {
            currentNoteItem = { item, type };

            const modal = document.getElementById('modal-card-note');
            const contentDiv = document.getElementById('card-note-content');

            let html = '';

            if (type === 'task') {
                const task = item;
                const company = allCompanies.find(c => c.id === task.companyId);

                html = `
                <div class="note-section">
                    <div class="note-section-title">
                        <i data-lucide="info" width="14"></i> Informações da Tarefa
                    </div>
                    <div class="note-section-content">
                        <p><strong>Título:</strong> ${escapeHtml(task.title)}</p>
                        <p><strong>Empresa:</strong> ${escapeHtml(company?.name || 'Não vinculada')}</p>
                        <p><strong>Categoria:</strong> ${task.category || 'Não definida'}</p>
                        <p><strong>Obrigação:</strong> ${task.obligation || 'Não especificada'}</p>
                        ${task.deadline ? `<p><strong>Prazo:</strong> ${new Date(task.deadline).toLocaleDateString('pt-BR')}</p>` : ''}
                        ${task.description ? `<p><strong>Descrição:</strong> ${escapeHtml(task.description)}</p>` : ''}
                        ${task.value ? `<p><strong>Valor:</strong> R$ ${parseFloat(task.value).toFixed(2)}</p>` : ''}
                        ${task.paymentStatus ? `<p><strong>Status Pagamento:</strong> ${task.paymentStatus}</p>` : ''}
                    </div>
                </div>
            `;
            } else if (type === 'company') {
                const company = item;

                html = `
                <div class="note-section">
                    <div class="note-section-title">
                        <i data-lucide="building-2" width="14"></i> Informações da Empresa
                    </div>
                    <div class="note-section-content">
                        <p><strong>Nome:</strong> ${escapeHtml(company.name)}</p>
                        ${company.cnpj ? `<p><strong>CNPJ:</strong> ${escapeHtml(company.cnpj)}</p>` : ''}
                        ${company.type ? `<p><strong>Tipo:</strong> ${company.type}</p>` : ''}
                        ${company.regime ? `<p><strong>Regime:</strong> ${company.regime}</p>` : ''}
                        ${company.cnae ? `<p><strong>CNAE:</strong> ${company.cnae}</p>` : ''}
                        ${company.phone ? `<p><strong>Telefone:</strong> ${escapeHtml(company.phone)}</p>` : ''}
                        ${company.email ? `<p><strong>E-mail:</strong> ${escapeHtml(company.email)}</p>` : ''}
                        ${company.responsible ? `<p><strong>Responsável:</strong> ${escapeHtml(company.responsible)}</p>` : ''}
                        ${company.address ? `<p><strong>Endereço:</strong> ${escapeHtml(company.address)}</p>` : ''}
                    </div>
                </div>
            `;
            } else if (type === 'note') {
                const note = item;
                html = `
                <div class="note-section">
                    <div class="note-section-title">
                        <i data-lucide="file-text" width="14"></i> Visualização da Nota
                    </div>
                    <div class="note-section-content">
                        <p><strong>Título:</strong> ${escapeHtml(note.title)}</p>
                        ${note.reminder ? `<p><strong>Lembrete:</strong> ${new Date(note.reminder).toLocaleString()}</p>` : ''}
                        <hr style="margin: 10px 0; border: 0; border-top: 1px solid var(--border);">
                        <p style="white-space: pre-wrap;">${escapeHtml(note.content)}</p>
                    </div>
                </div>
                <div style="text-align: center; margin-top: 15px;">
                     <button onclick="closeModals(); openNoteModal({id: '${note.id}', title: '${escapeHtml(note.title).replace(/'/g, "\\'")}', content: '${escapeHtml(note.content).replace(/'/g, "\\'").replace(/\n/g, "\\n")}', reminder: '${note.reminder || ''}', emailNotify: ${note.emailNotify || false}})" class="btn-main" style="width: auto; display: inline-flex;">
                        <i data-lucide="pencil" width="14"></i> Editar Nota Completa
                     </button>
                </div>
            `;
            } else if (type === 'pin') {
                const pin = item;
                html = `
                <div class="note-section">
                    <div class="note-section-title">
                         <div style="width: 12px; height: 12px; border-radius: 50%; background-color: ${pin.color || '#3b82f6'}; display: inline-block; margin-right: 6px;"></div>
                         Etiqueta
                    </div>
                    <div class="note-section-content">
                        <p><strong>Título:</strong> ${escapeHtml(pin.title)}</p>
                        ${pin.comment ? `<hr style="margin: 10px 0; border: 0; border-top: 1px solid var(--border);"><p style="white-space: pre-wrap;">${escapeHtml(pin.comment)}</p>` : ''}
                        <p style="margin-top: 10px; font-size: 0.8rem; color: var(--text-sec);">Criado em: ${new Date(pin.createdAt?.seconds * 1000).toLocaleDateString('pt-BR')}</p>
                    </div>
                </div>
                <div style="text-align: center; margin-top: 15px;">
                     <button onclick="closeModals(); openPinModal('${pin.targetType}', '${pin.targetId}', '${pin.id}')" class="btn-main" style="width: auto; display: inline-flex;">
                        <i data-lucide="pencil" width="14"></i> Editar Etiqueta
                     </button>
                </div>
            `;
            }

            // Adicionar seção de pins/etiquetas (comum a todos, exceto note e pin que é o próprio item)
            if (type !== 'note' && type !== 'pin') { // Notas ainda não têm pins implementados na UI de criação, mas o sistema suporta. Por enquanto, ocultar para notes se não tiver.
                const pins = allPins.filter(pin =>
                    pin.targetType === type && pin.targetId === item.id
                );

                if (pins.length > 0) {
                    html += `
                    <div class="note-section">
                        <div class="note-section-title">
                            <i data-lucide="tag" width="14"></i> Etiquetas (${pins.length})
                        </div>
                        <div class="pins-list">
                            ${pins.map(pin => `
                                <div class="pin-item" style="border-left-color: ${pin.color || '#3b82f6'}">
                                    <div class="pin-color-dot" style="background: ${pin.color || '#3b82f6'}"></div>
                                    <div class="pin-content">
                                        <div class="pin-title">${escapeHtml(pin.title)}</div>
                                        ${pin.comment ? `<div class="pin-comment">${escapeHtml(pin.comment)}</div>` : ''}
                                        <div class="pin-date">${new Date(pin.createdAt?.seconds * 1000).toLocaleDateString('pt-BR')}</div>
                                    </div>
                                    <button class="icon-btn" onclick="editPin('${pin.id}')" style="padding: 4px;">
                                        <i data-lucide="edit" width="14"></i>
                                    </button>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
                }

                // Adicionar botão para nova etiqueta (apenas para tasks e companies por enquanto)
                html += `
                <div style="margin-top: 20px; text-align: center;">
                    <button onclick="openPinModal('${type}', '${item.id}')" class="btn-main" style="width: auto; padding: 10px 20px;">
                        <i data-lucide="tag" width="16"></i> Adicionar Etiqueta
                    </button>
                </div>
            `;
            }

            contentDiv.innerHTML = html;
            modal.classList.remove('hidden');
            lucide.createIcons();
        }

        // ============================================
        // FUNÇÕES PARA PINS/ETIQUETAS
        // ============================================

        // Inicializar sistema de pins no Firestore
        function initPinsSystem() {
            if (!currentUser) return;

            const pinsRef = collection(db, 'artifacts', appId, 'users', window.currentWorkspaceOwnerId, 'pins');
            unsubPins = onSnapshot(pinsRef, (snap) => {
                allPins = [];
                snap.forEach(doc => allPins.push({ id: doc.id, ...doc.data() }));

                // Atualizar pins nos cards
                updateCardsPins();
            });
        }

        // Atualizar pins visíveis nos cards
        function updateCardsPins() {
            // Atualizar pins nas tarefas
            document.querySelectorAll('.card').forEach(card => {
                updateCardPins(card, 'task');
            });

            // Atualizar pins nas empresas
            document.querySelectorAll('.company-card').forEach(card => {
                updateCardPins(card, 'company');
            });
        }

        // Atualizar pins de um card específico
        // FUNÇÃO CORRIGIDA - SEM ESTILOS INLINE
        function updateCardPins(card, type) {
            // Remover pins existentes
            const existingPins = card.querySelector('.card-pins');
            if (existingPins) existingPins.remove();

            // Extrair ID do item
            const itemId = extractItemIdFromCard(card, type);
            if (!itemId) return;

            // Filtrar pins deste item
            const itemPins = allPins.filter(pin =>
                pin.targetType === type && pin.targetId === itemId
            );

            if (itemPins.length === 0) return;

            // Criar container de pins
            const pinsContainer = document.createElement('div');
            pinsContainer.className = 'card-pins';

            // Ordenar pins por prioridade
            const sortedPins = [...itemPins].sort((a, b) => {
                const priorityOrder = { high: 3, medium: 2, low: 1 };
                const priorityDiff = (priorityOrder[b.priority] || 2) - (priorityOrder[a.priority] || 2);
                if (priorityDiff !== 0) return priorityDiff;
                return (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0);
            });

            // Adicionar pins (máximo 6)
            sortedPins.slice(0, 6).forEach(pin => {
                const pinBadge = document.createElement('div');
                pinBadge.className = 'pin-badge';
                pinBadge.style.background = pin.color;
                pinBadge.setAttribute('data-pin-id', pin.id);
                pinBadge.setAttribute('data-title', pin.title);

                // Adicionar ícone de prioridade
                if (pin.priority === 'high') {
                    pinBadge.innerHTML = '<i data-lucide="alert-triangle" width="10" style="color: white;"></i>';
                } else if (pin.priority === 'medium') {
                    pinBadge.innerHTML = '<i data-lucide="clock" width="10" style="color: white;"></i>';
                }

                // Evento de clique para editar
                pinBadge.onclick = (e) => {
                    e.stopPropagation();
                    openPinModal(type, itemId, pin.id);
                };

                pinsContainer.appendChild(pinBadge);
            });

            // Garantir que o card tenha position relative
            if (window.getComputedStyle(card).position === 'static') {
                card.style.position = 'relative';
            }

            // Inserir pins no início do card
            card.insertBefore(pinsContainer, card.firstChild);
            lucide.createIcons();
        }

        function darkenColor(color, percent) {
            let R = parseInt(color.substring(1, 3), 16);
            let G = parseInt(color.substring(3, 5), 16);
            let B = parseInt(color.substring(5, 7), 16);

            R = parseInt(R * (100 - percent) / 100);
            G = parseInt(G * (100 - percent) / 100);
            B = parseInt(B * (100 - percent) / 100);

            R = (R < 255) ? R : 255;
            G = (G < 255) ? G : 255;
            B = (B < 255) ? B : 255;

            const RR = ((R.toString(16).length == 1) ? "0" + R.toString(16) : R.toString(16));
            const GG = ((G.toString(16).length == 1) ? "0" + G.toString(16) : G.toString(16));
            const BB = ((B.toString(16).length == 1) ? "0" + B.toString(16) : B.toString(16));

            return "#" + RR + GG + BB;
        }

        function extractItemIdFromCard(card, type) {
            if (type === 'task') {
                // Método 1: Atributo data-task-id
                if (card.hasAttribute('data-task-id')) {
                    return card.getAttribute('data-task-id');
                }

                // Método 2: Extrair do botão de toggle
                const toggleBtn = card.querySelector('.check-btn');
                if (toggleBtn) {
                    const onclickAttr = toggleBtn.getAttribute('onclick');
                    if (onclickAttr) {
                        const match = onclickAttr.match(/toggleTask\s*\(\s*'([^']+)'/);
                        if (match) return match[1];
                    }
                }

                // Método 3: Buscar por título
                const taskTitle = card.querySelector('.card-title')?.textContent?.trim();
                if (taskTitle) {
                    const task = allTasks.find(t => t.title === taskTitle);
                    if (task) return task.id;
                }
            }
            else if (type === 'company') {
                // Método 1: Atributo data-company-id
                if (card.hasAttribute('data-company-id')) {
                    return card.getAttribute('data-company-id');
                }

                // Método 2: Extrair do JSON no onclick
                const editBtn = card.querySelector('.icon-btn[onclick*="openCompanyModal"]');
                if (editBtn) {
                    const onclickAttr = editBtn.getAttribute('onclick');
                    const jsonMatch = onclickAttr.match(/openCompanyModal\s*\(\s*({[^}]+})/);
                    if (jsonMatch) {
                        try {
                            let jsonStr = jsonMatch[1]
                                .replace(/&#39;/g, "'")
                                .replace(/&quot;/g, '"');
                            const companyData = JSON.parse(jsonStr);
                            return companyData.id;
                        } catch (e) {
                            console.warn('Erro ao parsear JSON:', e);
                        }
                    }
                }

                // Método 3: Buscar por nome
                const companyName = card.querySelector('h4')?.textContent?.split('<')[0]?.trim();
                if (companyName) {
                    const company = allCompanies.find(c => c.name === companyName);
                    if (company) return company.id;
                }
            }

            return null;
        }

        // Função para atualizar todos os pins
        function updateAllPins() {
            // Atualizar pins em tarefas
            document.querySelectorAll('.card:not(.note-card)').forEach(card => {
                updateCardPins(card, 'task');
            });

            // Atualizar pins em empresas
            document.querySelectorAll('.company-card').forEach(card => {
                updateCardPins(card, 'company');
            });

            // Atualizar pins em notas
            document.querySelectorAll('.note-card').forEach(card => {
                updateCardPins(card, 'note');
            });
        }



        // Função auxiliar para extrair ID do card
        function getCardItemId(card, type) {
            if (type === 'task') {
                // Tentar múltiplas formas de encontrar o ID da tarefa
                const checkBtn = card.querySelector('.check-btn');
                if (checkBtn) {
                    const onclickAttr = checkBtn.getAttribute('onclick');
                    if (onclickAttr) {
                        // Padrão: toggleTask('ID', ...)
                        const match = onclickAttr.match(/toggleTask\s*\(\s*'([^']+)'/);
                        if (match) return match[1];

                        // Padrão alternativo: event.stopPropagation(); toggleTask('ID', ...)
                        const match2 = onclickAttr.match(/toggleTask\s*\(\s*'([^']+)'/);
                        if (match2) return match2[1];
                    }
                }

                // Tentar pelo botão de delete
                const deleteBtn = card.querySelector('.delete-btn');
                if (deleteBtn) {
                    const onclickAttr = deleteBtn.getAttribute('onclick');
                    if (onclickAttr) {
                        const match = onclickAttr.match(/confirmDeleteTask\s*\(\s*'([^']+)'/);
                        if (match) return match[1];
                    }
                }
            }
            else if (type === 'company') {
                // Para empresas, precisamos extrair do JSON no onclick
                const editBtns = card.querySelectorAll('.icon-btn');
                for (const btn of editBtns) {
                    const onclickAttr = btn.getAttribute('onclick');
                    if (onclickAttr && onclickAttr.includes('openCompanyModal')) {
                        // Extrair o JSON da empresa
                        const jsonMatch = onclickAttr.match(/openCompanyModal\s*\(\s*({[^}]+})/);
                        if (jsonMatch) {
                            try {
                                // Limpar e parsear o JSON
                                let jsonStr = jsonMatch[1];
                                // Substituir entidades HTML
                                jsonStr = jsonStr.replace(/&#39;/g, "'").replace(/&quot;/g, '"');
                                const companyData = JSON.parse(jsonStr);
                                return companyData.id;
                            } catch (e) {
                                console.warn('Erro ao parsear JSON da empresa:', e);
                                // Tentar método alternativo: procurar por ID em atributos de data
                                const dataId = card.getAttribute('data-company-id');
                                if (dataId) return dataId;
                            }
                        }
                    }
                }
            }

            return null;
        }

        const ReportSystem = {

            openReportInNewTab: function (htmlContent) {
                const newWindow = window.open();
                newWindow.document.write(htmlContent);
                newWindow.document.close();
            },

            generateWeeklyReport: async function () {
                try {
                    const startDate = new Date();
                    startDate.setDate(startDate.getDate() - 7);

                    const reportData = await this.gatherReportData(startDate, new Date());
                    const reportHTML = this.formatReportHTML(reportData, 'weekly');

                    // Mostrar preview
                    this.showReportPreview(reportHTML, 'weekly');

                } catch (error) {
                    console.error('Erro ao gerar relatório:', error);
                    showToast('Erro ao gerar relatório', 'error');
                }
            },

            // Gerar relatório mensal
            generateMonthlyReport: async function () {
                try {
                    const startDate = new Date();
                    startDate.setMonth(startDate.getMonth() - 1);

                    const reportData = await this.gatherReportData(startDate, new Date());
                    const reportHTML = this.formatReportHTML(reportData, 'monthly');

                    // Mostrar preview
                    this.showReportPreview(reportHTML, 'monthly');

                } catch (error) {
                    console.error('Erro ao gerar relatório:', error);
                    showToast('Erro ao gerar relatório', 'error');
                }
            },

            // Mostrar preview do relatório
            showReportPreview: function (htmlContent, type) {
                const modal = document.createElement('div');
                modal.className = 'modal-overlay';
                modal.innerHTML = `
            <div class="modal" style="max-width: 800px; max-height: 90vh;">
                <div class="modal-header">
                    <h3>📊 Visualização do Relatório ${type === 'weekly' ? 'Semanal' : 'Mensal'}</h3>
                    <button onclick="this.closest('.modal-overlay').remove()">
                        <i data-lucide="x"></i>
                    </button>
                </div>
                <div class="modal-body" style="max-height: 70vh; overflow-y: auto; padding: 0;">
                    <iframe srcdoc="${htmlContent.replace(/"/g, '&quot;')}" 
                            style="width: 100%; height: 600px; border: none;"></iframe>
                </div>
                <div class="modal-footer">
                    <button onclick="this.closest('.modal-overlay').remove()" 
                            style="color: var(--text-sec); font-weight: 600; padding: 0 15px;">
                        Fechar
                    </button>
                    <button onclick="window.open('data:text/html;charset=utf-8,${encodeURIComponent(htmlContent)}')" 
                            class="btn-main" style="width: auto; padding: 10px 24px;">
                        <i data-lucide="download"></i> Baixar HTML
                    </button>
                    <button onclick="ReportSystem.sendToPrinter('${encodeURIComponent(htmlContent)}')" 
                            class="btn-main" style="width: auto; padding: 10px 24px;">
                        <i data-lucide="printer"></i> Imprimir
                    </button>
                </div>
            </div>
        `;

                document.body.appendChild(modal);
                lucide.createIcons();
            },

            // Função para imprimir relatório
            sendToPrinter: function (htmlContent) {
                const printWindow = window.open('', '_blank');
                printWindow.document.write(decodeURIComponent(htmlContent));
                printWindow.document.close();
                printWindow.focus();
                setTimeout(() => {
                    printWindow.print();
                    printWindow.close();
                }, 500);
            },
            // Gerar relatório semanal automático
            generateWeeklyReportWithPreview: async function () {
                try {
                    const startDate = new Date();
                    startDate.setDate(startDate.getDate() - 7);

                    const reportData = await this.gatherReportData(startDate, new Date());
                    const reportHTML = this.formatReportHTML(reportData, 'weekly');

                    // Mostrar preview antes de enviar
                    this.showReportPreview(reportHTML, 'weekly');

                    // Perguntar se quer enviar por email
                    if (confirm('Deseja enviar este relatório por email?')) {
                        await this.sendReportEmail(reportHTML, 'weekly');
                        await this.saveReportToDB(reportData, 'weekly');
                        showToast('📊 Relatório semanal enviado por email!', 'success');
                    }

                    return reportData;

                } catch (error) {
                    console.error('Erro ao gerar relatório semanal:', error);
                    showToast('Erro ao gerar relatório', 'error');
                }
            },

            // Gerar relatório mensal
            async generateMonthlyReport() {
                try {
                    const startDate = new Date();
                    startDate.setMonth(startDate.getMonth() - 1);

                    const reportData = await this.gatherReportData(startDate, new Date());
                    const reportHTML = this.formatReportHTML(reportData, 'monthly');

                    await this.sendReportEmail(reportHTML, 'monthly');
                    await this.saveReportToDB(reportData, 'monthly');

                    showToast('📈 Relatório mensal gerado e enviado!', 'success');
                    return reportData;

                } catch (error) {
                    console.error('Erro ao gerar relatório mensal:', error);
                    showToast('Erro ao gerar relatório', 'error');
                }
            },

            // Coletar dados para o relatório
            async gatherReportData(startDate, endDate) {
                // Filtrar tarefas do período
                const periodTasks = allTasks.filter(task => {
                    const taskDate = task.createdAt?.seconds
                        ? new Date(task.createdAt.seconds * 1000)
                        : new Date();
                    return taskDate >= startDate && taskDate <= endDate;
                });

                // Estatísticas
                const completedTasks = periodTasks.filter(t => t.completed);
                const pendingTasks = periodTasks.filter(t => !t.completed);

                // Tarefas por categoria
                const tasksByCategory = {};
                periodTasks.forEach(task => {
                    const category = task.category || 'Outros';
                    tasksByCategory[category] = (tasksByCategory[category] || 0) + 1;
                });

                // Empresas mais ativas
                const companyActivity = {};
                periodTasks.forEach(task => {
                    if (task.companyId) {
                        companyActivity[task.companyId] = (companyActivity[task.companyId] || 0) + 1;
                    }
                });

                // Top 5 empresas mais ativas
                const topCompanies = Object.entries(companyActivity)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 5)
                    .map(([companyId, count]) => ({
                        name: allCompanies.find(c => c.id === companyId)?.name || 'Desconhecida',
                        count
                    }));

                return {
                    period: {
                        start: startDate,
                        end: endDate,
                        days: Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24))
                    },
                    summary: {
                        totalTasks: periodTasks.length,
                        completed: completedTasks.length,
                        pending: pendingTasks.length,
                        completionRate: periodTasks.length > 0
                            ? ((completedTasks.length / periodTasks.length) * 100).toFixed(1)
                            : 0
                    },
                    byCategory: tasksByCategory,
                    topCompanies: topCompanies,
                    recentActivity: periodTasks.slice(-10).reverse(), // Últimas 10 tarefas
                    totalCompanies: allCompanies.length,
                    overdueTasks: allTasks.filter(t => {
                        if (t.completed || !t.deadline) return false;
                        return new Date(t.deadline) < new Date();
                    }).length
                };
            },

            // Format HTML do relatório
            formatReportHTML(data, type) {
                const periodStr = type === 'weekly' ? 'Semanal' : 'Mensal';
                const startDate = data.period.start.toLocaleDateString('pt-BR');
                const endDate = data.period.end.toLocaleDateString('pt-BR');

                // Gerar HTML do relatório
                return `
            <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
                <h1 style="color: #6750a4; border-bottom: 2px solid #6750a4; padding-bottom: 10px;">
                    📊 Relatório ${periodStr} - Gestor Contábil Pro
                </h1>
                
                <div style="background: #f8fafc; padding: 20px; border-radius: 10px; margin: 20px 0;">
                    <h3 style="color: #475569; margin-top: 0;">📈 Resumo do Período</h3>
                    <p><strong>Período:</strong> ${startDate} a ${endDate} (${data.period.days} dias)</p>
                    
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin: 20px 0;">
                        <div style="background: white; padding: 15px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 24px; font-weight: bold; color: #10b981;">${data.summary.completed}</div>
                            <div style="color: #64748b;">Concluídas</div>
                        </div>
                        <div style="background: white; padding: 15px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 24px; font-weight: bold; color: #f59e0b;">${data.summary.pending}</div>
                            <div style="color: #64748b;">Pendentes</div>
                        </div>
                        <div style="background: white; padding: 15px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 24px; font-weight: bold; color: #3b82f6;">${data.summary.totalTasks}</div>
                            <div style="color: #64748b;">Total de Tarefas</div>
                        </div>
                        <div style="background: white; padding: 15px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 24px; font-weight: bold; color: #8b5cf6;">${data.summary.completionRate}%</div>
                            <div style="color: #64748b;">Taxa de Conclusão</div>
                        </div>
                    </div>
                </div>
                
                <div style="margin: 30px 0;">
                    <h3 style="color: #475569;">🏢 Empresas Mais Ativas</h3>
                    <ul style="list-style: none; padding: 0;">
                        ${data.topCompanies.map(company => `
                            <li style="padding: 10px 0; border-bottom: 1px solid #e2e8f0;">
                                <strong>${company.name}</strong>
                                <span style="float: right; background: #e0e7ff; color: #3730a3; padding: 2px 8px; border-radius: 12px;">
                                    ${company.count} tarefas
                                </span>
                            </li>
                        `).join('')}
                    </ul>
                </div>
                
                <div style="margin: 30px 0;">
                    <h3 style="color: #475569;">📋 Tarefas por Categoria</h3>
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        ${Object.entries(data.byCategory).map(([category, count]) => `
                            <div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                    <span>${category}</span>
                                    <span>${count}</span>
                                </div>
                                <div style="height: 8px; background: #e2e8f0; border-radius: 4px; overflow: hidden;">
                                    <div style="height: 100%; width: ${(count / data.summary.totalTasks) * 100}%; 
                                          background: #6750a4; border-radius: 4px;"></div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                
                <div style="background: #fef2f2; padding: 15px; border-radius: 8px; margin: 20px 0;">
                    <h4 style="color: #dc2626; margin: 0;">⚠️ Alertas Importantes</h4>
                    <ul style="margin: 10px 0 0 0; padding-left: 20px;">
                        <li>Total de empresas cadastradas: <strong>${data.totalCompanies}</strong></li>
                        <li>Tarefas atrasadas: <strong>${data.overdueTasks}</strong></li>
                        ${data.overdueTasks > 5 ? '<li style="color: #dc2626;">❌ Alto número de tarefas atrasadas! Ação necessária.</li>' : ''}
                    </ul>
                </div>
                
                <div style="margin-top: 30px; padding-top: 20px; border-top: 2px solid #e2e8f0; text-align: center; color: #64748b;">
                    <p>Relatório gerado automaticamente pelo Gestor Contábil Pro</p>
                    <p>${new Date().toLocaleDateString('pt-BR')} às ${new Date().toLocaleTimeString('pt-BR')}</p>
                </div>
            </div>
        `;
            },

            // Enviar relatório por email
            async sendReportEmail(reportHTML, type) {
                try {
                    const periodStr = type === 'weekly' ? 'Semanal' : 'Mensal';

                    await emailjs.send(
                        "service_xh93ndo",
                        "template_akjxe6i",
                        {
                            to_email: currentUser.email,
                            subject: `📊 Relatório ${periodStr} - Gestor Contábil Pro`,
                            report_content: reportHTML,
                            report_date: new Date().toLocaleDateString('pt-BR'),
                            report_type: periodStr
                        }
                    );

                    console.log(`✅ Relatório ${type} enviado por email`);

                } catch (error) {
                    console.error(`Erro ao enviar relatório ${type}:`, error);
                    throw error;
                }
            },

            // Salvar relatório no banco de dados
            async saveReportToDB(reportData, type) {
                try {
                    const reportDoc = {
                        type: type,
                        data: reportData,
                        generatedAt: serverTimestamp(),
                        generatedBy: currentUser.uid,
                        period: {
                            start: reportData.period.start,
                            end: reportData.period.end
                        }
                    };

                    await addDoc(
                        collection(db, 'artifacts', appId, 'users', currentUser.uid, 'reports'),
                        reportDoc
                    );

                    console.log(`✅ Relatório ${type} salvo no banco de dados`);

                } catch (error) {
                    console.error(`Erro ao salvar relatório ${type}:`, error);
                }
            },

            // Agendar relatórios automáticos
            scheduleAutoReports() {
                // Relatório semanal: Toda segunda-feira às 9:00
                const now = new Date();
                const dayOfWeek = now.getDay(); // 0 = Domingo, 1 = Segunda, etc.
                const daysUntilMonday = dayOfWeek === 1 ? 7 : (8 - dayOfWeek) % 7;

                const nextMonday = new Date(now);
                nextMonday.setDate(now.getDate() + daysUntilMonday);
                nextMonday.setHours(9, 0, 0, 0); // 9:00 AM

                const timeUntilMonday = nextMonday.getTime() - now.getTime();

                if (timeUntilMonday > 0) {
                    setTimeout(() => {
                        this.generateWeeklyReport();
                        // Repetir a cada 7 dias
                        setInterval(() => this.generateWeeklyReport(), 7 * 24 * 60 * 60 * 1000);
                    }, timeUntilMonday);
                }

                // Relatório mensal: Primeiro dia do mês às 10:00
                const nextMonth = new Date(now.getFullYear(), now.getMonth() + 1, 1, 10, 0, 0);
                const timeUntilNextMonth = nextMonth.getTime() - now.getTime();

                if (timeUntilNextMonth > 0) {
                    setTimeout(() => {
                        this.generateMonthlyReport();
                        // Repetir a cada mês (aproximadamente)
                        setInterval(() => this.generateMonthlyReport(), 30 * 24 * 60 * 60 * 1000);
                    }, timeUntilNextMonth);
                }

                console.log('📅 Relatórios automáticos agendados!');
            },

            // Interface para usuário gerar relatórios manualmente
            // Interface para usuário gerar relatórios manualmente
            initReportUI() {
                // Adicionar botões no dashboard
                const dashboardHeader = document.querySelector('#view-dashboard .dashboard-header');
                if (dashboardHeader && !dashboardHeader.querySelector('.report-buttons')) {
                    const reportButtons = document.createElement('div');
                    reportButtons.className = 'report-buttons';
                    reportButtons.style.display = 'flex';
                    reportButtons.style.gap = '10px';
                    reportButtons.style.marginLeft = 'auto';

                    reportButtons.innerHTML = `
            <button class="icon-btn weekly-report-btn" 
                    title="Gerar Relatório Semanal"
                    style="background: #3b82f6; color: white; display: flex; align-items: center; gap: 6px;">
                <i data-lucide="calendar" width="18"></i>
                <span style="font-size: 12px; margin-left: 5px;">Semanal</span>
            </button>
            <button class="icon-btn monthly-report-btn" 
                    title="Gerar Relatório Mensal"
                    style="background: #8b5cf6; color: white; display: flex; align-items: center; gap: 6px;">
                <i data-lucide="bar-chart" width="18"></i>
                <span style="font-size: 12px; margin-left: 5px;">Mensal</span>
            </button>
        `;

                    dashboardHeader.appendChild(reportButtons);
                    lucide.createIcons();

                    // Adicionar event listeners
                    setTimeout(() => {
                        const weeklyBtn = document.querySelector('.weekly-report-btn');
                        const monthlyBtn = document.querySelector('.monthly-report-btn');

                        if (weeklyBtn) {
                            weeklyBtn.addEventListener('click', (e) => {
                                e.stopPropagation();
                                this.generateWeeklyReport();
                            });
                        }

                        if (monthlyBtn) {
                            monthlyBtn.addEventListener('click', (e) => {
                                e.stopPropagation();
                                this.generateMonthlyReport();
                            });
                        }
                    }, 100);
                }
            }
        };

        // Abrir modal para criar/editar pin
        window.openPinModal = (targetType, targetId, pinId = null) => {
            const modal = document.getElementById('modal-pin');

            // Configurar cores com gradientes
            const colorsGrid = document.getElementById('pin-colors');
            colorsGrid.innerHTML = '';

            const ENHANCED_PIN_COLORS = [
                { color: '#ef4444', name: 'Urgente', gradient: 'linear-gradient(135deg, #ef4444, #dc2626)', icon: 'alert-triangle' },
                { color: '#f59e0b', name: 'Atenção', gradient: 'linear-gradient(135deg, #f59e0b, #d97706)', icon: 'clock' },
                { color: '#10b981', name: 'Concluído', gradient: 'linear-gradient(135deg, #10b981, #059669)', icon: 'check-circle' },
                { color: '#3b82f6', name: 'Informação', gradient: 'linear-gradient(135deg, #3b82f6, #2563eb)', icon: 'info' },
                { color: '#8b5cf6', name: 'Financeiro', gradient: 'linear-gradient(135deg, #8b5cf6, #7c3aed)', icon: 'dollar-sign' },
                { color: '#ec4899', name: 'Pessoal', gradient: 'linear-gradient(135deg, #ec4899, #db2777)', icon: 'user' },
                { color: '#06b6d4', name: 'Documentação', gradient: 'linear-gradient(135deg, #06b6d4, #0891b2)', icon: 'file-text' },
                { color: '#84cc16', name: 'Follow-up', gradient: 'linear-gradient(135deg, #84cc16, #65a30d)', icon: 'refresh-cw' },
            ];

            // Criar HTML do modal atualizado
            modal.innerHTML = `
        <div class="modal" style="max-width: 500px;">
            <div class="modal-header">
                <h3 id="modal-pin-title">${pinId ? 'Editar Etiqueta' : 'Nova Etiqueta'}</h3>
                <button onclick="closeModals()"><i data-lucide="x"></i></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="pin-id" value="${pinId || ''}">
                <input type="hidden" id="pin-target-type" value="${targetType}">
                <input type="hidden" id="pin-target-id" value="${targetId}">
                
                <div class="input-group">
                    <label>Título da Etiqueta *</label>
                    <input type="text" id="pin-title" class="std-input" 
                           placeholder="Ex: Pendência, Importante, Revisar..." 
                           value="${pinId ? (allPins.find(p => p.id === pinId)?.title || '') : ''}">
                </div>
                
                <div class="input-group">
                    <label>Cor e Categoria</label>
                    <div id="pin-colors" class="colors-grid" style="grid-template-columns: repeat(4, 1fr);">
                        <!-- Cores serão geradas via JS abaixo -->
                    </div>
                </div>
                
                <div class="input-group">
                    <label>Prioridade</label>
                    <div class="priority-buttons" style="display: flex; gap: 8px; margin-top: 8px;">
                        <button type="button" class="priority-btn" data-priority="low" 
                                style="flex: 1; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; background: #f3f4f6;">
                            Baixa
                        </button>
                        <button type="button" class="priority-btn active" data-priority="medium" 
                                style="flex: 1; padding: 8px; border: 1px solid #3b82f6; border-radius: 6px; background: #dbeafe; color: #1e40af;">
                            Média
                        </button>
                        <button type="button" class="priority-btn" data-priority="high" 
                                style="flex: 1; padding: 8px; border: 1px solid #dc2626; border-radius: 6px; background: #fef2f2; color: #991b1b;">
                            Alta
                        </button>
                    </div>
                </div>
                
                <div class="input-group">
                    <label>Expira em (Opcional)</label>
                    <input type="date" id="pin-expiry" class="std-input" 
                           value="${pinId ? (allPins.find(p => p.id === pinId)?.expiry || '') : ''}">
                </div>
                
                <div class="input-group">
                    <label>Comentário</label>
                    <textarea id="pin-comment" class="std-input" rows="4" 
                              placeholder="Adicione um comentário ou observação...">${pinId ? (allPins.find(p => p.id === pinId)?.comment || '') : ''}</textarea>
                </div>
                
                <div class="input-group">
                    <label>
                        <input type="checkbox" id="pin-notify" ${pinId ? (allPins.find(p => p.id === pinId)?.notify ? 'checked' : '') : ''}>
                        Notificar sobre esta etiqueta
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" id="btn-delete-pin" class="${pinId ? '' : 'hidden'}" 
                        style="color: var(--danger); margin-right: auto; font-weight: 600;" 
                        onclick="confirmDeletePin('${pinId}')">
                    <i data-lucide="trash-2" width="16"></i> Excluir Etiqueta
                </button>
                <button onclick="closeModals()" style="color: var(--text-sec); font-weight: 600; padding: 0 15px;">
                    Cancelar
                </button>
                <button onclick="saveEnhancedPin()" class="btn-main" style="width: auto; padding: 10px 24px;">
                    ${pinId ? 'Atualizar' : 'Salvar'} Etiqueta
                </button>
            </div>
        </div>
    `;

            // Gerar cores após o modal ser criado
            setTimeout(() => {
                const colorsContainer = document.getElementById('pin-colors');
                ENHANCED_PIN_COLORS.forEach((colorObj, index) => {
                    const colorDiv = document.createElement('div');
                    colorDiv.className = 'color-option';
                    colorDiv.style.background = colorObj.gradient;
                    colorDiv.title = colorObj.name;
                    colorDiv.setAttribute('data-color', colorObj.color);
                    colorDiv.setAttribute('data-name', colorObj.name);

                    // Adicionar ícone
                    colorDiv.innerHTML = `<i data-lucide="${colorObj.icon}" width="16" style="color: white;"></i>`;

                    // Selecionar primeira cor por padrão ou cor existente
                    if ((!pinId && index === 0) || (pinId && allPins.find(p => p.id === pinId)?.color === colorObj.color)) {
                        colorDiv.classList.add('selected');
                        colorsContainer.setAttribute('data-selected-color', colorObj.color);
                        colorsContainer.setAttribute('data-selected-name', colorObj.name);
                    }

                    colorDiv.onclick = function () {
                        document.querySelectorAll('.color-option').forEach(opt => opt.classList.remove('selected'));
                        this.classList.add('selected');
                        colorsContainer.setAttribute('data-selected-color', this.getAttribute('data-color'));
                        colorsContainer.setAttribute('data-selected-name', this.getAttribute('data-name'));
                    };

                    colorsContainer.appendChild(colorDiv);
                });

                // Configurar botões de prioridade
                document.querySelectorAll('.priority-btn').forEach(btn => {
                    btn.onclick = function () {
                        document.querySelectorAll('.priority-btn').forEach(b => {
                            b.classList.remove('active');
                            b.style.background = '#f3f4f6';
                            b.style.borderColor = '#d1d5db';
                            b.style.color = '#374151';
                        });
                        this.classList.add('active');
                        const priority = this.getAttribute('data-priority');
                        if (priority === 'medium') {
                            this.style.background = '#dbeafe';
                            this.style.borderColor = '#3b82f6';
                            this.style.color = '#1e40af';
                        } else if (priority === 'high') {
                            this.style.background = '#fef2f2';
                            this.style.borderColor = '#dc2626';
                            this.style.color = '#991b1b';
                        }
                    };
                });

                // Se for edição, carregar prioridade salva
                if (pinId) {
                    const existingPin = allPins.find(p => p.id === pinId);
                    if (existingPin?.priority) {
                        const btn = document.querySelector(`.priority-btn[data-priority="${existingPin.priority}"]`);
                        if (btn) btn.click();
                    }
                }

                lucide.createIcons();
            }, 100);

            modal.classList.remove('hidden');
        };

        // Selecionar cor do pin
        function selectPinColor(color) {
            document.querySelectorAll('.color-option').forEach(opt => {
                opt.classList.remove('selected');
            });

            event.target.classList.add('selected');

            // Salvar cor selecionada em um atributo
            document.getElementById('pin-colors').setAttribute('data-selected-color', color);
        }

        // Editar pin existente
        window.editPin = (pinId) => {
            closeModals(); // Fechar modal atual
            const pin = allPins.find(p => p.id === pinId);
            if (pin) {
                openPinModal(pin.targetType, pin.targetId, pinId);
            }
        };

        // Salvar pin
        window.saveEnhancedPin = async () => {
            const id = document.getElementById('pin-id').value;
            const isUpdate = !!id;

            // Capturar dados antigos se for update
            let oldData = null;
            if (isUpdate) {
                oldData = allPins.find(p => p.id === id);
            }

            const title = document.getElementById('pin-title').value;
            const comment = document.getElementById('pin-comment').value;
            const targetType = document.getElementById('pin-target-type').value;
            const targetId = document.getElementById('pin-target-id').value;
            const colorsGrid = document.getElementById('pin-colors');
            const selectedColor = colorsGrid?.getAttribute('data-selected-color') || '#3b82f6';
            const priorityBtn = document.querySelector('.priority-btn.active');
            const priority = priorityBtn ? priorityBtn.getAttribute('data-priority') : 'medium';

            if (!title) {
                showToast('Digite um título para a etiqueta', 'error');
                return;
            }

            const data = {
                title,
                comment,
                color: selectedColor,
                priority,
                targetType,
                targetId,
                updatedAt: serverTimestamp(),
                lastUpdatedBy: currentUser.email,
                lastUpdatedAt: serverTimestamp(),
                updatedByUserId: currentUser.uid
            };

            // Adquirir lock de edição
            if (isUpdate) {
                await RealTimeCollaboration.acquireLock('pin', id);
            }

            try {
                if (id) {
                    // LOG ANTES DE ATUALIZAR
                    await AuditLogger.autoLogUpdate('pin', id, oldData, data);

                    await updateDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'pins', id), data);
                    showToast('Etiqueta atualizada', 'success');
                } else {
                    data.createdAt = serverTimestamp();
                    data.createdBy = currentUser.email;
                    data.createdByUserId = currentUser.uid;

                    await addDoc(collection(db, 'artifacts', appId, 'users', window.currentWorkspaceOwnerId, 'pins'), data);

                    await AuditLogger.logAction('create', 'pin', id, {
                        created: { old: null, new: data }
                    });

                    showToast('Etiqueta criada', 'success');
                }

                closeModals();
                setTimeout(updateAllPins, 300);
            } catch (e) {
                console.error(e);
                showToast('Erro ao salvar etiqueta', 'error');
            } finally {
                // Liberar lock
                if (isUpdate) {
                    await RealTimeCollaboration.releaseLock('pin', id);
                }
            }
        };

        window.confirmDeletePin = (pinId) => {
            const pin = allPins.find(p => p.id === pinId);
            deletePending = { type: 'pin', id: pinId };

            document.getElementById('delete-confirm-title').textContent = 'Excluir Etiqueta';
            document.getElementById('delete-confirm-message').textContent = `Tem certeza que deseja excluir a etiqueta "${pin?.title || 'esta etiqueta'}"?`;

            document.getElementById('modal-delete-confirm').classList.remove('hidden');
        };

        // Confirmar exclusão de pin
        window.confirmDeletePin = () => {
            const pinId = document.getElementById('pin-id').value;
            const pinTitle = document.getElementById('pin-title').value;

            deletePending = { type: 'pin', id: pinId };
            document.getElementById('delete-confirm-title').textContent = 'Excluir Etiqueta';
            document.getElementById('delete-confirm-message').textContent = `Tem certeza que deseja excluir a etiqueta "${pinTitle}"?`;

            document.getElementById('modal-delete-confirm').classList.remove('hidden');
        };

        // ============================================
        // AUTH LOGIC
        // ============================================

        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            if (user) {
                // Definir workspace padrão como o do próprio usuário se não estiver definido
                if (!window.currentWorkspaceOwnerId) {
                    window.currentWorkspaceOwnerId = user.uid;
                    window.currentWorkspaceName = "Meu Escritório";
                }

                document.getElementById('auth-screen').classList.add('hidden');
                document.getElementById('app-screen').classList.remove('hidden');
                subscribeData();
                initHeader();
                initNotificationSystem();
                initNotesSystem(); // Inicializar sistema de notas
                lucide.createIcons(); // Recriar ícones após mudança de tela
            } else {
                document.getElementById('app-screen').classList.add('hidden');
                document.getElementById('auth-screen').classList.remove('hidden');
                if (unsubTasks) unsubTasks();
                if (unsubCompanies) unsubCompanies();
                if (unsubPins) unsubPins();
                if (unsubNotes) unsubNotes();
                lucide.createIcons(); // Recriar ícones após mudança de tela
            }
        });

        document.getElementById('auth-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const btn = document.getElementById('auth-btn');

            btn.innerHTML = '<i data-lucide="loader-2" width="18"></i> Processando...';
            btn.disabled = true;

            try {
                if (isLoginMode) {
                    await signInWithEmailAndPassword(auth, email, password);
                } else {
                    await createUserWithEmailAndPassword(auth, email, password);
                    showToast('Conta criada com sucesso!', 'success');
                }
            } catch (err) {
                console.error(err);
                let msg = "Erro na autenticação";
                if (err.code === 'auth/wrong-password') msg = "Senha incorreta";
                if (err.code === 'auth/user-not-found') msg = "Usuário não encontrado";
                if (err.code === 'auth/weak-password') msg = "Senha muito fraca (min 6 digitos)";
                if (err.code === 'auth/email-already-in-use') msg = "E-mail já cadastrado";
                showToast(msg, 'error');
            } finally {
                updateAuthButton();
                btn.disabled = false;
                lucide.createIcons();
            }
        });

        // Função para atualizar o botão de autenticação
        function updateAuthButton() {
            const authBtn = document.getElementById('auth-btn');
            const authBtnText = document.getElementById('auth-btn-text');

            if (isLoginMode) {
                authBtnText.textContent = 'Entrar no Sistema';
                authBtn.innerHTML = '<i data-lucide="log-in" width="18"></i> Entrar no Sistema';
            } else {
                authBtnText.textContent = 'Criar Conta';
                authBtn.innerHTML = '<i data-lucide="user-plus" width="18"></i> Criar Conta';
            }
        }

        // Função para atualizar o toggle de modo
        function updateAuthToggle() {
            const toggleText = document.getElementById('toggle-auth-text');
            const toggleBtn = document.getElementById('toggle-auth-mode');

            if (isLoginMode) {
                toggleText.textContent = 'Criar uma nova conta';
                toggleBtn.innerHTML = '<i data-lucide="user-plus" width="14"></i> Criar uma nova conta';
            } else {
                toggleText.textContent = 'Já tenho uma conta';
                toggleBtn.innerHTML = '<i data-lucide="log-in" width="14"></i> Já tenho uma conta';
            }
        }

        document.getElementById('toggle-auth-mode').addEventListener('click', (e) => {
            e.preventDefault();
            isLoginMode = !isLoginMode;
            updateAuthButton();
            updateAuthToggle();
            lucide.createIcons();
        });

        document.addEventListener('click', (e) => {
            if (!e.target.closest('.pin-badge')) {
                hidePinTooltip();
            }
        });

        // Toggle password visibility
        document.getElementById('toggle-password')?.addEventListener('click', function () {
            const passwordInput = document.getElementById('password');
            const icon = this.querySelector('i');

            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                icon.setAttribute('data-lucide', 'eye-off');
                this.innerHTML = '<i data-lucide="eye-off" width="14"></i> Ocultar senha';
            } else {
                passwordInput.type = 'password';
                icon.setAttribute('data-lucide', 'eye');
                this.innerHTML = '<i data-lucide="eye" width="14"></i> Mostrar senha';
            }
            lucide.createIcons();
        });

        document.getElementById('logout-btn').addEventListener('click', () => {
            if (confirm('Deseja realmente sair do sistema?')) {
                signOut(auth);
            }
        });

        // NAVIGATION
        window.switchTab = (tab) => {
            currentTab = tab;

            // Atualizar navegação
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(el => el.classList.remove('active'));

            // Ativar item correspondente no novo header
            const navItem = document.querySelector(`.nav-item[onclick*="${tab}"]`);
            if (navItem) navItem.classList.add('active');

            // Ativar tab correspondente no header antigo (se ainda existir)
            const oldTab = document.querySelector(`.nav-tab[onclick="switchTab('${tab}')"]`);
            if (oldTab) oldTab.classList.add('active');

            // Mostrar conteúdo correspondente
            document.getElementById('view-tasks').classList.toggle('hidden', tab !== 'tasks');
            document.getElementById('view-companies').classList.toggle('hidden', tab !== 'companies');
            document.getElementById('view-notes').classList.toggle('hidden', tab !== 'notes');
            document.getElementById('view-dashboard').classList.toggle('hidden', tab !== 'dashboard');

            // Ações específicas por tab
            if (tab === 'tasks') {
                renderTasks();
                updateHeaderStatus();

                if (taskToHighlight) {
                    setTimeout(() => {
                        highlightTask(taskToHighlight);
                        taskToHighlight = null;
                    }, 100);
                }
            } else if (tab === 'companies') {
                // Nada específico
            } else if (tab === 'notes') {
                renderNotes();
            } else if (tab === 'dashboard') {
                // Chama o novo gerenciador que criamos acima
                DashboardManager.init();

                // (Opcional) Se quiser manter os relatórios
                setTimeout(() => {
                    if (window.ReportSystem) window.ReportSystem.initReportUI();
                }, 500);
            }


            if (tab === 'dashboard') {
                updateDashboardCounters();
                // Inicializar dashboard avançado
                setTimeout(() => {
                    AdvancedDashboard.init();
                    // Garantir que os botões de relatório estejam ativos
                    ReportSystem.initReportUI();
                }, 500);
            }

            lucide.createIcons();
        };

        function filterCompaniesWithoutRecentTasks() {
            const hoje = new Date();
            const filteredCompanies = allCompanies.filter(company => {
                const companyTasks = allTasks.filter(t => t.companyId === company.id);
                const recentTasks = companyTasks.filter(t => {
                    if (!t.updatedAt) return false;
                    const taskDate = new Date(t.updatedAt.seconds * 1000);
                    const daysDiff = (hoje - taskDate) / (1000 * 60 * 60 * 24);
                    return daysDiff < 30;
                });
                return recentTasks.length === 0 && companyTasks.length > 0;
            });

            // Mostrar na view de empresas
            switchTab('companies');

            // Atualizar busca para mostrar apenas estas empresas
            currentCompanySearch = 'sem-atividades-recentes';
            renderCompanies();

            showToast(`${filteredCompanies.length} empresas sem atividades recentes`, 'info');
        }

        window.handleFabClick = () => {
            if (currentTab === 'tasks') openTaskModal();
            else if (currentTab === 'companies') openCompanyModal();
            else if (currentTab === 'notes') openNoteModal();
            else openCompanyModal(); // Dashboard também abre empresa
        };

        // Função para mostrar/ocultar campos baseados no regime
        window.updateRegimeFields = () => {
            const regime = document.getElementById('company-regime').value;
            const presumidoFields = document.getElementById('presumido-fields');

            if (regime === 'PRESUMIDO') {
                presumidoFields.style.display = 'block';
            } else {
                presumidoFields.style.display = 'none';
            }
        };

        // Função para sugerir prazos baseados na obrigação
        window.updateTaskFields = () => {
            console.log("updateTaskFields() chamada!"); // DEBUG

            const obligation = document.getElementById('task-obligation').value;
            const deadlineInput = document.getElementById('task-deadline');
            const referenceInput = document.getElementById('task-reference');

            // Mapeamento de Obrigação -> Categoria
            const obligationCategoryMap = {
                'DAS': 'FISCAL',
                'IRPJ': 'FISCAL',
                'CSLL': 'FISCAL',
                'PIS_COFINS': 'FISCAL',
                'EFD': 'FISCAL',
                'DIRF': 'FISCAL',
                'DCTF': 'FISCAL',
                'DARF': 'FISCAL',
                'GPS': 'TRABALHISTA',
                'RAIS': 'TRABALHISTA',
                'CAGED': 'TRABALHISTA',
                'SEFIP': 'TRABALHISTA'
            };

            // Auto-selecionar categoria se houver mapeamento
            if (obligation && obligationCategoryMap[obligation]) {
                const categorySelect = document.getElementById('task-category');
                if (categorySelect) categorySelect.value = obligationCategoryMap[obligation];
            }

            // Datas de vencimento padrão
            const vencimentosPadrao = {
                'DAS': 20, // Dia 20 do mês seguinte
                'GPS': 20, // Dia 20 do mês seguinte
                'IRPJ': 30, // Último dia do mês seguinte
                'CSLL': 30,
                'PIS_COFINS': 20,
                'EFD': 15,
                'DIRF': 30 // Abril
            };

            if (vencimentosPadrao[obligation]) {
                const hoje = new Date();
                let mes = hoje.getMonth() + 1; // Mês atual (0-indexed)
                let ano = hoje.getFullYear();

                console.log("Hoje:", hoje, "Mês:", mes, "Ano:", ano); // DEBUG

                // Para DAS/GPS: vence no dia X do mês seguinte
                if (obligation === 'DAS' || obligation === 'GPS') {
                    mes += 1;
                    if (mes > 12) {
                        mes = 1;
                        ano += 1;
                    }
                }

                // Formatar como YYYY-MM-DD
                const dia = vencimentosPadrao[obligation];
                const dataFormatada = `${ano}-${mes.toString().padStart(2, '0')}-${dia.toString().padStart(2, '0')}`;

                console.log("Data calculada:", dataFormatada); // DEBUG

                deadlineInput.value = dataFormatada;

                // Preencher referência também
                referenceInput.value = `${ano}-${mes.toString().padStart(2, '0')}`;

                console.log("Campo deadline preenchido com:", deadlineInput.value); // DEBUG
            } else {
                console.log("Nenhuma obrigação reconhecida ou vazia"); // DEBUG
            }

            // Gerar título automático
            generateTaskTitle();
        };

        // Função para gerar título automático de tarefa
        function generateTaskTitle() {
            const companySelect = document.getElementById('task-company');
            const companyId = companySelect.value;
            const obligation = document.getElementById('task-obligation').value;
            const reference = document.getElementById('task-reference').value;

            if (companyId && obligation && reference) {
                const company = allCompanies.find(c => c.id === companyId);
                const obligationNames = {
                    'DAS': 'DAS - Simples Nacional',
                    'GPS': 'GPS - Guia da Previdência',
                    'IRPJ': 'IRPJ - Imposto de Renda',
                    'CSLL': 'CSLL - Contribuição Social',
                    'PIS_COFINS': 'PIS/COFINS',
                    'EFD': 'EFD Contribuições',
                    'DIRF': 'DIRF - Declaração IRRF',
                    'DCTF': 'DCTF',
                    'RAIS': 'RAIS',
                    'CAGED': 'CAGED',
                    'SEFIP': 'SEFIP',
                    'DARF': 'DARF'
                };

                const title = `${obligationNames[obligation] || obligation} - ${reference}`;
                document.getElementById('task-title').value = title;
            }
        }

        // Inicializar ao carregar
        document.addEventListener('DOMContentLoaded', function () {
            console.log('DOM carregado - inicializando tarefas');

            // Inicializar filtro padrão após um pequeno delay
            setTimeout(() => {
                if (document.getElementById('filter-all')) {
                    setTaskFilter('all');
                }

                // Inicializar ícones
                if (window.lucide && window.lucide.createIcons) {
                    lucide.createIcons();
                }
            }, 500);

            // Configurar evento para o input de busca
            const taskSearch = document.getElementById('task-search');
            if (taskSearch) {
                taskSearch.addEventListener('input', function (e) {
                    searchTasks(e.target.value);
                });
            }
        });

        document.addEventListener('DOMContentLoaded', function () {
            // Atualizar título quando selecionar obrigação
            const obligationSelect = document.getElementById('task-obligation');
            const referenceInput = document.getElementById('task-reference');

            if (obligationSelect) {
                obligationSelect.addEventListener('change', generateTaskTitle);
            }
            if (referenceInput) {
                referenceInput.addEventListener('change', generateTaskTitle);
            }

            // INICIALIZAR HEADER
            initHeader();
        });

        // Função para gerenciar cliques globais e fechar dropdowns
        function initGlobalClickListeners() {
            // Remove existing listener to avoid duplicates
            if (window._globalClickListener) {
                document.removeEventListener('click', window._globalClickListener);
            }

            window._globalClickListener = function (e) {
                const userDropdown = document.getElementById('user-dropdown');
                const userProfileBtn = document.getElementById('user-profile-btn');
                const notifDropdown = document.getElementById('notification-dropdown');
                const notifBtn = document.getElementById('notification-btn');

                // Fechar User Dropdown
                if (userDropdown && userProfileBtn &&
                    userDropdown.classList.contains('show') &&
                    !userDropdown.contains(e.target) &&
                    !userProfileBtn.contains(e.target)) {
                    userDropdown.classList.remove('show');
                }

                // Fechar Notification Dropdown
                if (notifDropdown && notifBtn &&
                    notifDropdown.classList.contains('show') &&
                    !notifDropdown.contains(e.target) &&
                    !notifBtn.contains(e.target)) {
                    notifDropdown.classList.remove('show');
                }
            };

            document.addEventListener('click', window._globalClickListener);
        }

        function initHeader() {
            // Atualizar header existente para o novo layout
            updateHeaderLayout();

            // Adicionar funcionalidade do dropdown
            setupUserDropdown();


            // ============================================
            // GERENCIADOR DE COLABORADORES
            // ============================================
            const CollaboratorManager = {
                // Listar colaboradores do workspace atual
                listCollaborators: async () => {
                    if (!window.currentWorkspaceOwnerId) return [];

                    try {
                        // Colaboradores são armazenados na subcoleção 'collaborators' do usuário dono do workspace
                        const collabRef = collection(db, 'artifacts', appId, 'users', window.currentWorkspaceOwnerId, 'collaborators');
                        const snapshot = await getDocs(collabRef);

                        return snapshot.docs.map(doc => ({
                            id: doc.id,
                            ...doc.data()
                        }));
                    } catch (error) {
                        console.error('Erro ao listar colaboradores:', error);
                        return [];
                    }
                },

                // Convidar colaborador
                inviteCollaborator: async (email, permission) => {
                    const ownerId = window.currentWorkspaceOwnerId;
                    if (!ownerId) return false;

                    try {
                        // 1. Verificar se já existe
                        const existing = await CollaboratorManager.listCollaborators();
                        if (existing.some(c => c.email === email)) {
                            showToast('Este usuário já é um colaborador.', 'warning');
                            return false;
                        }

                        // 2. Criar convite na coleção global de convites (para facilitar busca pelo email)
                        const inviteData = {
                            fromUser: currentUser.uid,
                            fromEmail: currentUser.email,
                            fromWorkspaceName: window.currentWorkspaceName || 'Meu Workspace',
                            toEmail: email,
                            permission: permission,
                            status: 'pending',
                            invitedAt: serverTimestamp(),
                            workspaceOwnerId: ownerId
                        };

                        const inviteRef = await addDoc(collection(db, 'artifacts', appId, 'invites'), inviteData);

                        // 3. Adicionar referência na lista de colaboradores do workspace (como pendente)
                        await addDoc(collection(db, 'artifacts', appId, 'users', ownerId, 'collaborators'), {
                            email: email,
                            permissionLevel: permission,
                            status: 'pending',
                            invitedAt: serverTimestamp(),
                            inviteId: inviteRef.id,
                            invitedBy: currentUser.email
                        });

                        // 4. Enviar notificação (se possível) - Simulado
                        // TODO: Integração com EmailJS para enviar email real

                        // Logar auditoria
                        await AuditLogger.logAction('invite', 'workspace', ownerId, {
                            email: email,
                            permission: permission
                        });

                        showToast(`Convite enviado para ${email}`, 'success');
                        return true;
                    } catch (error) {
                        console.error('Erro ao convidar:', error);
                        showToast('Erro ao enviar convite', 'error');
                        return false;
                    }
                },

                // Listar convites recebidos (para o usuário logado)
                listMyInvites: async () => {
                    if (!currentUser?.email) return [];

                    try {
                        const invitesRef = collection(db, 'artifacts', appId, 'invites');
                        const q = query(invitesRef, where('toEmail', '==', currentUser.email), where('status', '==', 'pending'));
                        const snapshot = await getDocs(q);

                        return snapshot.docs.map(doc => ({
                            id: doc.id,
                            ...doc.data()
                        }));
                    } catch (error) {
                        console.error('Erro ao listar convites:', error);
                        return [];
                    }
                },

                // Listar workspaces acessíveis (Meu + Compartilhados)
                listAccessibleWorkspaces: async () => {
                    if (!currentUser) return [];

                    try {
                        const workspaces = [];

                        // 1. Meu próprio workspace (SEMPRE ADICIONAR PRIMEIRO)
                        workspaces.push({
                            ownerId: currentUser.uid,
                            name: 'Meu Workspace',
                            isOwner: true
                        });

                        // 2. Workspaces compartilhados
                        try {
                            const invitesRef = collection(db, 'artifacts', appId, 'invites');
                            // IMPORTANTE: Garantir que indices do Firestore existam para esta query composta
                            // toEmail ASC, status ASC
                            const q = query(invitesRef, where('toEmail', '==', currentUser.email), where('status', '==', 'accepted'));

                            const snapshot = await getDocs(q);

                            snapshot.forEach(doc => {
                                const data = doc.data();

                                // Evitar duplicatas se algo estranho acontecer
                                if (!workspaces.some(w => w.ownerId === data.workspaceOwnerId)) {
                                    workspaces.push({
                                        ownerId: data.workspaceOwnerId,
                                        name: data.fromWorkspaceName || 'Workspace Compartilhado',
                                        isOwner: false,
                                        permission: data.permission || 'viewer'
                                    });
                                }
                            });
                        } catch (errKey) {
                            console.warn('Erro ao buscar invites aceitos (pode ser falta de índice ou permissão):', errKey);
                        }

                        return workspaces;
                    } catch (error) {
                        console.error('Erro geral ao listar workspaces:', error);
                        // Fallback seguro
                        return [{ ownerId: currentUser.uid, name: 'Meu Workspace', isOwner: true }];
                    }
                },

                // Aceitar/Recusar convite
                respondToInvite: async (inviteId, accept) => {
                    console.log(`Respondendo ao convite ${inviteId}: ${accept ? 'Aceitar' : 'Recusar'}`);
                    try {
                        const inviteRef = doc(db, 'artifacts', appId, 'invites', inviteId);

                        // FIX: Substituir getDoc por busca na lista de convites para evitar erro de import
                        // const inviteSnap = await getDoc(inviteRef);

                        // Buscar todos os convites pendentes e filtrar pelo ID
                        const myInvites = await CollaboratorManager.listMyInvites();
                        const inviteData = myInvites.find(inv => inv.id === inviteId);

                        if (!inviteData) {
                            console.error('Convite não encontrado na lista de pendentes');
                            showToast('Convite não encontrado ou já processado', 'error');
                            return false;
                        }

                        console.log('Dados do convite:', inviteData);
                        const newStatus = accept ? 'accepted' : 'rejected';

                        // 1. Atualizar status do convite global
                        console.log('Atualizando status no convite global...');
                        await updateDoc(inviteRef, { status: newStatus, respondedAt: serverTimestamp() });
                        console.log('Status global atualizado.');

                        // 2. Atualizar status na lista de colaboradores do workspace dono
                        const ownerId = inviteData.workspaceOwnerId;
                        console.log(`Buscando registro de colaborador para ${inviteData.toEmail} no workspace de ${ownerId}...`);

                        try {
                            const collabRef = collection(db, 'artifacts', appId, 'users', ownerId, 'collaborators');
                            const q = query(collabRef, where('email', '==', inviteData.toEmail));
                            const snapshot = await getDocs(q);

                            if (!snapshot.empty) {
                                const collabDoc = snapshot.docs[0];
                                console.log('Registro de colaborador encontrado, atualizando...', collabDoc.id);
                                await updateDoc(collabDoc.ref, {
                                    status: accept ? 'active' : 'rejected',
                                    userId: currentUser.uid // Vincular UID se aceitou
                                });
                                console.log('Registro de colaborador atualizado.');
                            } else {
                                console.warn('Registro de colaborador NÃO encontrado no workspace do dono.');
                            }
                        } catch (innerError) {
                            console.error('Erro ao atualizar registro de colaborador (provável erro de permissão):', innerError);
                        }

                        showToast(accept ? 'Convite aceito!' : 'Convite recusado', accept ? 'success' : 'info');

                        // Atualizar a lista de convites na UI se estiver aberta
                        if (window.handleOpenInvites) {
                            // Apenas recarregar se o modal estiver aberto (opcional, ou deixar o usuário reabrir)
                            const modal = document.querySelector('.modal-overlay');
                            if (modal && modal.innerHTML.includes('Convites Recebidos')) {
                                // Fechar modal para evitar estado inconsistente ou recarregar
                                modal.remove();
                            }
                        }

                        return true;
                    } catch (error) {
                        console.error('Erro CRÍTICO ao responder convite:', error);
                        showToast(`Erro ao processar: ${error.message}`, 'error');
                        return false;
                    }
                },

                // Alternar workspace
                switchWorkspace: async (targetOwnerId, workspaceName) => {
                    if (targetOwnerId === window.currentWorkspaceOwnerId) return;

                    try {
                        showToast(`Alternando para ${workspaceName}...`, 'info');

                        // 1. Atualizar globais
                        window.currentWorkspaceOwnerId = targetOwnerId;
                        window.currentWorkspaceName = workspaceName;

                        // 2. Cancelar listeners antigos
                        if (window.unsubCompanies) window.unsubCompanies();
                        if (window.unsubTasks) window.unsubTasks();
                        if (window.unsubNotes) window.unsubNotes();
                        if (window.inviteInterval) clearInterval(window.inviteInterval);

                        // Limpar sistema de notificações
                        if (window.NotificationSystem && window.NotificationSystem.cleanup) {
                            window.NotificationSystem.cleanup();
                        }
                        // (adicionar outros unsubs se existirem)

                        // 3. Limpar dados da UI
                        document.getElementById('company-list').innerHTML = '<div class="loading-spinner"></div>';
                        document.getElementById('pending-list').innerHTML = '';
                        document.getElementById('completed-list').innerHTML = '';

                        // 4. Recarregar dados (chamar subscribeData novamente)
                        // Como subscribeData usa window.currentWorkspaceOwnerId, ele vai pegar do novo
                        subscribeData();

                        // 5. Atualizar header
                        updateHeaderLayout(); // Para atualizar o subtítulo com nome do workspace
                        updateUserInfo();

                        showToast(`Você está agora em: ${workspaceName}`, 'success');

                    } catch (error) {
                        console.error('Erro ao trocar de workspace:', error);
                        showToast('Erro ao trocar de workspace', 'error');
                    }
                },

                // Remover colaborador (apenas admin/dono)
                removeCollaborator: async (collaboratorId) => {
                    // Implementação simplificada
                    try {
                        await deleteDoc(doc(db, 'artifacts', appId, 'users', window.currentWorkspaceOwnerId, 'collaborators', collaboratorId));
                        return true;
                    } catch (e) {
                        console.error(e);
                        return false;
                    }
                },

                // Atualizar colaborador
                updateCollaborator: async (id, data) => {
                    try {
                        await updateDoc(doc(db, 'artifacts', appId, 'users', window.currentWorkspaceOwnerId, 'collaborators', id), data);
                        return true;
                    } catch (e) {
                        console.error(e);
                        return false;
                    }
                }
            };

            // SISTEMA DE CONVITES
            function initInvitesSystem() {
                // Verificar convites pendentes ao iniciar
                checkForPendingInvites();

                // Polling de convites a cada minuto (com cleanup)
                if (window.inviteInterval) clearInterval(window.inviteInterval);
                window.inviteInterval = setInterval(checkForPendingInvites, 60000);
            }

            async function checkForPendingInvites() {
                if (!currentUser) return;

                const invites = await CollaboratorManager.listMyInvites();

                // Atualizar badge de convites
                const badge = document.getElementById('invite-badge');
                if (badge) {
                    if (invites.length > 0) {
                        badge.textContent = invites.length;
                        badge.classList.remove('hidden');
                    } else {
                        badge.classList.add('hidden');
                    }
                }

                // Se houver convites e não tivermos mostrado recentemente, mostrar toast ou modal
                if (invites.length > 0) {
                    // Lógica opcional para notificar usuário
                    // showToast(`Você tem ${invites.length} convite(s) pendente(s)`, 'info');
                }
            }

            window.handleOpenInvites = async () => {
                const invites = await CollaboratorManager.listMyInvites();

                if (invites.length === 0) {
                    showToast('Nenhum convite pendente.', 'info');
                    return;
                }

                // Criar modal de convites
                const modal = document.createElement('div');
                modal.className = 'modal-overlay';
                modal.innerHTML = `
                <div class="modal" style="max-width: 500px;">
                    <div class="modal-header">
                        <h3><i data-lucide="mail"></i> Convites Recebidos</h3>
                        <button onclick="this.closest('.modal-overlay').remove()"><i data-lucide="x"></i></button>
                    </div>
                    <div class="modal-body">
                        ${invites.map(inv => `
                            <div style="background: var(--surface-variant); padding: 16px; border-radius: 8px; margin-bottom: 12px; border: 1px solid var(--outline-variant);">
                                <div style="font-weight: 600; margin-bottom: 4px;">${inv.fromWorkspaceName}</div>
                                <div style="font-size: 13px; color: var(--text-sec); margin-bottom: 12px;">
                                    Convidado por: ${inv.fromEmail}<br>
                                    Permissão: ${inv.permission === 'admin' ? 'Administrador' : inv.permission === 'editor' ? 'Editor' : 'Visualizador'}
                                </div>
                                <div style="display: flex; gap: 10px;">
                                    <button class="btn-main" onclick="processInvite('${inv.id}', true, this)" style="flex: 1;">
                                        Aceitar
                                    </button>
                                    <button class="btn-cancel" onclick="processInvite('${inv.id}', false, this)" style="flex: 1;">
                                        Recusar
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
                document.body.appendChild(modal);
                lucide.createIcons();
            };


            // SISTEMA DE COLABORAÇÃO (STUBS E UI)
            window.RealTimeCollaboration = {
                init: () => {
                    console.log('Sistema colaborativo iniciado');
                    // Futuro: Socket.io ou Firebase Realtime DB para cursores
                }
            };

            window.addCollaboratorsToNavigation = () => {
                // Já está no HTML do header, função mantida para compatibilidade
            };

            window.initCollaboratorsModal = () => {
                // Configuração inicial se necessária
            };

            window.openCollaboratorsModal = async () => {
                const collaborators = await CollaboratorManager.listCollaborators();
                const myInvites = await CollaboratorManager.listMyInvites();
                const isOwner = window.currentWorkspaceOwnerId === currentUser.uid;

                const modal = document.createElement('div');
                modal.className = 'modal-overlay';
                modal.innerHTML = `
        <div class="modal" style="max-width: 600px;">
            <div class="modal-header">
                <h3><i data-lucide="users"></i> Colaboradores - ${window.currentWorkspaceName}</h3>
                <button onclick="this.closest('.modal-overlay').remove()"><i data-lucide="x"></i></button>
            </div>
            <div class="modal-body">
                
                ${isOwner ? `
                <div style="background: var(--surface-variant); padding: 16px; border-radius: 8px; margin-bottom: 24px;">
                    <h4 style="margin-bottom: 12px;">Convidar Novo Colaborador</h4>
                    <div style="display: flex; gap: 8px;">
                        <input type="email" id="invite-email" placeholder="Email do colaborador" class="form-input" style="flex: 1;">
                        <select id="invite-permission" class="form-select" style="width: 120px;">
                            <option value="viewer">Visualizar</option>
                            <option value="editor">Editar</option>
                            <option value="admin">Admin</option>
                        </select>
                        <button onclick="handleSendInvite(this)" class="btn-main">
                            <i data-lucide="send"></i> Convidar
                        </button>
                    </div>
                </div>
                ` : ''}

                <div class="section-title">Colaboradores Ativos</div>
                <div class="collaborators-list">
                    ${collaborators.length > 0 ? collaborators.map(c => `
                        <div class="collaborator-item" style="display: flex; align-items: center; justify-content: space-between; padding: 12px; border-bottom: 1px solid var(--outline-variant);">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <div class="user-avatar" style="width: 32px; height: 32px; font-size: 14px;">${c.email.charAt(0).toUpperCase()}</div>
                                <div>
                                    <div style="font-weight: 500;">${c.email}</div>
                                    <div style="font-size: 12px; color: var(--text-sec);">${c.permissionLevel || c.role} • ${c.status || 'Ativo'}</div>
                                </div>
                            </div>
                            ${isOwner && c.id !== currentUser.uid ? `
                                <button onclick="CollaboratorManager.removeCollaborator('${c.id}').then(() => { this.closest('.collaborator-item').remove(); showToast('Removido'); })" 
                                    class="icon-btn" style="color: var(--error);" title="Remover">
                                    <i data-lucide="trash-2" width="16"></i>
                                </button>
                            ` : ''}
                        </div>
                    `).join('') : '<p style="color: var(--text-sec); padding: 12px;">Nenhum colaborador ainda.</p>'}
                </div>

                ${myInvites.length > 0 ? `
                    <div class="section-title" style="margin-top: 24px;">Convites Pendentes (${myInvites.length})</div>
                    <div style="margin-top: 8px;">
                        <button onclick="handleOpenInvites(); this.closest('.modal-overlay').remove();" class="btn-secondary" style="width: 100%;">
                            Ver Convites Pendentes
                        </button>
                    </div>
                ` : ''}
            </div>
        </div>
    `;
                document.body.appendChild(modal);
                lucide.createIcons();
            };

            window.handleSendInvite = async (btn) => {
                const emailInput = document.getElementById('invite-email');
                const permInput = document.getElementById('invite-permission');
                const email = emailInput.value.trim();
                const perm = permInput.value;

                if (!email) {
                    showToast('Digite um email válido', 'error');
                    return;
                }

                btn.disabled = true;
                btn.textContent = 'Enviando...';

                const success = await CollaboratorManager.inviteCollaborator(email, perm);

                if (success) {
                    emailInput.value = '';
                    showToast('Convite enviado com sucesso!', 'success');
                    // Recarregar modal
                    document.querySelector('.modal-overlay').remove();
                    openCollaboratorsModal();
                }

                btn.disabled = false;
                btn.textContent = 'Convidar';
            };

            window.processInvite = async (inviteId, accept, btnElement) => {
                const modalBody = btnElement.closest('.modal-body');
                btnElement.disabled = true;
                btnElement.textContent = 'Processando...';

                const success = await CollaboratorManager.respondToInvite(inviteId, accept);

                if (success) {
                    // Remover o card do convite
                    const card = btnElement.closest('div[style*="background"]');
                    card.remove();

                    // Se não sobrar nada, fechar modal
                    if (modalBody.children.length === 0) {
                        document.querySelector('.modal-overlay').remove();
                        showToast('Todos os convites foram processados.');
                    }

                    // Atualizar badge
                    checkForPendingInvites();
                }
            };

            // RE-ANEXAR LISTENERS DE NOTIFICAÇÃO (CRITICO PARA NÃO FICAR TRAVADO)

            if (window.NotificationSystem && typeof window.NotificationSystem.setupEventListeners === 'function') {
                window.NotificationSystem.setupEventListeners();
            }

            // Atualizar informações do usuário
            updateUserInfo();

            // Atualizar status do header
            updateHeaderStatus();

            // Inicializar listeners globais de clique
            initGlobalClickListeners();

            // Verificar convites após um segundo
            setTimeout(() => {
                if (typeof checkForPendingInvites === 'function') {
                    checkForPendingInvites();
                }
            }, 1000);
        }

        function updateHeaderLayout() {
            const appHeader = document.querySelector('.app-header');
            if (!appHeader) return;

            // Criar novo layout do header
            appHeader.innerHTML = `
        <div class="header-top">
            <div class="header-brand">
                <div class="brand-icon">
                    <i data-lucide="layout-grid"></i>
                </div>
                <div class="brand-info">
                    <div class="brand-name">Gestor Contábil Pro</div>
                    <div class="brand-subtitle">${window.currentWorkspaceName || 'Escritório Principal'}</div>
                </div>
            </div>
            
            <div class="header-actions">
                <div class="notification-wrapper">
                    <button class="icon-btn" id="notification-btn" title="Notificações">
                        <i data-lucide="bell" width="20"></i>
                        <span id="notification-badge" class="notification-badge hidden"></span>
                    </button>
                </div>
                
                <button class="user-profile" id="user-profile-btn">
                    <div class="user-avatar" id="user-avatar">U</div>
                    <span class="user-name" id="user-name">Usuário</span>
                    <i data-lucide="chevron-down" width="16"></i>
                </button>
            </div>
            
            <div class="user-dropdown" id="user-dropdown">
                <div class="dropdown-header">
                    <div class="user-avatar" id="dropdown-avatar">U</div>
                    <div class="dropdown-user-info">
                        <div class="user-name" id="dropdown-name">Usuário</div>
                        <div class="dropdown-user-email" id="dropdown-email">usuario@email.com</div>
                    </div>
                </div>
                <div class="dropdown-menu">
                    <button class="dropdown-item" onclick="SettingsManager.open()">
                        <i data-lucide="settings" width="16"></i>
                        Configurações
                    </button>
                    <button class="dropdown-item" onclick="switchTab('profile')">
                        <i data-lucide="user" width="16"></i>
                        Meu Perfil
                    </button>
                    <button class="dropdown-item" onclick="handleOpenInvites()">
                        <i data-lucide="mail" width="16"></i>
                        Meus Convites
                        <span id="invite-badge" class="notification-badge hidden" 
                              style="margin-left: auto; width: 18px; height: 18px; font-size: 10px;">
                        </span>
                    </button>
                    <div id="workspace-list-container"></div>
                    <button class="dropdown-item logout" id="logout-btn">
                        <i data-lucide="log-out" width="16"></i>
                        Sair
                    </button>
                </div>
            </div>
        </div>
        
        <nav class="header-nav">
            <div class="nav-container">
                <button class="nav-item active" onclick="switchTab('tasks')">
                    <i data-lucide="check-square"></i>
                    <span>Tarefas</span>
                </button>
                <button class="nav-item" onclick="switchTab('companies')">
                    <i data-lucide="building-2"></i>
                    <span>Empresas</span>
                </button>
                <button class="nav-item" onclick="switchTab('notes')">
                    <i data-lucide="notebook"></i>
                    <span>Notas</span>
                </button>
                <button class="nav-item" onclick="switchTab('dashboard')">
                    <i data-lucide="pie-chart"></i>
                    <span>Dashboard</span>
                </button>
                <button class="nav-item" onclick="openCollaboratorsModal()">
                    <i data-lucide="users"></i>
                    <span>Colaboradores</span>
                </button>
            </div>
        </nav>
        
        <div class="header-status" id="header-status">
            <div class="status-items">
                <div class="status-item">
                    <i data-lucide="check-circle" width="14"></i>
                    <span>Concluídas: <span class="status-value" id="status-completed">0</span></span>
                </div>
                <div class="status-item">
                    <i data-lucide="alert-circle" width="14"></i>
                    <span>Pendentes: <span class="status-value" id="status-pending">0</span></span>
                </div>
                <div class="status-item">
                    <i data-lucide="clock" width="14"></i>
                    <span>Para hoje: <span class="status-value" id="status-today">0</span></span>
                </div>
            </div>
        </div>
    `;

            // Recriar ícones
            lucide.createIcons();

        }

        function setupUserDropdown() {
            const userProfileBtn = document.getElementById('user-profile-btn');
            const userDropdown = document.getElementById('user-dropdown');
            const logoutBtn = document.getElementById('logout-btn');

            if (userProfileBtn && userDropdown) {
                // Remover listener antigo (cloneNode hack)
                const newBtn = userProfileBtn.cloneNode(true);
                userProfileBtn.parentNode.replaceChild(newBtn, userProfileBtn);

                newBtn.addEventListener('click', function (e) {
                    e.stopPropagation();
                    // Alternar visualmente IMEDIATAMENTE
                    userDropdown.classList.toggle('show');

                    // Se abriu, carregar workspaces em background
                    if (userDropdown.classList.contains('show')) {
                        loadWorkspacesAsync();
                    }
                });

                // Função auxiliar para carregar workspaces
                async function loadWorkspacesAsync() {
                    try {
                        console.log('Carregando workspaces...');
                        const container = document.getElementById('workspace-list-container');
                        if (container) container.innerHTML = '<div style="padding:8px; text-align:center; font-size:12px; color:var(--text-sec);">Carregando escritórios...</div>';

                        const workspaces = await CollaboratorManager.listAccessibleWorkspaces();
                        console.log('Workspaces encontrados:', workspaces);

                        if (container) {
                            if (workspaces.length > 1) {
                                container.innerHTML = `
                                    <div style="padding: 8px 16px; border-top: 1px solid var(--outline-variant); margin-top: 8px;">
                                        <div style="font-size: 11px; font-weight: 600; color: var(--text-sec); margin-bottom: 8px; text-transform: uppercase;">
                                            Trocar Escritório
                                        </div>
                                        ${workspaces.map(ws => `
                                            <button onclick="CollaboratorManager.switchWorkspace('${ws.ownerId}', '${ws.name}')" 
                                                    class="dropdown-item ${ws.ownerId === window.currentWorkspaceOwnerId ? 'active' : ''}"
                                                    style="padding: 8px 0; font-size: 13px; width: 100%; text-align: left; display: flex; align-items: center; gap: 8px; background: none; border: none; cursor: pointer;">
                                                <i data-lucide="${ws.isOwner ? 'home' : 'briefcase'}" width="14"></i>
                                                <div style="flex: 1; overflow: hidden; text-overflow: ellipsis;">${ws.name}</div>
                                                ${ws.ownerId === window.currentWorkspaceOwnerId ? '<i data-lucide="check" width="14" style="color: var(--primary);"></i>' : ''}
                                                ${ws.permission ? `<span style="font-size:9px; background:var(--surface); padding:2px 4px; border-radius:4px; border:1px solid var(--outline-variant);">${ws.permission === 'admin' ? 'ADM' : ws.permission === 'editor' ? 'EDIT' : 'VER'}</span>` : ''}
                                            </button>
                                        `).join('')}
                                    </div>
                                `;
                                lucide.createIcons();
                            } else {
                                container.innerHTML = '';
                                // Opcional: Avisar que não tem outros
                                // container.innerHTML = '<div style="padding:8px; text-align:center; font-size:11px; color:var(--text-sec);">Nenhum escritório compartilhado</div>';
                            }
                        }
                    } catch (error) {
                        console.error('Erro ao carregar workspaces:', error);
                        const container = document.getElementById('workspace-list-container');
                        if (container) container.innerHTML = '<div style="padding:8px; color:var(--error); font-size:11px;">Erro ao carregar</div>';
                    }
                }

                // Fechar dropdown com ESC
                document.addEventListener('keydown', function (e) {
                    if (e.key === 'Escape') {
                        userDropdown.classList.remove('show');
                    }
                });
            }

            if (logoutBtn) {
                // Remover listener antigo
                const newLogoutBtn = logoutBtn.cloneNode(true);
                logoutBtn.parentNode.replaceChild(newLogoutBtn, logoutBtn);

                newLogoutBtn.addEventListener('click', function () {
                    if (confirm('Deseja realmente sair do sistema?')) {
                        signOut(auth);
                        userDropdown?.classList.remove('show');
                    }
                });
            }
        }

        function updateUserInfo() {
            const user = auth.currentUser;
            if (user) {
                const firstName = user.email ? user.email.split('@')[0] : 'Usuário';
                const initials = firstName.charAt(0).toUpperCase();

                // Atualizar avatar
                document.querySelectorAll('.user-avatar').forEach(avatar => {
                    avatar.textContent = initials;
                });

                // Atualizar nome
                document.querySelectorAll('.user-name').forEach(nameEl => {
                    nameEl.textContent = firstName.length > 10 ? firstName.substring(0, 10) + '...' : firstName;
                });

                // Atualizar email no dropdown
                const emailEl = document.getElementById('dropdown-email');
                if (emailEl && user.email) {
                    emailEl.textContent = user.email.length > 25 ? user.email.substring(0, 25) + '...' : user.email;
                }

                // Atualizar brand name com nome do usuário
                const brandName = document.querySelector('.brand-name');
                if (brandName && firstName) {
                    brandName.textContent = `Olá, ${firstName}`;
                }
            }
        }

        function updateHeaderStatus() {
            if (currentTab !== 'tasks') {
                const headerStatus = document.getElementById('header-status');
                if (headerStatus) headerStatus.style.display = 'none';
                return;
            }

            const today = new Date();
            today.setHours(0, 0, 0, 0);

            const completedTasks = allTasks.filter(task => task.completed).length;
            const pendingTasks = allTasks.filter(task => !task.completed).length;
            const todayTasks = allTasks.filter(task => {
                if (!task.deadline || task.completed) return false;
                const [y, m, d] = task.deadline.split('-').map(Number);
                const deadlineDate = new Date(y, m - 1, d);
                return deadlineDate.getTime() === today.getTime();
            }).length;

            // Atualizar contadores
            const completedEl = document.getElementById('status-completed');
            const pendingEl = document.getElementById('status-pending');
            const todayEl = document.getElementById('status-today');

            if (completedEl) completedEl.textContent = completedTasks;
            if (pendingEl) pendingEl.textContent = pendingTasks;
            if (todayEl) todayEl.textContent = todayTasks;

            // Mostrar barra de status
            const headerStatus = document.getElementById('header-status');
            if (headerStatus) {
                headerStatus.style.display = 'block';

                // Adicionar classe quando scrolled
                const appHeader = document.querySelector('.app-header');
                window.addEventListener('scroll', () => {
                    if (window.scrollY > 10) {
                        appHeader.classList.add('scrolled');
                    } else {
                        appHeader.classList.remove('scrolled');
                    }
                });
            }
        }

        // Adicionar eventos para gerar título automático
        document.addEventListener('DOMContentLoaded', function () {
            // Atualizar título quando selecionar obrigação
            const obligationSelect = document.getElementById('task-obligation');
            const referenceInput = document.getElementById('task-reference');

            if (obligationSelect) {
                obligationSelect.addEventListener('change', generateTaskTitle);
            }
            if (referenceInput) {
                referenceInput.addEventListener('change', generateTaskTitle);
            }
        });

        // SISTEMA DE NOTIFICAÇÕES (GLOBAL)
        window.NotificationSystem = {
            notifications: [],
            refreshInterval: null,
            urgentInterval: null,
            unsubscribeNotifications: null,

            // Tipos de notificação
            TYPES: {
                TASK_URGENT: {
                    icon: 'alert-circle',
                    color: 'error',
                    title: 'Tarefa Urgente'
                },
                TASK_TODAY: {
                    icon: 'clock',
                    color: 'warning',
                    title: 'Tarefa para Hoje'
                },
                TASK_OVERDUE: {
                    icon: 'alert-triangle',
                    color: 'error',
                    title: 'Tarefa Atrasada'
                },
                INVITE: {
                    icon: 'mail',
                    color: 'info',
                    title: 'Convite Recebido'
                },
                COLLABORATOR_ACTION: {
                    icon: 'users',
                    color: 'info',
                    title: 'Ação de Colaborador'
                },
                REMINDER: {
                    icon: 'bell',
                    color: 'warning',
                    title: 'Lembrete'
                },
                SYSTEM: {
                    icon: 'info',
                    color: 'info',
                    title: 'Sistema'
                }
            },

            // Inicializar
            init() {
                this.cleanup(); // Limpar anteriores se houver
                this.setupEventListeners();
                this.loadNotifications();
                this.startAutoRefresh();
            },

            // Configurar eventos
            setupEventListeners() {
                const btn = document.getElementById('notification-btn');
                const dropdown = document.getElementById('notification-dropdown');

                if (btn && dropdown) {
                    // Remover listener antigo se existir (hack simples)
                    const newBtn = btn.cloneNode(true);
                    btn.parentNode.replaceChild(newBtn, btn);

                    // Abrir/fechar dropdown
                    newBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        dropdown.classList.toggle('show');
                        if (dropdown.classList.contains('show')) {
                            this.markAllAsRead();
                        }
                    });
                }
            },

            // Carregar notificações do Firestore
            async loadNotifications() {
                if (!currentUser) return;

                try {
                    // Notificações salvas no Firestore
                    const notificationsRef = collection(db, 'artifacts', appId, 'users', currentUser.uid, 'notifications');
                    const q = query(notificationsRef, orderBy('createdAt', 'desc'), limit(50));

                    const unsubscribe = onSnapshot(q, (snapshot) => {
                        this.notifications = [];
                        snapshot.forEach(doc => {
                            this.notifications.push({ id: doc.id, ...doc.data() });
                        });

                        // Adicionar notificações dinâmicas
                        this.addDynamicNotifications();

                        // Atualizar UI
                        this.updateNotificationBadge();
                        this.renderNotificationList();
                    });

                    // Guardar unsubscribe para limpeza
                    this.unsubscribeNotifications = unsubscribe;

                } catch (error) {
                    console.error('Erro ao carregar notificações:', error);
                }
            },

            // Adicionar notificações dinâmicas (tarefas urgentes, etc)
            addDynamicNotifications() {
                const dynamicNotifs = [];
                const now = new Date();

                // 1. Tarefas atrasadas
                const overdueTasks = allTasks.filter(task => {
                    if (task.completed) return false;
                    if (!task.deadline) return false;
                    const deadline = new Date(task.deadline);
                    return deadline < now;
                });

                overdueTasks.forEach(task => {
                    const company = allCompanies.find(c => c.id === task.companyId);
                    dynamicNotifs.push({
                        id: `overdue_${task.id}`,
                        type: 'TASK_OVERDUE',
                        title: `Tarefa Atrasada: ${task.title}`,
                        description: company ? `Empresa: ${company.name}` : 'Tarefa sem empresa',
                        entityType: 'task',
                        entityId: task.id,
                        urgent: true,
                        createdAt: new Date(task.deadline),
                        unread: true
                    });
                });

                // 2. Tarefas para hoje
                const todayTasks = allTasks.filter(task => {
                    if (task.completed) return false;
                    if (!task.deadline) return false;
                    const deadline = new Date(task.deadline);
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    const tomorrow = new Date(today);
                    tomorrow.setDate(tomorrow.getDate() + 1);
                    return deadline >= today && deadline < tomorrow;
                });

                todayTasks.forEach(task => {
                    const company = allCompanies.find(c => c.id === task.companyId);
                    dynamicNotifs.push({
                        id: `today_${task.id}`,
                        type: 'TASK_TODAY',
                        title: `Tarefa para Hoje: ${task.title}`,
                        description: company ? `Vence hoje às 23:59 - ${company.name}` : 'Vence hoje',
                        entityType: 'task',
                        entityId: task.id,
                        urgent: true,
                        createdAt: new Date(),
                        unread: true
                    });
                });

                // 3. Convites pendentes
                CollaboratorManager.listMyInvites().then(invites => {
                    invites.forEach(invite => {
                        dynamicNotifs.push({
                            id: `invite_${invite.id}`,
                            type: 'INVITE',
                            title: `Convite de Colaboração`,
                            description: `Você foi convidado por ${invite.invitedBy}`,
                            entityType: 'invite',
                            entityId: invite.id,
                            urgent: false,
                            createdAt: invite.invitedAt,
                            unread: true
                        });
                    });

                    // Adicionar às notificações
                    this.notifications = [...dynamicNotifs, ...this.notifications];
                    this.updateNotificationBadge();
                    this.renderNotificationList();
                });
            },

            // Criar notificação no Firestore
            async createNotification(data) {
                if (!currentUser) return;

                try {
                    const notificationData = {
                        ...data,
                        userId: currentUser.uid,
                        userEmail: currentUser.email,
                        read: false,
                        createdAt: serverTimestamp(),
                        workspaceId: appId
                    };

                    await addDoc(
                        collection(db, 'artifacts', appId, 'users', currentUser.uid, 'notifications'),
                        notificationData
                    );

                    return true;
                } catch (error) {
                    console.error('Erro ao criar notificação:', error);
                    return false;
                }
            },

            // Marcar como lida
            async markAsRead(notificationId) {
                try {
                    // Se for notificação dinâmica, apenas remove da lista local
                    if (notificationId.startsWith('overdue_') || notificationId.startsWith('today_') || notificationId.startsWith('invite_')) {
                        this.notifications = this.notifications.filter(n => n.id !== notificationId);
                    } else {
                        // Se for do Firestore, atualiza
                        const notifRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'notifications', notificationId);
                        await updateDoc(notifRef, { read: true, readAt: serverTimestamp() });
                    }

                    this.updateNotificationBadge();
                    this.renderNotificationList();

                } catch (error) {
                    console.error('Erro ao marcar notificação como lida:', error);
                }
            },

            // Marcar todas como lidas
            async markAllAsRead() {
                try {
                    // Marcar dinâmicas como lidas (remover)
                    this.notifications = this.notifications.filter(n =>
                        !n.id.startsWith('overdue_') &&
                        !n.id.startsWith('today_') &&
                        !n.id.startsWith('invite_')
                    );

                    // Marcar do Firestore
                    const batch = writeBatch(db);
                    this.notifications.forEach(notif => {
                        if (!notif.id.startsWith('dynamic_')) {
                            const notifRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'notifications', notif.id);
                            batch.update(notifRef, { read: true, readAt: serverTimestamp() });
                        }
                    });

                    await batch.commit();

                    this.updateNotificationBadge();
                    this.renderNotificationList();
                    showToast('Todas as notificações marcadas como lidas', 'success');

                } catch (error) {
                    console.error('Erro ao marcar todas como lidas:', error);
                }
            },

            // Renderizar lista no dropdown
            renderNotificationList() {
                const container = document.getElementById('notification-list');
                if (!container) return;

                // Filtrar notificações não lidas + últimas 10 lidas
                const unread = this.notifications.filter(n => n.unread || !n.read);
                const recentRead = this.notifications.filter(n => !n.unread && n.read).slice(0, 10);
                const toShow = [...unread, ...recentRead].slice(0, 20); // Máximo 20

                if (toShow.length === 0) {
                    container.innerHTML = `
                <div class="notification-empty">
                    <i data-lucide="bell-off" width="32"></i>
                    <p>Nenhuma notificação</p>
                    <p style="font-size: 12px; margin-top: 4px;">Tudo em dia!</p>
                </div>
            `;
                    return;
                }

                container.innerHTML = toShow.map(notif => {
                    const typeConfig = this.TYPES[notif.type] || this.TYPES.SYSTEM;
                    const timeAgo = this.getTimeAgo(notif.createdAt);
                    const isUnread = notif.unread || !notif.read;

                    return `
                <div class="notification-item ${isUnread ? 'unread' : ''} ${notif.urgent ? 'urgent' : ''}" 
                     onclick="NotificationSystem.handleClick('${notif.id}', '${notif.entityType}', '${notif.entityId}')"
                     style="margin-bottom: 8px;">
                    <div style="display: flex; align-items: flex-start; gap: 12px;">
                        <div class="notification-icon ${typeConfig.color}">
                            <i data-lucide="${typeConfig.icon}" width="16"></i>
                        </div>
                        <div class="notification-content">
                            <div class="notification-title">${notif.title}</div>
                            <div class="notification-desc">${notif.description || ''}</div>
                            <div class="notification-time">
                                <i data-lucide="clock" width="10"></i>
                                ${timeAgo} • ${typeConfig.title}
                            </div>
                        </div>
                        <div style="margin-left: auto;">
                            <button onclick="event.stopPropagation(); NotificationSystem.markAsRead('${notif.id}')" 
                                    class="icon-btn" style="padding: 4px; opacity: 0.6;">
                                <i data-lucide="check" width="14"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
                }).join('');

                lucide.createIcons();
            },

            // Lidar com clique na notificação
            handleClick(notificationId, entityType, entityId) {
                // Marcar como lida
                this.markAsRead(notificationId);

                // Fechar dropdown
                document.getElementById('notification-dropdown')?.classList.remove('show');

                // Navegar para o item
                this.navigateToEntity(entityType, entityId);
            },

            // Navegar para a entidade
            navigateToEntity(entityType, entityId) {
                switch (entityType) {
                    case 'task':
                        // Navegar para tarefa
                        taskToHighlight = entityId;
                        switchTab('tasks');
                        setTimeout(() => {
                            highlightTask(entityId);
                        }, 300);
                        break;

                    case 'company':
                        // Navegar para empresa
                        selectedCompanyId = entityId;
                        switchTab('companies');
                        setTimeout(() => {
                            renderCompanyTasks();
                            // Scroll para empresa
                            const companyCard = document.querySelector(`[data-company-id="${entityId}"]`);
                            if (companyCard) {
                                companyCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                companyCard.classList.add('highlighted');
                                setTimeout(() => companyCard.classList.remove('highlighted'), 2000);
                            }
                        }, 300);
                        break;

                    case 'invite':
                        // Mostrar modal de convites
                        checkForPendingInvites();
                        break;

                    case 'note':
                        // Navegar para nota
                        const note = allNotes.find(n => n.id === entityId);
                        if (note) {
                            openNoteModal(note);
                        }
                        break;

                    default:
                        console.log('Navegação para:', entityType, entityId);
                }
            },

            // Atualizar badge
            updateNotificationBadge() {
                const badge = document.getElementById('notification-badge');
                if (!badge) return;

                const unreadCount = this.notifications.filter(n => n.unread || !n.read).length;

                if (unreadCount > 0) {
                    badge.textContent = unreadCount > 99 ? '99+' : unreadCount;
                    badge.classList.remove('hidden');

                    // Adicionar animação de pulsar para novas
                    if (unreadCount > parseInt(badge.textContent || '0')) {
                        badge.style.animation = 'pulse 0.5s 3';
                    }
                } else {
                    badge.classList.add('hidden');
                }
            },

            // Formatar tempo
            getTimeAgo(timestamp) {
                if (!timestamp) return 'Agora';

                const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
                const now = new Date();
                const diffMs = now - date;
                const diffSec = Math.floor(diffMs / 1000);
                const diffMin = Math.floor(diffSec / 60);
                const diffHour = Math.floor(diffMin / 60);
                const diffDay = Math.floor(diffHour / 24);

                if (diffSec < 60) return 'Agora';
                if (diffMin < 60) return `Há ${diffMin} min`;
                if (diffHour < 24) return `Há ${diffHour} h`;
                if (diffDay < 7) return `Há ${diffDay} d`;
                return date.toLocaleDateString('pt-BR');
            },

            // Atualização automática
            startAutoRefresh() {
                // Verificar novas notificações a cada minuto
                this.refreshInterval = setInterval(() => {
                    this.addDynamicNotifications();
                }, 60000);

                // Verificar tarefas urgentes a cada 30 segundos
                this.urgentInterval = setInterval(() => {
                    this.checkUrgentTasks();
                }, 30000);
            },

            // Verificar tarefas urgentes
            checkUrgentTasks() {
                const now = new Date();
                const oneHourFromNow = new Date(now.getTime() + 60 * 60 * 1000);

                allTasks.forEach(task => {
                    if (task.completed || !task.deadline) return;

                    const deadline = new Date(task.deadline);

                    // Se faltar menos de 1 hora
                    if (deadline > now && deadline < oneHourFromNow) {
                        // Verificar se já notificou
                        const alreadyNotified = this.notifications.some(n =>
                            n.id === `urgent_${task.id}` ||
                            (n.entityType === 'task' && n.entityId === task.id && n.type === 'TASK_URGENT')
                        );

                        if (!alreadyNotified) {
                            const company = allCompanies.find(c => c.id === task.companyId);
                            this.notifications.unshift({
                                id: `urgent_${task.id}`,
                                type: 'TASK_URGENT',
                                title: `Tarefa Urgente: ${task.title}`,
                                description: company ? `Vence em menos de 1 hora - ${company.name}` : 'Vence em menos de 1 hora',
                                entityType: 'task',
                                entityId: task.id,
                                urgent: true,
                                createdAt: new Date(),
                                unread: true
                            });

                            this.updateNotificationBadge();
                            this.renderNotificationList();

                            // Mostrar toast também
                            showToast(`⚠️ Tarefa urgente: ${task.title}`, 'warning');
                        }
                    }
                });
            },

            // Cleanup para evitar vazamento de memória ao trocar de workspace
            cleanup() {
                if (this.unsubscribeNotifications) {
                    this.unsubscribeNotifications();
                    this.unsubscribeNotifications = null;
                }
                if (this.refreshInterval) {
                    clearInterval(this.refreshInterval);
                    this.refreshInterval = null;
                }
                if (this.urgentInterval) {
                    clearInterval(this.urgentInterval);
                    this.urgentInterval = null;
                }
                this.notifications = [];
            },

            // Mostrar todas as notificações (modal maior)
            showAllNotifications() {
                const modal = document.createElement('div');
                modal.className = 'modal-overlay';
                modal.innerHTML = `
            <div class="modal" style="max-width: 600px; max-height: 80vh;">
                <div class="modal-header">
                    <h3><i data-lucide="bell"></i> Todas as Notificações</h3>
                    <button onclick="this.closest('.modal-overlay').remove()">
                        <i data-lucide="x"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div style="margin-bottom: 16px; display: flex; gap: 8px;">
                        <button onclick="NotificationSystem.filterNotifications('all')" class="btn-main" style="padding: 8px 16px; font-size: 13px;">
                            Todas
                        </button>
                        <button onclick="NotificationSystem.filterNotifications('unread')" class="btn-cancel" style="padding: 8px 16px; font-size: 13px;">
                            Não lidas
                        </button>
                        <button onclick="NotificationSystem.filterNotifications('urgent')" class="btn-cancel" style="padding: 8px 16px; font-size: 13px; color: var(--error);">
                            Urgentes
                        </button>
                    </div>
                    <div id="all-notifications-list" style="max-height: 400px; overflow-y: auto;">
                        Carregando...
                    </div>
                </div>
                <div class="modal-footer">
                    <button onclick="NotificationSystem.markAllAsRead()" class="btn-main">
                        <i data-lucide="check-circle"></i> Marcar todas como lidas
                    </button>
                    <button onclick="this.closest('.modal-overlay').remove()" class="btn-cancel">
                        Fechar
                    </button>
                </div>
            </div>
        `;

                document.body.appendChild(modal);
                this.renderAllNotifications();
                lucide.createIcons();
            },

            // Renderizar todas as notificações
            renderAllNotifications(filter = 'all') {
                const container = document.getElementById('all-notifications-list');
                if (!container) return;

                let filtered = this.notifications;

                if (filter === 'unread') {
                    filtered = this.notifications.filter(n => n.unread || !n.read);
                } else if (filter === 'urgent') {
                    filtered = this.notifications.filter(n => n.urgent);
                }

                if (filtered.length === 0) {
                    container.innerHTML = `
                <div class="notification-empty">
                    <i data-lucide="bell-off" width="48"></i>
                    <p>Nenhuma notificação ${filter === 'all' ? '' : filter}</p>
                </div>
            `;
                    return;
                }

                container.innerHTML = filtered.map(notif => {
                    const typeConfig = this.TYPES[notif.type] || this.TYPES.SYSTEM;
                    const timeAgo = this.getTimeAgo(notif.createdAt);
                    const isUnread = notif.unread || !notif.read;

                    return `
                <div class="notification-item ${isUnread ? 'unread' : ''} ${notif.urgent ? 'urgent' : ''}" 
                     onclick="NotificationSystem.handleClick('${notif.id}', '${notif.entityType}', '${notif.entityId}')"
                     style="margin-bottom: 8px;">
                    <div style="display: flex; align-items: flex-start; gap: 12px;">
                        <div class="notification-icon ${typeConfig.color}">
                            <i data-lucide="${typeConfig.icon}" width="16"></i>
                        </div>
                        <div class="notification-content">
                            <div class="notification-title">${notif.title}</div>
                            <div class="notification-desc">${notif.description || ''}</div>
                            <div class="notification-time">
                                <i data-lucide="clock" width="10"></i>
                                ${timeAgo} • ${typeConfig.title}
                            </div>
                        </div>
                        <div style="margin-left: auto;">
                            <button onclick="event.stopPropagation(); NotificationSystem.markAsRead('${notif.id}')" 
                                    class="icon-btn" style="padding: 4px; opacity: 0.6;">
                                <i data-lucide="check" width="14"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
                }).join('');

                lucide.createIcons();
            },

            // Filtrar notificações
            filterNotifications(filter) {
                this.renderAllNotifications(filter);
            },

            // Criar notificação para ação de colaborador
            async notifyCollaboratorAction(action, entityType, entityId, details) {
                const notification = {
                    type: 'COLLABORATOR_ACTION',
                    title: `Colaborador: ${action}`,
                    description: details,
                    entityType: entityType,
                    entityId: entityId,
                    urgent: false,
                    createdAt: new Date(),
                    unread: true
                };

                await this.createNotification(notification);
            }
        };

        // Função para inicializar o sistema de notificações
        function initNotificationSystem() {
            if (!currentUser) return;

            // Criar dropdown se não existir
            if (!document.getElementById('notification-dropdown')) {
                const dropdownHTML = `
            <div class="notification-dropdown hidden" id="notification-dropdown">
                <div class="notification-header">
                    <h4>Notificações</h4>
                    <button class="notification-clear" onclick="NotificationSystem.markAllAsRead()">
                        Limpar todas
                    </button>
                </div>
                <div class="notification-list" id="notification-list">
                    <!-- Notificações serão renderizadas aqui -->
                </div>
            </div>
        `;
                document.body.insertAdjacentHTML('beforeend', dropdownHTML);
            }

            // Inicializar o sistema de notificações
            setTimeout(() => {
                if (window.NotificationSystem && typeof window.NotificationSystem.init === 'function') {
                    window.NotificationSystem.init();
                }
            }, 1000);
        }

        function subscribeData() {
            if (!currentUser) return;



            setTimeout(() => {
                initNotificationSystem();
            }, 1000);

            // INICIALIZAR SISTEMA COLABORATIVO
            setTimeout(() => {
                RealTimeCollaboration.init();
                initCollaboratorsModal();

                // Adicionar botão de colaboradores na navegação
                addCollaboratorsToNavigation();
            }, 2000);

            // Seu código existente de sync continua aqui...
            const compRef = collection(db, 'artifacts', appId, 'users', window.currentWorkspaceOwnerId, 'companies');
            window.unsubCompanies = onSnapshot(compRef, (snap) => {
                allCompanies = [];
                snap.forEach(doc => {
                    const data = doc.data();
                    allCompanies.push({
                        id: doc.id,
                        ...data,
                        // Adicionar info de quem editou por último
                        lastEditor: data.lastUpdatedBy || data.createdBy || 'Desconhecido',
                        lastEditTime: data.lastUpdatedAt?.toDate?.() || data.createdAt?.toDate?.() || new Date()
                    });
                });
                allCompanies.sort((a, b) => a.name.localeCompare(b.name));
                renderCompanies();
                updateCompanyFilterSelect();
                renderTasks();
                updateMetrics();
                updateDashboardCounters();



                if (selectedCompanyId) {
                    renderCompanyTasks();
                }

                setTimeout(() => {
                    updateAllPins();
                }, 200);
            });


            // Inicializar sistemas auxiliares
            initNotesSystem();
            initInvitesSystem();


            // Tasks com info de colaboração
            const taskRef = collection(db, 'artifacts', appId, 'users', window.currentWorkspaceOwnerId, 'tasks');
            window.unsubTasks = onSnapshot(taskRef, (snap) => {
                allTasks = [];
                snap.forEach(doc => {
                    const taskData = doc.data();
                    allTasks.push({
                        id: doc.id,
                        ...taskData,
                        title: taskData.title || '',
                        companyId: taskData.companyId || '',
                        category: taskData.category || '',
                        completed: taskData.completed || false,
                        deadline: taskData.deadline || '',
                        description: taskData.description || '',
                        obligation: taskData.obligation || '',
                        value: taskData.value || '',
                        updatedAt: taskData.updatedAt || null,
                        createdAt: taskData.createdAt || null,
                        // Info de colaboração
                        lastEditor: taskData.lastUpdatedBy || taskData.createdBy || 'Desconhecido',
                        lastEditTime: taskData.lastUpdatedAt?.toDate?.() || taskData.createdAt?.toDate?.() || new Date(),
                        createdBy: taskData.createdBy || currentUser.email
                    });
                });

                allTasks.sort((a, b) => {
                    if (a.deadline && !b.deadline) return -1;
                    if (!a.deadline && b.deadline) return 1;
                    if (a.deadline && b.deadline) {
                        return a.deadline.localeCompare(b.deadline);
                    }
                    const aCreated = a.createdAt?.seconds || 0;
                    const bCreated = b.createdAt?.seconds || 0;
                    return bCreated - aCreated;
                });

                renderTasks();
                updateMetrics();
                updateDashboardCounters();

                if (selectedCompanyId) {
                    renderCompanyTasks();
                }

                setTimeout(() => {
                    updateAllPins();
                }, 200);
            });

            // Resto do seu código...
        }

        // Função para adicionar botão de colaboradores na navegação
        function addCollaboratorsToNavigation() {
            const navContainer = document.querySelector('.nav-container');
            if (!navContainer) return;

            // Verificar se já existe
            if (document.querySelector('.nav-item[onclick*="openCollaboratorsModal"]')) return;

            const collabBtn = document.createElement('button');
            collabBtn.className = 'nav-item';
            collabBtn.innerHTML = '<i data-lucide="users"></i><span>Colaboradores</span>';
            collabBtn.onclick = () => {
                // Fechar dropdown se existir
                document.getElementById('user-dropdown')?.classList.remove('show');

                // Abrir modal de colaboradores
                openCollaboratorsModal();
            };

            navContainer.appendChild(collabBtn);
            lucide.createIcons();
        }

        window.openCollaboratorsModal = function () {
            document.getElementById('modal-collaborators').classList.remove('hidden');
            refreshCollaboratorsList();
        };

        function addCollaborationInfoToCard(card, item, type) {
            // Adicionar badge de quem editou por último
            const editorBadge = document.createElement('div');
            editorBadge.className = 'editor-badge';
            editorBadge.style.cssText = `
    position: absolute;
    top: 8px;
    right: 8px;
    font-size: 10px;
    background: rgba(0,0,0,0.7);
    color: white;
    padding: 2px 6px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    gap: 3px;
    z-index: 10;
    max-width: 120px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  `;

            const editorName = item.lastEditor || item.createdBy || 'N/A';
            const isCurrentUser = editorName === currentUser.email;

            editorBadge.innerHTML = `
    <i data-lucide="${isCurrentUser ? 'user-check' : 'user'}" width="8"></i>
    ${isCurrentUser ? 'Você' : editorName.split('@')[0]}
  `;

            editorBadge.title = `Editado por ${editorName}`;

            // Adicionar botão de histórico
            const historyBtn = document.createElement('button');
            historyBtn.className = 'history-btn';
            historyBtn.style.cssText = `
    position: absolute;
    bottom: 8px;
    right: 8px;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    background: var(--surface-variant);
    border: none;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    z-index: 10;
    opacity: 0.7;
    transition: opacity 0.2s;
  `;
            historyBtn.innerHTML = '<i data-lucide="history" width="12"></i>';
            historyBtn.onclick = (e) => {
                e.stopPropagation();
                HistoryViewer.showEntityHistory(type, item.id);
            };
            historyBtn.onmouseenter = () => historyBtn.style.opacity = '1';
            historyBtn.onmouseleave = () => historyBtn.style.opacity = '0.7';

            // Garantir que o card tenha position relative
            card.style.position = 'relative';

            // Adicionar elementos ao card
            card.appendChild(editorBadge);
            card.appendChild(historyBtn);
        }

        // Atualizar métricas do dashboard
        function updateMetrics() {
            console.log('updateMetrics() chamada');

            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);

            let todayTasks = 0;
            let urgentTasks = 0;
            let completedToday = 0;
            let allPendingTasks = 0;

            allTasks.forEach(task => {
                if (!task.completed) allPendingTasks++;

                if (task.deadline) {
                    const [y, m, d] = task.deadline.split('-').map(Number);
                    const deadlineDate = new Date(y, m - 1, d);

                    // Tarefas para hoje
                    if (deadlineDate.getTime() === today.getTime() && !task.completed) {
                        todayTasks++;
                    }

                    // Tarefas urgentes (para hoje ou amanhã)
                    if (!task.completed && deadlineDate <= tomorrow) {
                        urgentTasks++;
                    }
                }

                // Tarefas concluídas hoje
                if (task.completed && task.updatedAt) {
                    const updatedDate = new Date(task.updatedAt.seconds * 1000);
                    if (updatedDate.getDate() === today.getDate() &&
                        updatedDate.getMonth() === today.getMonth() &&
                        updatedDate.getFullYear() === today.getFullYear()) {
                        completedToday++;
                    }
                }
            });

            // Atualizar elementos DOM
            const todayElement = document.getElementById('today-tasks');
            const urgentElement = document.getElementById('urgent-tasks');
            const completedElement = document.getElementById('completed-today');
            const allElement = document.getElementById('all-tasks');

            if (todayElement) todayElement.textContent = todayTasks;
            if (urgentElement) urgentElement.textContent = urgentTasks;
            if (completedElement) completedElement.textContent = completedToday;
            if (allElement) allElement.textContent = allPendingTasks;

            console.log('Métricas atualizadas:', { todayTasks, urgentTasks, completedToday, allPendingTasks });
        }



        // ============================================
        // NOTES HOVER PREVIEW
        // ============================================
        let notePreviewTimer = null;

        window.scheduleNotePreview = (noteJson) => {
            // Decodificar JSON seguro
            const note = JSON.parse(decodeURIComponent(noteJson));

            // Cancelar timer anterior se houver
            if (notePreviewTimer) clearTimeout(notePreviewTimer);

            // Iniciar novo timer (500ms delay)
            notePreviewTimer = setTimeout(() => {
                openCardNoteModal(note, 'note');
            }, 500);
        };

        window.cancelNotePreview = () => {
            if (notePreviewTimer) {
                clearTimeout(notePreviewTimer);
                notePreviewTimer = null;
            }
        };

        // PINS HOVER PREVIEW
        let pinPreviewTimer = null;
        let currentTooltip = null;
        window.schedulePinPreview = (pinJson) => {
            const pin = JSON.parse(decodeURIComponent(pinJson));
            if (pinPreviewTimer) clearTimeout(pinPreviewTimer);
            pinPreviewTimer = setTimeout(() => {
                openCardNoteModal(pin, 'pin');
            }, 500);
        };

        window.cancelPinPreview = () => {
            if (pinPreviewTimer) {
                clearTimeout(pinPreviewTimer);
                pinPreviewTimer = null;
            }
        };

        function showPinTooltip(element, pin) {
            // Remover tooltip anterior
            hidePinTooltip();

            // Criar tooltip
            const tooltip = document.createElement('div');
            tooltip.className = 'pin-tooltip';
            tooltip.innerHTML = `
        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
            <div style="width: 12px; height: 12px; border-radius: 50%; background: ${pin.color}"></div>
            <strong>${escapeHtml(pin.title)}</strong>
        </div>
        ${pin.comment ? `<div style="font-size: 12px; color: #666;">${escapeHtml(pin.comment.substring(0, 100))}${pin.comment.length > 100 ? '...' : ''}</div>` : ''}
        <div style="font-size: 10px; color: #999; margin-top: 4px;">
            ${new Date(pin.createdAt?.seconds * 1000 || Date.now()).toLocaleDateString('pt-BR')}
        </div>
    `;

            // Estilos
            Object.assign(tooltip.style, {
                position: 'fixed',
                background: 'white',
                border: '1px solid #ddd',
                borderRadius: '6px',
                padding: '8px',
                boxShadow: '0 4px 12px rgba(0,0,0,0.15)',
                zIndex: '9999',
                maxWidth: '250px',
                fontSize: '13px'
            });

            // Posicionar tooltip
            const rect = element.getBoundingClientRect();
            tooltip.style.left = `${rect.left + rect.width / 2 - 125}px`;
            tooltip.style.top = `${rect.top - 100}px`;

            document.body.appendChild(tooltip);
            currentTooltip = tooltip;
        }

        function hidePinTooltip() {
            if (currentTooltip) {
                currentTooltip.remove();
                currentTooltip = null;
            }
        }


        // ============================================
        // NOTES SYSTEM
        // ============================================

        function initNotesSystem() {
            if (!currentUser) return;
            // Subscribe to Notes
            const notesRef = collection(db, 'artifacts', appId, 'users', window.currentWorkspaceOwnerId, 'notes');
            window.unsubNotes = onSnapshot(notesRef, (snap) => {
                allNotes = [];
                snap.forEach(doc => allNotes.push({ id: doc.id, ...doc.data() }));
                renderNotes();
                checkReminders(); // Checar lembretes ao carregar
            });

            // Iniciar verificação periódica de lembretes (a cada 60s)
            setInterval(checkReminders, 60000);

        }

        window.renderNotes = () => {
            const list = document.getElementById('notes-list');
            const empty = document.getElementById('empty-notes');
            if (!list) return;

            list.innerHTML = '';

            // Ordenar: Lembretes pendentes primeiro, depois data de criação
            const sortedNotes = [...allNotes].sort((a, b) => {
                if (a.reminder && b.reminder) return new Date(a.reminder) - new Date(b.reminder);
                if (a.reminder) return -1;
                if (b.reminder) return 1;
                return b.createdAt - a.createdAt;
            });

            if (sortedNotes.length === 0) {
                empty.classList.remove('hidden');
                return;
            }
            empty.classList.add('hidden');

            sortedNotes.forEach(note => {
                const div = document.createElement('div');
                div.className = 'card note-card';
                // Click abre edição normal
                div.onclick = () => openNoteModal(note);

                // Hover abre preview (codificar JSON para evitar erro com aspas)
                const safeNote = encodeURIComponent(JSON.stringify(note));
                div.setAttribute('onmouseenter', `scheduleNotePreview('${safeNote}')`);
                div.setAttribute('onmouseleave', 'cancelNotePreview()');

                // Formatar data lembrete
                let reminderHtml = '';
                if (note.reminder) {
                    const reminderDate = new Date(note.reminder);
                    const isOverdue = reminderDate < new Date();
                    const options = { day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' };
                    const dateStr = reminderDate.toLocaleDateString('pt-BR', options);

                    reminderHtml = `
                        <div style="font-size: 0.75rem; color: ${isOverdue ? 'var(--danger)' : 'var(--accent)'}; margin-bottom: 8px; font-weight: 700; display: flex; align-items: center; gap: 4px;">
                            <i data-lucide="${isOverdue ? 'alert-circle' : 'bell'}" width="12"></i> 
                            ${dateStr}
                        </div>
                    `;
                }

                div.innerHTML = `
                    <div class="card-content">
                        ${reminderHtml}
                        <div class="card-title">${escapeHtml(note.title)}</div>
                        <div class="card-desc" style="-webkit-line-clamp: 4; line-clamp: 4;">${escapeHtml(note.content)}</div>
                    </div>
                `;
                list.appendChild(div);
            });
            lucide.createIcons();
        };

        window.openNoteModal = (note = null) => {
            const modal = document.getElementById('modal-note');

            // Limpar seção de comentários
            const commentsSection = document.getElementById('note-comments-section');
            const commentsList = document.getElementById('note-comments-list');
            document.getElementById('new-comment-text').value = '';
            document.getElementById('new-comment-reminder').value = '';
            commentsList.innerHTML = '';

            if (note) {
                document.getElementById('modal-note-title').textContent = 'Editar Anotação';
                document.getElementById('note-id').value = note.id;
                document.getElementById('note-title').value = note.title;
                document.getElementById('note-content').value = note.content;
                document.getElementById('note-reminder').value = note.reminder || '';
                document.getElementById('note-email-notify').checked = note.emailNotify || false;
                document.getElementById('btn-delete-note').classList.remove('hidden');

                // EXIBIR COMENTÁRIOS SE HOUVER OU SE FOR MODO EDIÇÃO
                commentsSection.classList.remove('hidden');

                if (note.comments && note.comments.length > 0) {
                    note.comments.forEach((comment, index) => {
                        const commentDiv = document.createElement('div');
                        commentDiv.className = 'note-comment';
                        commentDiv.style.background = '#f8fafc';
                        commentDiv.style.padding = '8px 12px';
                        commentDiv.style.borderRadius = '6px';
                        commentDiv.style.border = '1px solid var(--border)';

                        let reminderHtml = '';
                        if (comment.reminder) {
                            const [datePart, timePart] = comment.reminder.split('T');
                            const [y, m, d] = datePart.split('-');
                            const formattedDate = `${d}/${m}/${y} ${timePart}`;
                            const isOverdue = new Date(comment.reminder) < new Date();
                            reminderHtml = `<span style="font-size: 0.75rem; color: ${isOverdue ? '#ef4444' : '#f59e0b'}; display: flex; align-items: center; gap: 3px;"><i data-lucide="clock" width="10"></i> ${formattedDate}</span>`;
                        }

                        const date = new Date(comment.createdAt?.seconds ? comment.createdAt.seconds * 1000 : Date.now());

                        commentDiv.innerHTML = `
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 4px;">
                                <div style="font-weight: 500; font-size: 0.8rem; color: var(--text-sec);">${date.toLocaleDateString('pt-BR')} ${date.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })}</div>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    ${reminderHtml}
                                    <button class="icon-btn" onclick="deleteNoteComment('${note.id}', ${index})" style="color: var(--danger); opacity: 0.6; padding: 0;">
                                        <i data-lucide="x" width="12"></i>
                                    </button>
                                </div>
                            </div>
                            <div style="white-space: pre-wrap; font-size: 0.9rem; color: var(--text-main);">${escapeHtml(comment.text)}</div>
                        `;
                        commentsList.appendChild(commentDiv);
                    });
                } else {
                    commentsList.innerHTML = '<div style="font-size: 0.85rem; color: var(--text-sec); font-style: italic;">Nenhum comentário.</div>';
                }

            } else {
                document.getElementById('modal-note-title').textContent = 'Nova Anotação';
                document.getElementById('note-id').value = '';
                document.getElementById('note-title').value = '';
                document.getElementById('note-content').value = '';
                document.getElementById('note-reminder').value = '';
                document.getElementById('note-email-notify').checked = false;
                document.getElementById('btn-delete-note').classList.add('hidden');

                // ESCONDER SEÇÃO DE COMENTÁRIOS EM NOVA NOTA (SALVAR PRIMEIRO)
                commentsSection.classList.add('hidden');
            }
            modal.classList.remove('hidden');
            lucide.createIcons();
        };

        window.saveNote = async () => {
            const id = document.getElementById('note-id').value;
            const isUpdate = !!id;

            // Capturar dados antigos se for update
            let oldData = null;
            if (isUpdate) {
                oldData = allNotes.find(n => n.id === id);
            }

            const title = document.getElementById('note-title').value;
            const content = document.getElementById('note-content').value;
            const reminder = document.getElementById('note-reminder').value;
            const emailNotify = document.getElementById('note-email-notify').checked;

            if (!title) {
                showToast('Título obrigatório', 'error');
                return;
            }

            const data = {
                title,
                content,
                reminder,
                emailNotify,
                updatedAt: serverTimestamp(),
                lastUpdatedBy: currentUser.email,
                lastUpdatedAt: serverTimestamp(),
                updatedByUserId: currentUser.uid
            };

            // Adquirir lock de edição
            if (isUpdate) {
                await RealTimeCollaboration.acquireLock('note', id);
            }

            try {
                if (id) {
                    // LOG ANTES DE ATUALIZAR
                    await AuditLogger.autoLogUpdate('note', id, oldData, data);

                    await updateDoc(doc(db, 'artifacts', appId, 'users', window.currentWorkspaceOwnerId, 'notes', id), data);
                    showToast('Nota atualizada', 'success');
                } else {
                    data.createdAt = serverTimestamp();
                    data.createdBy = currentUser.email;
                    data.createdByUserId = currentUser.uid;
                    data.comments = [];

                    await addDoc(collection(db, 'artifacts', appId, 'users', window.currentWorkspaceOwnerId, 'notes'), data);

                    await AuditLogger.logAction('create', 'note', id, {
                        created: { old: null, new: data }
                    });

                    showToast('Nota criada', 'success');
                }

                closeModals();
            } catch (e) {
                console.error(e);
                showToast('Erro ao salvar', 'error');
            } finally {
                // Liberar lock
                if (isUpdate) {
                    await RealTimeCollaboration.releaseLock('note', id);
                }
            }
        };

        // Adicionar comentário à nota
        window.saveNoteComment = async () => {
            const noteId = document.getElementById('note-id').value;
            const text = document.getElementById('new-comment-text').value;
            const reminder = document.getElementById('new-comment-reminder').value;

            if (!noteId) return;
            if (!text.trim()) return showToast('Digite um comentário', 'warning');

            const newComment = {
                text: text,
                reminder: reminder || null,
                createdAt: new Date(), // Usando Date JS, Firestore converterá ou precisaria ser Timestamp se fosse strict
                createdBy: 'user'
            };

            try {
                const noteRef = doc(db, 'artifacts', appId, 'users', window.currentWorkspaceOwnerId, 'notes', noteId);
                // Obter nota atual para pegar array
                const currentNote = allNotes.find(n => n.id === noteId);
                const comments = currentNote.comments || [];
                comments.push(newComment);

                await updateDoc(noteRef, {
                    comments: comments,
                    updatedAt: serverTimestamp()
                });

                // Limpar campos
                document.getElementById('new-comment-text').value = '';
                document.getElementById('new-comment-reminder').value = '';

                // Forçar atualização visual do modal com o novo estado (pega do allNotes atualizado em breve)
                openNoteModal({ ...currentNote, comments: comments });
                showToast('Comentário adicionado', 'success');

            } catch (e) {
                console.error(e);
                showToast('Erro ao comentar', 'error');
            }
        };

        // Excluir comentário
        window.deleteNoteComment = async (noteId, index) => {
            if (!confirm('Excluir comentário?')) return;

            try {
                const noteRef = doc(db, 'artifacts', appId, 'users', window.currentWorkspaceOwnerId, 'notes', noteId);
                const currentNote = allNotes.find(n => n.id === noteId);
                const comments = [...(currentNote.comments || [])];

                if (index > -1 && index < comments.length) {
                    comments.splice(index, 1);
                    await updateDoc(noteRef, {
                        comments: comments,
                        updatedAt: serverTimestamp()
                    });
                    showToast('Comentário removido', 'success');

                    // Atualizar UI
                    openNoteModal({ ...currentNote, comments: comments });
                }
            } catch (e) {
                console.error(e);
                showToast('Erro ao excluir', 'error');
            }
        };

        window.confirmDeleteNote = () => {
            const id = document.getElementById('note-id').value;
            deletePending = { type: 'note', id: id };
            document.getElementById('delete-confirm-title').textContent = 'Excluir Nota';
            document.getElementById('delete-confirm-message').textContent = 'Tem certeza que deseja excluir esta anotação?';
            document.getElementById('modal-delete-confirm').classList.remove('hidden');
        };

        // Exemplo 1: Quando alguém convida você
        async function inviteUser(email) {
            // ... seu código de convite ...

            // Criar notificação para o convidado
            await NotificationSystem.createNotification({
                type: 'INVITE',
                title: 'Convite de Colaboração',
                description: `${currentUser.email} convidou você para colaborar`,
                entityType: 'invite',
                entityId: inviteId,
                urgent: false,
                createdAt: new Date()
            });
        }

        // Exemplo 2: Quando uma tarefa está prestes a vencer
        function checkTaskDeadlines() {
            allTasks.forEach(task => {
                if (!task.completed && task.deadline) {
                    const deadline = new Date(task.deadline);
                    const now = new Date();
                    const hoursDiff = (deadline - now) / (1000 * 60 * 60);

                    if (hoursDiff < 24 && hoursDiff > 0) {
                        NotificationSystem.createNotification({
                            type: 'TASK_URGENT',
                            title: `Tarefa vence em ${Math.ceil(hoursDiff)}h`,
                            description: task.title,
                            entityType: 'task',
                            entityId: task.id,
                            urgent: true,
                            createdAt: new Date()
                        });
                    }
                }
            });
        }

        // CHECK REMINDERS (Incluindo comentários)
        // CHECK REMINDERS (Incluindo comentários)
        async function checkReminders() {
            const now = new Date();
            let hasNotifications = false; // Manter para o badge, se necessário

            // Usar for...of para permitir await correto dentro do loop
            for (const note of allNotes) {
                // Checar lembrete principal da nota
                if (note.reminder) {
                    const reminderDate = new Date(note.reminder);
                    // Se passou da hora e ainda não enviou
                    if (reminderDate <= now) {
                        hasNotifications = true;

                        // Enviar Email se configurado e ainda não enviado
                        if (note.emailNotify && !note.emailSent) {
                            console.log('Enviando email para nota:', note.title);

                            // EmailJS Trigger
                            try {
                                const templateParams = {
                                    to_email: currentUser.email,
                                    note_title: note.title,
                                    note_content: note.content,
                                    reminder_date: new Date(note.reminder).toLocaleString('pt-BR')
                                };

                                // ⬇️ SUAS CHAVES AQUI ⬇️
                                await emailjs.send(
                                    "service_xh93ndo",      // Seu Service ID
                                    "template_akjxe6i",     // Seu Template ID
                                    templateParams
                                );
                                // ⬆️ SUAS CHAVES AQUI ⬆️

                                showToast(`Lembrete enviado por email: ${note.title}`, 'success');

                                // Marcar como enviado no Firestore para não enviar novamente
                                const noteRef = doc(db, 'artifacts', appId, 'users', window.currentWorkspaceOwnerId, 'notes', note.id);
                                await updateDoc(noteRef, {
                                    emailSent: true
                                });

                                // Atualizar localmente para evitar duplo envio antes do refresh do snapshot
                                note.emailSent = true;

                            } catch (e) {
                                console.error("Erro ao enviar email para nota " + note.title, e);
                                // Não mostramos toast de erro repetitivo aqui para não spammar o usuário se falhar em loop
                            }
                        }
                    }
                }
            }

            // Atualizar ícone de sino
            const badge = document.getElementById('notification-badge');
            if (badge) {
                if (hasNotifications) badge.classList.remove('hidden');
                else badge.classList.add('hidden');
            }
        }

        // Atualizar updateMetrics para incluir notas? Não necessário agora.
        // ============================================
        const AdvancedDashboard = {
            charts: {},

            // Inicializar todos os gráficos
            init() {
                if (currentTab !== 'dashboard') return;

                this.renderAllCharts();
                this.renderFinancialMetrics();
                this.renderProductivityHeatmap();
                this.renderAISuggestions();
            },

            // Renderizar todos os gráficos
            renderAllCharts() {
                // 1. Gráfico de evolução mensal
                this.renderMonthlyTrendChart();

                // 2. Gráfico de distribuição por regime
                this.renderRegimeDistributionChart();

                // 3. Gráfico de status de tarefas
                this.renderTaskStatusChart();

                addCollaborationInfoToCard(div, task, 'task');

                // 4. Gráfico de receita
                this.renderRevenueChart();
            },

            // 2. Gráfico de distribuição por regime
            renderRegimeDistributionChart() {
                const container = document.createElement('div');
                container.className = 'glass-panel';
                container.innerHTML = `
            <h3 style="font-size: 1rem; font-weight: 600; color: var(--text-main); margin-bottom: 20px; 
                       display: flex; align-items: center; gap: 8px;">
                <i data-lucide="pie-chart" width="18" style="color: var(--primary);"></i> 
                Carteira por Regime Tributário
            </h3>
            <div style="height: 250px; position: relative;">
                <canvas id="regime-distribution-chart"></canvas>
            </div>
        `;

                // Inserir após o segundo gráfico
                const existingPanels = document.querySelectorAll('.glass-panel');
                if (existingPanels.length >= 2) {
                    existingPanels[1].parentNode.insertBefore(container, existingPanels[1].nextSibling);
                }

                // Dados de distribuição
                const distributionData = this.getRegimeDistributionData();

                setTimeout(() => {
                    const ctx = document.getElementById('regime-distribution-chart').getContext('2d');
                    this.charts.regimeDistribution = new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: distributionData.labels,
                            datasets: [{
                                data: distributionData.data,
                                backgroundColor: [
                                    '#10b981', // Simples
                                    '#3b82f6', // Presumido
                                    '#8b5cf6', // Real
                                    '#f59e0b', // MEI
                                    '#ef4444', // Outros
                                    '#ec4899'  // Não informado
                                ],
                                borderWidth: 2,
                                borderColor: '#fff'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'right',
                                    labels: {
                                        padding: 20,
                                        usePointStyle: true
                                    }
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function (context) {
                                            const label = context.label || '';
                                            const value = context.raw || 0;
                                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                            const percentage = Math.round((value / total) * 100);
                                            return `${label}: ${value} (${percentage}%)`;
                                        }
                                    }
                                }
                            },
                            cutout: '60%'
                        }
                    });
                }, 100);
            },

            // 1. Gráfico de tendência mensal
            renderMonthlyTrendChart() {
                const container = document.createElement('div');
                container.className = 'glass-panel';
                container.innerHTML = `
            <h3 style="font-size: 1rem; font-weight: 600; color: var(--text-main); margin-bottom: 20px; 
                       display: flex; align-items: center; gap: 8px;">
                <i data-lucide="trending-up" width="18" style="color: var(--primary);"></i> 
                Evolução Mensal
            </h3>
            <div style="height: 250px;">
                <canvas id="monthly-trend-chart"></canvas>
            </div>
        `;

                // Inserir após o primeiro gráfico existente
                const existingChart = document.querySelector('.glass-panel');
                if (existingChart) {
                    existingChart.parentNode.insertBefore(container, existingChart.nextSibling);
                }

                // Dados dos últimos 6 meses
                const monthlyData = this.getMonthlyData(6);

                setTimeout(() => {
                    const ctx = document.getElementById('monthly-trend-chart').getContext('2d');
                    this.charts.monthlyTrend = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: monthlyData.labels,
                            datasets: [
                                {
                                    label: 'Tarefas Criadas',
                                    data: monthlyData.created,
                                    borderColor: '#3b82f6',
                                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                    borderWidth: 2,
                                    tension: 0.4,
                                    fill: true
                                },
                                {
                                    label: 'Tarefas Concluídas',
                                    data: monthlyData.completed,
                                    borderColor: '#10b981',
                                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                                    borderWidth: 2,
                                    tension: 0.4,
                                    fill: true
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'top',
                                },
                                tooltip: {
                                    mode: 'index',
                                    intersect: false
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    grid: {
                                        drawBorder: false
                                    }
                                },
                                x: {
                                    grid: {
                                        display: false
                                    }
                                }
                            }
                        }
                    });
                }, 100);
            },



            // 3. Gráfico de status de tarefas
            renderTaskStatusChart() {
                const container = document.createElement('div');
                container.className = 'glass-panel';
                container.innerHTML = `
            <h3 style="font-size: 1rem; font-weight: 600; color: var(--text-main); margin-bottom: 20px; 
                       display: flex; align-items: center; gap: 8px;">
                <i data-lucide="activity" width="18" style="color: var(--primary);"></i> 
                Status das Tarefas
            </h3>
            <div style="height: 250px;">
                <canvas id="task-status-chart"></canvas>
            </div>
        `;

                // Encontrar onde inserir
                const dashboardSplit = document.querySelector('.dashboard-split');
                if (dashboardSplit) {
                    dashboardSplit.parentNode.insertBefore(container, dashboardSplit);
                }

                // Dados de status
                const statusData = this.getTaskStatusData();

                setTimeout(() => {
                    const ctx = document.getElementById('task-status-chart').getContext('2d');
                    this.charts.taskStatus = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: statusData.categories,
                            datasets: [
                                {
                                    label: 'Pendentes',
                                    data: statusData.pending,
                                    backgroundColor: '#f59e0b',
                                    borderRadius: 6
                                },
                                {
                                    label: 'Concluídas',
                                    data: statusData.completed,
                                    backgroundColor: '#10b981',
                                    borderRadius: 6
                                },
                                {
                                    label: 'Atrasadas',
                                    data: statusData.overdue,
                                    backgroundColor: '#ef4444',
                                    borderRadius: 6
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'top',
                                }
                            },
                            scales: {
                                x: {
                                    grid: {
                                        display: false
                                    }
                                },
                                y: {
                                    beginAtZero: true,
                                    grid: {
                                        drawBorder: false
                                    }
                                }
                            }
                        }
                    });
                }, 100);
            },

            // 4. Gráfico de receita (se tiver dados financeiros)


            // Métricas financeiras
            renderFinancialMetrics() {
                const metrics = this.calculateFinancialMetrics();

                const container = document.createElement('div');
                container.className = 'financial-metrics-section';
                container.innerHTML = `
            <div class="section-title" style="margin: 30px 0 15px 0;">
                <i data-lucide="dollar-sign"></i> Métricas Financeiras
            </div>
            
            <div class="metrics-grid" style="grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px;">
                <div class="metric-card" onclick="AdvancedDashboard.showRevenueDetails()">
                    <div class="metric-icon" style="background: #f0f9ff; color: #0ea5e9;">
                        <i data-lucide="trending-up"></i>
                    </div>
                    <div class="metric-content">
                        <div class="metric-value">R$ ${metrics.monthlyRevenue.toFixed(2)}</div>
                        <div class="metric-label">Receita Mensal</div>
                    </div>
                </div>
                
                <div class="metric-card" onclick="AdvancedDashboard.showClientValue()">
                    <div class="metric-icon" style="background: #f0fdf4; color: #22c55e;">
                        <i data-lucide="users"></i>
                    </div>
                    <div class="metric-content">
                        <div class="metric-value">R$ ${metrics.avgClientValue.toFixed(2)}</div>
                        <div class="metric-label">Ticket Médio</div>
                    </div>
                </div>
                
                <div class="metric-card" onclick="AdvancedDashboard.showPendingPayments()">
                    <div class="metric-icon" style="background: #fef2f2; color: #ef4444;">
                        <i data-lucide="clock"></i>
                    </div>
                    <div class="metric-content">
                        <div class="metric-value">R$ ${metrics.pendingPayments.toFixed(2)}</div>
                        <div class="metric-label">A Receber</div>
                    </div>
                </div>
                
                <div class="metric-card" onclick="AdvancedDashboard.showEfficiency()">
                    <div class="metric-icon" style="background: #f5f3ff; color: #8b5cf6;">
                        <i data-lucide="zap"></i>
                    </div>
                    <div class="metric-content">
                        <div class="metric-value">${metrics.efficiency}%</div>
                        <div class="metric-label">Eficiência</div>
                    </div>
                </div>
            </div>
        `;

                // Inserir antes da seção de deadlines
                const deadlinesSection = document.querySelector('.deadlines-section');
                if (deadlinesSection) {
                    deadlinesSection.parentNode.insertBefore(container, deadlinesSection);
                }
            },

            // Heatmap de produtividade
            renderProductivityHeatmap() {
                const heatmapData = this.generateHeatmapData();

                const container = document.createElement('div');
                container.className = 'glass-panel';
                container.innerHTML = `
            <h3 style="font-size: 1rem; font-weight: 600; color: var(--text-main); margin-bottom: 20px; 
                       display: flex; align-items: center; gap: 8px;">
                <i data-lucide="calendar" width="18" style="color: var(--primary);"></i> 
                Produtividade (Últimas 12 Semanas)
            </h3>
            <div id="productivity-heatmap" style="height: 200px; overflow-x: auto;">
                <!-- Heatmap será gerado via JS -->
            </div>
        `;

                // Inserir na seção de gráficos
                const chartsContainer = document.querySelector('.charts-container') ||
                    document.querySelector('.dashboard-split')?.parentNode;
                if (chartsContainer) {
                    chartsContainer.appendChild(container);
                }

                // Gerar heatmap
                setTimeout(() => {
                    this.generateHeatmapHTML(heatmapData);
                }, 100);
            },

            // Sugestões de IA
            renderAISuggestions() {
                const container = document.createElement('div');
                container.className = 'ai-suggestions glass-panel';
                container.innerHTML = `
            <h3 style="font-size: 1rem; font-weight: 600; color: var(--text-main); margin-bottom: 20px; 
                       display: flex; align-items: center; gap: 8px;">
                <i data-lucide="sparkles" width="18" style="color: var(--primary);"></i> 
                Sugestões Inteligentes
                <button onclick="AdvancedDashboard.refreshSuggestions()" class="icon-btn" 
                        style="margin-left: auto; padding: 4px;">
                    <i data-lucide="refresh-cw" width="14"></i>
                </button>
            </h3>
            <div id="ai-suggestions-content" style="min-height: 120px; display: flex; align-items: center; justify-content: center;">
                <div class="loading-spinner"></div>
                <p style="margin-left: 10px; color: var(--text-sec);">Analisando dados...</p>
            </div>
        `;

                // Inserir após métricas financeiras
                const financialMetrics = document.querySelector('.financial-metrics-section');
                if (financialMetrics) {
                    financialMetrics.parentNode.insertBefore(container, financialMetrics.nextSibling);
                }

                // Carregar sugestões
                setTimeout(() => this.loadAISuggestions(), 1500);
            },

            // Funções auxiliares para dados
            getMonthlyData(months = 6) {
                const result = {
                    labels: [],
                    created: [],
                    completed: []
                };

                const hoje = new Date();

                for (let i = months - 1; i >= 0; i--) {
                    const date = new Date(hoje.getFullYear(), hoje.getMonth() - i, 1);
                    const monthLabel = date.toLocaleDateString('pt-BR', { month: 'short' });
                    result.labels.push(monthLabel.charAt(0).toUpperCase() + monthLabel.slice(1));

                    // Contar tarefas criadas neste mês
                    const createdCount = allTasks.filter(task => {
                        const taskDate = task.createdAt?.seconds
                            ? new Date(task.createdAt.seconds * 1000)
                            : new Date();
                        return taskDate.getMonth() === date.getMonth() &&
                            taskDate.getFullYear() === date.getFullYear();
                    }).length;

                    // Contar tarefas concluídas neste mês
                    const completedCount = allTasks.filter(task => {
                        if (!task.completed || !task.updatedAt) return false;
                        const taskDate = new Date(task.updatedAt.seconds * 1000);
                        return taskDate.getMonth() === date.getMonth() &&
                            taskDate.getFullYear() === date.getFullYear();
                    }).length;

                    result.created.push(createdCount);
                    result.completed.push(completedCount);
                }

                return result;
            },

            getRegimeDistributionData() {
                const regimes = {
                    'SIMPLES': 0,
                    'PRESUMIDO': 0,
                    'REAL': 0,
                    'MEI': 0,
                    'OUTROS': 0,
                    'NÃO INFORMADO': 0
                };

                allCompanies.forEach(company => {
                    if (company.type === 'MEI') {
                        regimes['MEI']++;
                    } else if (company.regime && regimes[company.regime] !== undefined) {
                        regimes[company.regime]++;
                    } else if (company.regime) {
                        regimes['OUTROS']++;
                    } else {
                        regimes['NÃO INFORMADO']++;
                    }
                });

                // Filtrar apenas regimes com empresas
                const filteredData = {};
                Object.entries(regimes).forEach(([regime, count]) => {
                    if (count > 0) filteredData[regime] = count;
                });

                return {
                    labels: Object.keys(filteredData),
                    data: Object.values(filteredData)
                };
            },

            getTaskStatusData() {
                const categories = ['FISCAL', 'TRABALHISTA', 'CONTABIL', 'MUNICIPAL', 'OUTROS'];
                const result = {
                    categories: categories,
                    pending: [],
                    completed: [],
                    overdue: []
                };

                const hoje = new Date();

                categories.forEach(category => {
                    const categoryTasks = allTasks.filter(task => task.category === category ||
                        (category === 'OUTROS' && !categories.includes(task.category)));

                    result.pending.push(categoryTasks.filter(t => !t.completed).length);
                    result.completed.push(categoryTasks.filter(t => t.completed).length);

                    // Tarefas atrasadas
                    const overdue = categoryTasks.filter(t => {
                        if (t.completed || !t.deadline) return false;
                        return new Date(t.deadline) < hoje;
                    }).length;
                    result.overdue.push(overdue);
                });

                return result;
            },

            getRevenueData() {
                // Simulação de dados financeiros - você pode adaptar com dados reais
                const hoje = new Date();
                const months = [];
                const values = [];
                let total = 0;

                for (let i = 5; i >= 0; i--) {
                    const date = new Date(hoje.getFullYear(), hoje.getMonth() - i, 1);
                    const monthLabel = date.toLocaleDateString('pt-BR', { month: 'short' });
                    months.push(monthLabel.charAt(0).toUpperCase() + monthLabel.slice(1));

                    // Simular receita baseada no número de empresas e tarefas
                    const baseValue = allCompanies.length * 150 + allTasks.length * 25;
                    const randomFactor = 0.8 + Math.random() * 0.4; // Variação de 80-120%
                    const monthlyValue = Math.round(baseValue * randomFactor / 6); // Distribuído pelos meses

                    values.push(monthlyValue);
                    total += monthlyValue;
                }

                return {
                    months: months,
                    values: values,
                    total: total,
                    monthlyAvg: total / 6
                };
            },

            calculateFinancialMetrics() {
                // Métricas simuladas - adapte com sua lógica real
                const totalCompanies = allCompanies.length;
                const totalTasks = allTasks.length;

                return {
                    monthlyRevenue: totalCompanies * 200 + totalTasks * 30,
                    avgClientValue: totalCompanies > 0 ? (totalCompanies * 200) / totalCompanies : 0,
                    pendingPayments: allTasks
                        .filter(t => t.paymentStatus === 'PENDENTE' && t.value)
                        .reduce((sum, t) => sum + (parseFloat(t.value) || 0), 0),
                    efficiency: allTasks.length > 0
                        ? Math.round((allTasks.filter(t => t.completed).length / allTasks.length) * 100)
                        : 0
                };
            },

            generateHeatmapData() {
                const hoje = new Date();
                const data = [];

                // Últimas 12 semanas
                for (let week = 11; week >= 0; week--) {
                    const weekStart = new Date(hoje);
                    weekStart.setDate(hoje.getDate() - (week * 7));

                    const weekData = {
                        date: weekStart,
                        days: []
                    };

                    // 7 dias da semana
                    for (let day = 0; day < 7; day++) {
                        const dayDate = new Date(weekStart);
                        dayDate.setDate(weekStart.getDate() + day);

                        // Contar tarefas concluídas neste dia
                        const tasksCompleted = allTasks.filter(task => {
                            if (!task.completed || !task.updatedAt) return false;
                            const taskDate = new Date(task.updatedAt.seconds * 1000);
                            return taskDate.toDateString() === dayDate.toDateString();
                        }).length;

                        weekData.days.push({
                            date: dayDate,
                            count: tasksCompleted,
                            intensity: Math.min(tasksCompleted / 5, 1) // Normalizar para 0-1
                        });
                    }

                    data.push(weekData);
                }

                return data;
            },

            generateHeatmapHTML(data) {
                const container = document.getElementById('productivity-heatmap');
                if (!container) return;

                const daysOfWeek = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'];

                let html = `
            <div style="display: flex; gap: 4px; min-width: 600px;">
                <div style="display: flex; flex-direction: column; gap: 4px; margin-right: 8px;">
                    ${daysOfWeek.map(day => `
                        <div style="height: 20px; display: flex; align-items: center; justify-content: flex-end; 
                             padding-right: 8px; font-size: 11px; color: var(--text-sec);">
                            ${day}
                        </div>
                    `).join('')}
                </div>
        `;

                data.forEach(week => {
                    html += `<div style="display: flex; flex-direction: column; gap: 4px;">`;

                    week.days.forEach(day => {
                        const intensity = day.intensity;
                        const color = intensity === 0 ? '#f1f5f9' :
                            intensity < 0.25 ? '#dbeafe' :
                                intensity < 0.5 ? '#93c5fd' :
                                    intensity < 0.75 ? '#3b82f6' : '#1d4ed8';

                        html += `
                    <div title="${day.date.toLocaleDateString('pt-BR')}: ${day.count} tarefas" 
                         style="width: 20px; height: 20px; background: ${color}; border-radius: 3px; 
                                cursor: pointer; transition: transform 0.2s;"
                         onmouseover="this.style.transform='scale(1.2)'"
                         onmouseout="this.style.transform='scale(1)'">
                    </div>
                `;
                    });

                    html += `</div>`;
                });

                html += `</div>`;

                // Legenda
                html += `
            <div style="display: flex; align-items: center; gap: 10px; margin-top: 15px; font-size: 11px; color: var(--text-sec);">
                <span>Menos produtivo</span>
                <div style="display: flex; gap: 3px;">
                    <div style="width: 12px; height: 12px; background: #f1f5f9; border-radius: 2px;"></div>
                    <div style="width: 12px; height: 12px; background: #dbeafe; border-radius: 2px;"></div>
                    <div style="width: 12px; height: 12px; background: #93c5fd; border-radius: 2px;"></div>
                    <div style="width: 12px; height: 12px; background: #3b82f6; border-radius: 2px;"></div>
                    <div style="width: 12px; height: 12px; background: #1d4ed8; border-radius: 2px;"></div>
                </div>
                <span>Mais produtivo</span>
            </div>
        `;

                container.innerHTML = html;
            },

            async loadAISuggestions() {
                const container = document.getElementById('ai-suggestions-content');
                if (!container) return;

                // Simulação de sugestões baseadas em dados
                const suggestions = this.generateSuggestionsFromData();

                container.innerHTML = `
            <div style="display: flex; flex-direction: column; gap: 12px; width: 100%;">
                ${suggestions.map(suggestion => `
                    <div style="background: ${suggestion.type === 'warning' ? '#fef2f2' : '#f0f9ff'}; 
                         border-left: 3px solid ${suggestion.type === 'warning' ? '#ef4444' : '#0ea5e9'};
                         padding: 10px 12px; border-radius: 6px;">
                        <div style="display: flex; align-items: flex-start; gap: 8px;">
                            <i data-lucide="${suggestion.icon}" width="16" 
                               style="color: ${suggestion.type === 'warning' ? '#ef4444' : '#0ea5e9'}; margin-top: 2px;"></i>
                            <div style="flex: 1;">
                                <div style="font-weight: 600; margin-bottom: 4px;">${suggestion.title}</div>
                                <div style="font-size: 13px; color: var(--text-sec);">${suggestion.description}</div>
                                ${suggestion.action ? `
                                    <button onclick="${suggestion.action}" 
                                            style="margin-top: 8px; font-size: 12px; padding: 4px 8px; 
                                                   background: ${suggestion.type === 'warning' ? '#ef4444' : '#0ea5e9'}; 
                                                   color: white; border: none; border-radius: 4px; cursor: pointer;">
                                        ${suggestion.actionText}
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `).join('')}
            </div>
        `;

                lucide.createIcons();
            },

            generateSuggestionsFromData() {
                const suggestions = [];
                const hoje = new Date();

                // 1. Verificar tarefas atrasadas
                const overdueTasks = allTasks.filter(t => {
                    if (t.completed || !t.deadline) return false;
                    return new Date(t.deadline) < hoje;
                });

                if (overdueTasks.length > 0) {
                    suggestions.push({
                        type: 'warning',
                        icon: 'alert-triangle',
                        title: `${overdueTasks.length} tarefa(s) atrasada(s)`,
                        description: `Priorize as tarefas vencidas para evitar problemas.`,
                        action: 'switchTab("tasks"); setTaskFilter("urgent")',
                        actionText: 'Ver Tarefas Urgentes'
                    });
                }

                // 2. Sugerir empresas sem tarefas recentes
                const companiesWithoutRecentTasks = allCompanies.filter(company => {
                    const companyTasks = allTasks.filter(t => t.companyId === company.id);
                    const recentTasks = companyTasks.filter(t => {
                        if (!t.updatedAt) return false;
                        const taskDate = new Date(t.updatedAt.seconds * 1000);
                        const daysDiff = (hoje - taskDate) / (1000 * 60 * 60 * 24);
                        return daysDiff < 30;
                    });
                    return recentTasks.length === 0 && companyTasks.length > 0;
                });

                if (companiesWithoutRecentTasks.length > 0) {
                    suggestions.push({
                        type: 'info',
                        icon: 'building-2',
                        title: `${companiesWithoutRecentTasks.length} empresa(s) sem atividades recentes`,
                        description: `Considere fazer um follow-up com estas empresas.`,
                        action: `filterCompaniesWithoutRecentTasks()`,
                        actionText: 'Ver Empresas'
                    });
                }

                // 3. Sugerir geração de relatório se não houver recente
                suggestions.push({
                    type: 'info',
                    icon: 'file-text',
                    title: 'Relatório semanal pendente',
                    description: 'Gere o relatório semanal para acompanhar o progresso.',
                    action: 'ReportSystem.generateWeeklyReport()',
                    actionText: 'Gerar Relatório'
                });

                // 4. Sugerir otimização se muitas tarefas pendentes
                const pendingTasks = allTasks.filter(t => !t.completed).length;
                if (pendingTasks > 20) {
                    suggestions.push({
                        type: 'warning',
                        icon: 'filter',
                        title: 'Muitas tarefas pendentes',
                        description: `Considere delegar ou usar templates para ${pendingTasks} tarefas pendentes.`,
                        action: '',
                        actionText: ''
                    });
                }

                return suggestions.slice(0, 3); // Limitar a 3 sugestões
            },

            // Métodos para ações dos botões
            showRevenueDetails() {
                alert('Detalhes de receita:\n' +
                    `Total Empresas: ${allCompanies.length}\n` +
                    `Tarefas Ativas: ${allTasks.length}\n` +
                    `Receita Mensal Estimada: R$ ${this.calculateFinancialMetrics().monthlyRevenue.toFixed(2)}`);
            },

            refreshSuggestions() {
                const container = document.getElementById('ai-suggestions-content');
                if (container) {
                    container.innerHTML = `
                <div class="loading-spinner"></div>
                <p style="margin-left: 10px; color: var(--text-sec);">Atualizando sugestões...</p>
            `;
                    setTimeout(() => this.loadAISuggestions(), 1000);
                }
            }
        };

        const HistoryViewer = {
            async showEntityHistory(entityType, entityId) {
                try {
                    const history = await AuditLogger.getEntityHistory(entityType, entityId);
                    const entity = this.getEntityData(entityType, entityId);

                    const modal = document.createElement('div');
                    modal.className = 'modal-overlay';
                    modal.innerHTML = `
        <div class="modal" style="max-width: 800px; max-height: 90vh;">
          <div class="modal-header">
            <h3><i data-lucide="history"></i> Histórico de Alterações</h3>
            <button onclick="this.closest('.modal-overlay').remove()"><i data-lucide="x"></i></button>
          </div>
          <div class="modal-body" style="overflow-y: auto;">
            ${this.renderEntityHeader(entityType, entity)}
            ${this.renderHistoryTimeline(history)}
          </div>
          <div class="modal-footer">
            <button onclick="this.closest('.modal-overlay').remove()" class="btn-cancel">
              Fechar
            </button>
            <button onclick="HistoryViewer.exportEntityHistory('${entityType}', '${entityId}')" class="btn-main">
              <i data-lucide="download"></i> Exportar Histórico
            </button>
          </div>
        </div>
      `;

                    document.body.appendChild(modal);
                    lucide.createIcons();
                } catch (error) {
                    console.error('Erro ao mostrar histórico:', error);
                    showToast('Erro ao carregar histórico', 'error');
                }
            },

            getEntityData(entityType, entityId) {
                switch (entityType) {
                    case 'task':
                        return allTasks.find(t => t.id === entityId);
                    case 'company':
                        return allCompanies.find(c => c.id === entityId);
                    case 'note':
                        return allNotes.find(n => n.id === entityId);
                    case 'pin':
                        return allPins.find(p => p.id === entityId);
                    default:
                        return null;
                }
            },

            renderEntityHeader(entityType, entity) {
                if (!entity) return '';

                const entityNames = {
                    'task': 'Tarefa',
                    'company': 'Empresa',
                    'note': 'Nota',
                    'pin': 'Etiqueta'
                };

                return `
      <div style="background: var(--surface-variant); padding: 16px; border-radius: var(--radius-lg); margin-bottom: 20px;">
        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
          <div style="width: 40px; height: 40px; border-radius: var(--radius-lg); 
                      background: linear-gradient(135deg, var(--primary), var(--primary-variant));
                      display: flex; align-items: center; justify-content: center;">
            <i data-lucide="${this.getEntityIcon(entityType)}" width="20" style="color: white;"></i>
          </div>
          <div style="flex: 1;">
            <h4 style="margin: 0; font-size: 16px;">${entity.title || entity.name || 'Sem título'}</h4>
            <div style="font-size: 13px; color: var(--on-surface-variant);">
              ${entityNames[entityType]} • ID: ${entity.id.substring(0, 8)}...
            </div>
          </div>
        </div>
        <div style="display: flex; gap: 16px; font-size: 13px; color: var(--on-surface-variant);">
          <div>
            <strong>Criado por:</strong> ${entity.createdBy || 'Desconhecido'}
          </div>
          <div>
            <strong>Última edição:</strong> ${entity.lastEditor || 'Desconhecido'}
          </div>
          ${entity.lastEditTime ? `
            <div>
              <strong>Em:</strong> ${entity.lastEditTime.toLocaleString('pt-BR')}
            </div>
          ` : ''}
        </div>
      </div>
    `;
            },

            renderHistoryTimeline(history) {
                if (history.length === 0) {
                    return `
        <div style="text-align: center; padding: 40px; color: var(--on-surface-variant);">
          <i data-lucide="clock" width="48" style="opacity: 0.5; margin-bottom: 12px;"></i>
          <p>Nenhum histórico de alterações encontrado.</p>
        </div>
      `;
                }

                return `
      <div style="position: relative; padding-left: 24px;">
        <!-- Linha vertical da timeline -->
        <div style="position: absolute; left: 11px; top: 0; bottom: 0; width: 2px; background: var(--outline-variant);"></div>
        
        ${history.map((item, index) => `
          <div style="position: relative; margin-bottom: 20px;">
            <!-- Ponto da timeline -->
            <div style="position: absolute; left: -24px; top: 4px; width: 20px; height: 20px; 
                        border-radius: 50%; background: ${this.getActionColor(item.action)}; 
                        border: 3px solid var(--surface);"></div>
            
            <!-- Card do evento -->
            <div style="background: var(--surface); border: 1px solid var(--outline-variant); 
                        border-radius: var(--radius-lg); padding: 16px; margin-left: 12px;">
              <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
                <div style="display: flex; align-items: center; gap: 8px;">
                  <div style="width: 32px; height: 32px; border-radius: 50%; 
                              background: ${this.getActionColor(item.action)}20;
                              display: flex; align-items: center; justify-content: center;">
                    <i data-lucide="${this.getActionIcon(item.action)}" width="14" 
                       style="color: ${this.getActionColor(item.action)};"></i>
                  </div>
                  <div>
                    <div style="font-weight: 600; font-size: 14px;">
                      ${item.userEmail?.split('@')[0] || 'Usuário'}
                    </div>
                    <div style="font-size: 12px; color: var(--on-surface-variant);">
                      ${this.getActionText(item.action)}
                    </div>
                  </div>
                </div>
                <div style="font-size: 12px; color: var(--on-surface-variant);">
                  ${item.timestampFormatted}
                </div>
              </div>
              
              ${this.renderChanges(item.changes)}
              
              ${item.ipAddress && item.ipAddress !== 'unknown' ? `
                <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid var(--surface-variant); 
                            font-size: 11px; color: var(--outline);">
                  IP: ${item.ipAddress}
                </div>
              ` : ''}
            </div>
          </div>
        `).join('')}
      </div>
    `;
            },

            renderChanges(changes) {
                if (!changes || Object.keys(changes).length === 0) return '';

                return `
      <div style="background: var(--surface-variant); border-radius: var(--radius-md); padding: 12px;">
        <div style="font-size: 12px; font-weight: 600; margin-bottom: 8px; color: var(--on-surface-variant);">
          Alterações realizadas:
        </div>
        <div style="display: flex; flex-direction: column; gap: 6px; font-size: 13px;">
          ${Object.entries(changes).map(([field, values]) => `
            <div style="display: flex; align-items: flex-start; gap: 8px;">
              <div style="flex: 0 0 120px; font-weight: 500; color: var(--on-surface);">
                ${this.formatFieldName(field)}:
              </div>
              <div style="flex: 1; display: flex; align-items: center; gap: 8px;">
                <div style="flex: 1; padding: 4px 8px; background: rgba(239, 68, 68, 0.1); 
                            border-radius: 4px; font-size: 12px; color: #ef4444; 
                            text-decoration: line-through; word-break: break-word;">
                  ${values.old !== null && values.old !== undefined ?
                        this.formatValue(values.old) : '<span style="color: #999;">(vazio)</span>'}
                </div>
                <i data-lucide="arrow-right" width="12" style="color: var(--outline);"></i>
                <div style="flex: 1; padding: 4px 8px; background: rgba(16, 185, 129, 0.1); 
                            border-radius: 4px; font-size: 12px; color: #10b981; 
                            font-weight: 500; word-break: break-word;">
                  ${values.new !== null && values.new !== undefined ?
                        this.formatValue(values.new) : '<span style="color: #999;">(vazio)</span>'}
                </div>
              </div>
            </div>
          `).join('')}
        </div>
      </div>
    `;
            },

            formatFieldName(field) {
                const names = {
                    'title': 'Título',
                    'description': 'Descrição',
                    'deadline': 'Prazo',
                    'completed': 'Status',
                    'category': 'Categoria',
                    'value': 'Valor',
                    'name': 'Nome',
                    'cnpj': 'CNPJ',
                    'phone': 'Telefone',
                    'email': 'E-mail',
                    'content': 'Conteúdo',
                    'color': 'Cor',
                    'priority': 'Prioridade'
                };
                return names[field] || field.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            },

            formatValue(value) {
                if (value === null || value === undefined) return '(vazio)';
                if (typeof value === 'boolean') return value ? 'Sim' : 'Não';
                if (typeof value === 'object') return JSON.stringify(value);
                if (typeof value === 'string' && value.length > 50) return value.substring(0, 50) + '...';
                return String(value);
            },

            getEntityIcon(entityType) {
                const icons = {
                    'task': 'check-square',
                    'company': 'building-2',
                    'note': 'notebook',
                    'pin': 'tag'
                };
                return icons[entityType] || 'file';
            },

            getActionColor(action) {
                const colors = {
                    'create': '#10b981',
                    'update': '#3b82f6',
                    'delete': '#ef4444',
                    'view': '#6b7280',
                    'status_change': '#8b5cf6',
                    'share': '#ec4899',
                    'invite': '#f59e0b'
                };
                return colors[action] || '#6b7280';
            },

            getActionIcon(action) {
                const icons = {
                    'create': 'plus-circle',
                    'update': 'edit-2',
                    'delete': 'trash-2',
                    'view': 'eye',
                    'status_change': 'refresh-cw',
                    'share': 'share-2',
                    'invite': 'user-plus'
                };
                return icons[action] || 'activity';
            },

            getActionText(action) {
                const texts = {
                    'create': 'Criou este item',
                    'update': 'Atualizou este item',
                    'delete': 'Excluiu este item',
                    'view': 'Visualizou este item',
                    'status_change': 'Alterou o status',
                    'share': 'Compartilhou este item',
                    'invite': 'Convidou colaborador'
                };
                return texts[action] || 'Realizou ação';
            },

            async exportEntityHistory(entityType, entityId) {
                try {
                    const history = await AuditLogger.getEntityHistory(entityType, entityId, 100);
                    const entity = this.getEntityData(entityType, entityId);

                    const csvData = [
                        ['Histórico de Alterações'],
                        [`Entidade: ${entityType}, ID: ${entityId}`],
                        [`Título: ${entity?.title || entity?.name || 'N/A'}`],
                        [''],
                        ['Data/Hora', 'Usuário', 'Ação', 'Campo', 'Valor Antigo', 'Valor Novo', 'IP']
                    ];

                    history.forEach(item => {
                        if (item.changes) {
                            Object.entries(item.changes).forEach(([field, values]) => {
                                csvData.push([
                                    item.timestampFormatted,
                                    item.userEmail,
                                    item.action,
                                    field,
                                    this.formatValue(values.old),
                                    this.formatValue(values.new),
                                    item.ipAddress || 'N/A'
                                ]);
                            });
                        } else {
                            csvData.push([
                                item.timestampFormatted,
                                item.userEmail,
                                item.action,
                                'Geral',
                                'N/A',
                                'N/A',
                                item.ipAddress || 'N/A'
                            ]);
                        }
                    });

                    const csv = csvData.map(row =>
                        row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(',')
                    ).join('\n');

                    const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
                    const link = document.createElement('a');
                    const url = URL.createObjectURL(blob);
                    link.setAttribute('href', url);
                    link.setAttribute('download', `historico_${entityType}_${entityId}_${new Date().toISOString().split('T')[0]}.csv`);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);

                    showToast('Histórico exportado com sucesso!', 'success');
                } catch (error) {
                    console.error('Erro ao exportar histórico:', error);
                    showToast('Erro ao exportar histórico', 'error');
                }
            }
        };

        // Função para filtrar por regime
        window.filterByRegime = (regime) => {
            selectedCompanyId = null; // Limpar filtro anterior
            const empresasFiltradas = allCompanies.filter(c => c.regime === regime);

            // Atualizar select de filtro
            const select = document.getElementById('company-filter-select');
            select.value = ''; // Limpar seleção

            // Mostrar na tela de empresas
            switchTab('companies');

            // Criar lista de empresas filtradas
            const list = document.getElementById('company-list');
            list.innerHTML = '';

            if (empresasFiltradas.length === 0) {
                list.innerHTML = `
                <div style="text-align: center; padding: 50px; border: 2px dashed var(--border); border-radius: 8px; color: var(--text-sec);">
                    <i data-lucide="building" width="48" style="margin-bottom: 10px; opacity: 0.5;"></i>
                    <p>Nenhuma empresa encontrada no regime ${regime}.</p>
                </div>
            `;
                return;
            }

            empresasFiltradas.forEach(comp => {
                const div = document.createElement('div');
                div.className = 'company-card';

                // Determinar badge pelo regime
                let badgeClass = '';
                if (comp.type === 'MEI') badgeClass = 'badge-mei';
                else if (comp.regime === 'SIMPLES') badgeClass = 'badge-simples';
                else if (comp.regime === 'PRESUMIDO') badgeClass = 'badge-presumido';
                else if (comp.regime === 'REAL') badgeClass = 'badge-real';
                else if (comp.type === 'LTDA') badgeClass = 'badge-ltda';

                div.innerHTML = `
                <h4>${escapeHtml(comp.name)} <span class="company-badge ${badgeClass}">${comp.regime || comp.type}</span></h4>
                <p><strong>Regime:</strong> ${comp.regime || 'Não informado'}</p>
                ${comp.cnpj ? `<p><i data-lucide="file-text" width="12"></i> ${escapeHtml(comp.cnpj)}</p>` : ''}
                ${comp.type ? `<p><i data-lucide="building" width="12"></i> ${comp.type}</p>` : ''}
                ${comp.cnae ? `<p><i data-lucide="hash" width="12"></i> CNAE: ${comp.cnae}</p>` : ''}
                <div class="company-actions">
                    <button class="icon-btn" onclick='openCompanyModal(${JSON.stringify(comp).replace(/'/g, "&#39;")})'>
                        <i data-lucide="pencil" width="16"></i>
                    </button>
                </div>
            `;
                list.appendChild(div);
            });

            showToast(`${empresasFiltradas.length} empresas no regime ${regime}`, 'success');
            lucide.createIcons();
        };

        // Função para filtrar por tipo
        window.filterByType = (type) => {
            selectedCompanyId = null; // Limpar filtro anterior
            const empresasFiltradas = allCompanies.filter(c => c.type === type);

            // Atualizar select de filtro
            const select = document.getElementById('company-filter-select');
            select.value = ''; // Limpar seleção

            // Mostrar na tela de empresas
            switchTab('companies');

            // Criar lista de empresas filtradas
            const list = document.getElementById('company-list');
            list.innerHTML = '';

            if (empresasFiltradas.length === 0) {
                list.innerHTML = `
                <div style="text-align: center; padding: 50px; border: 2px dashed var(--border); border-radius: 8px; color: var(--text-sec);">
                    <i data-lucide="building" width="48" style="margin-bottom: 10px; opacity: 0.5;"></i>
                    <p>Nenhuma empresa encontrada do tipo ${type}.</p>
                </div>
            `;
                return;
            }

            empresasFiltradas.forEach(comp => {
                const div = document.createElement('div');
                div.className = 'company-card';

                // Determinar badge pelo regime
                let badgeClass = '';
                if (comp.type === 'MEI') badgeClass = 'badge-mei';
                else if (comp.regime === 'SIMPLES') badgeClass = 'badge-simples';
                else if (comp.regime === 'PRESUMIDO') badgeClass = 'badge-presumido';
                else if (comp.regime === 'REAL') badgeClass = 'badge-real';
                else if (comp.type === 'LTDA') badgeClass = 'badge-ltda';

                div.innerHTML = `
                <h4>${escapeHtml(comp.name)} <span class="company-badge ${badgeClass}">${comp.type}</span></h4>
                <p><strong>Tipo:</strong> ${comp.type}</p>
                <p><strong>Regime:</strong> ${comp.regime || 'Não informado'}</p>
                ${comp.cnpj ? `<p><i data-lucide="file-text" width="12"></i> ${escapeHtml(comp.cnpj)}</p>` : ''}
                ${comp.cnae ? `<p><i data-lucide="hash" width="12"></i> CNAE: ${comp.cnae}</p>` : ''}
                <div class="company-actions">
                    <button class="icon-btn" onclick='openCompanyModal(${JSON.stringify(comp).replace(/'/g, "&#39;")})'>
                        <i data-lucide="pencil" width="16"></i>
                    </button>
                </div>
            `;
                list.appendChild(div);
            });

            showToast(`${empresasFiltradas.length} empresas do tipo ${type}`, 'success');
            lucide.createIcons();
        };

        // Atualizar o select de filtro de empresa
        function updateCompanyFilterSelect() {
            const select = document.getElementById('company-filter-select');
            const currentValue = select.value;

            select.innerHTML = '<option value="">Todas as empresas</option>';

            allCompanies.forEach(company => {
                const option = document.createElement('option');
                option.value = company.id;
                option.textContent = company.name;
                select.appendChild(option);
            });

            // Restaurar o valor selecionado
            if (currentValue && allCompanies.some(c => c.id === currentValue)) {
                select.value = currentValue;
            }

            lucide.createIcons();
        }

        // Função para filtrar tarefas por empresa
        window.filterCompanyTasks = () => {
            const select = document.getElementById('company-filter-select');
            selectedCompanyId = select.value;
            const clearBtn = document.getElementById('company-filter-clear');

            if (selectedCompanyId) {
                clearBtn.classList.remove('hidden');
                renderCompanyTasks();
            } else {
                clearBtn.classList.add('hidden');
                clearCompanyFilter();
            }
        };

        // Função para limpar filtro de empresa
        window.clearCompanyFilter = () => {
            const select = document.getElementById('company-filter-select');
            select.value = '';
            selectedCompanyId = null;
            document.getElementById('company-filter-clear').classList.add('hidden');

            // Esconder a seção de tarefas da empresa
            document.getElementById('company-tasks-section').classList.add('hidden');

            // Re-renderizar lista completa de empresas
            renderCompanies();
        };

        // Renderizar tarefas da empresa selecionada
        function renderCompanyTasks() {
            if (!selectedCompanyId) return;

            const company = allCompanies.find(c => c.id === selectedCompanyId);
            if (!company) return;

            const section = document.getElementById('company-tasks-section');
            const tasksList = document.getElementById('company-tasks-list');
            const title = document.getElementById('company-tasks-title');
            const count = document.getElementById('company-tasks-count');

            // Atualizar título
            title.textContent = `Tarefas - ${company.name}`;

            // Filtrar tarefas da empresa
            const companyTasks = allTasks.filter(task => task.companyId === selectedCompanyId);

            // Atualizar contador
            const pendingCount = companyTasks.filter(t => !t.completed).length;
            const completedCount = companyTasks.filter(t => t.completed).length;
            count.textContent = `${companyTasks.length} (${pendingCount} pendentes, ${completedCount} concluídas)`;

            // Renderizar lista de tarefas
            tasksList.innerHTML = '';

            if (companyTasks.length === 0) {
                tasksList.innerHTML = `
                <div style="text-align: center; padding: 30px; color: var(--text-sec);">
                    <i data-lucide="clipboard-list" width="32" style="opacity: 0.5; margin-bottom: 10px;"></i>
                    <p>Nenhuma tarefa encontrada para esta empresa.</p>
                </div>
            `;
            } else {
                companyTasks.forEach(task => {
                    const taskItem = document.createElement('div');
                    taskItem.className = `company-task-item ${task.completed ? 'completed' : ''}`;

                    let deadlineHtml = '';
                    if (task.deadline) {
                        const [y, m, d] = task.deadline.split('-').map(Number);
                        const deadlineDate = new Date(y, m - 1, d);
                        const formattedDate = deadlineDate.toLocaleDateString('pt-BR');
                        deadlineHtml = `
                        <div class="company-task-deadline">
                            <i data-lucide="calendar" width="12"></i>
                            <span>${formattedDate}</span>
                        </div>
                    `;
                    }

                    // Determinar cor da categoria
                    let categoryColor = '';
                    if (task.category === 'FISCAL') categoryColor = '#ef4444';
                    else if (task.category === 'TRABALHISTA') categoryColor = '#3b82f6';
                    else if (task.category === 'CONTABIL') categoryColor = '#10b981';
                    else if (task.category === 'MUNICIPAL') categoryColor = '#8b5cf6';
                    else categoryColor = '#6b7280';

                    taskItem.innerHTML = `
                    <div class="company-task-content">
                        <div class="company-task-title">${escapeHtml(task.title)}</div>
                        <div class="company-task-info">
                            <div class="company-task-status ${task.completed ? 'completed' : 'pending'}">
                                <i data-lucide="${task.completed ? 'check-circle' : 'clock'}" width="12"></i>
                                <span>${task.completed ? 'Concluída' : 'Pendente'}</span>
                            </div>
                            <div style="color: ${categoryColor}; font-weight: 500;">
                                <i data-lucide="tag" width="12"></i> ${task.category}
                            </div>
                            ${deadlineHtml}
                            ${task.description ? `<div><i data-lucide="file-text" width="12"></i> ${escapeHtml(task.description.substring(0, 30))}${task.description.length > 30 ? '...' : ''}</div>` : ''}
                        </div>
                    </div>
                    <div class="company-task-actions">
                        <button class="company-task-action-btn view" onclick="navigateToTask('${task.id}')">
                            <i data-lucide="eye" width="14"></i> Ver
                        </button>
                        <button class="company-task-action-btn" onclick="openTaskModal(${JSON.stringify(task).replace(/'/g, "&#39;")})">
                            <i data-lucide="pencil" width="14"></i> Editar
                        </button>
                    </div>
                `;

                    tasksList.appendChild(taskItem);
                });
            }

            // Mostrar a seção
            section.classList.remove('hidden');
            lucide.createIcons();
        }

        // Função para navegar para uma tarefa específica
        window.navigateToTask = (taskId) => {
            taskToHighlight = taskId;
            switchTab('tasks');
        };

        // Função para destacar uma tarefa na lista
        function highlightTask(taskId) {
            // Remover destaque de todas as tarefas
            document.querySelectorAll('.card').forEach(card => {
                card.classList.remove('highlighted');
            });

            // Encontrar e destacar a tarefa específica
            const taskElement = document.querySelector(`.card [onclick*="${taskId}"]`)?.closest('.card');
            if (taskElement) {
                taskElement.classList.add('highlighted');

                // Scroll para a tarefa
                taskElement.scrollIntoView({
                    behavior: 'smooth',
                    block: 'center'
                });
            }
        }

        // Função para definir o filtro de tarefas
        window.setTaskFilter = (filter) => {
            currentTaskFilter = filter;

            // Remover classe active de todos os filtros
            document.querySelectorAll('.metric-card').forEach(card => {
                card.classList.remove('active');
            });

            // Adicionar classe active ao filtro selecionado
            const filterMap = {
                'all': 'filter-all',
                'today': 'filter-today',
                'urgent': 'filter-urgent',
                'completed': 'filter-completed'
            };

            const selectedFilter = document.getElementById(filterMap[filter]);
            if (selectedFilter) selectedFilter.classList.add('active');

            // Atualizar título do filtro
            const filterTitles = {
                'all': 'Todas as tarefas',
                'today': 'Tarefas para hoje',
                'urgent': 'Tarefas urgentes',
                'completed': 'Tarefas concluídas hoje'
            };

            const filterTitle = document.getElementById('filter-title');
            const currentFilter = document.getElementById('current-filter');

            if (filterTitle) filterTitle.textContent = filter === 'all' ? 'Pendências' : filterTitles[filter];
            if (currentFilter) currentFilter.textContent = filterTitles[filter];

            // Renderizar tarefas com o filtro aplicado
            renderTasks();
        };

        // SEARCH HANDLERS
        window.searchTasks = (query) => {
            currentTaskSearch = query.toLowerCase();
            renderTasks();
        };

        window.searchCompanies = (query) => {
            currentCompanySearch = query.toLowerCase();
            renderCompanies();
        };

        // RENDER TASKS
        function renderTasks() {
            console.log('renderTasks() chamada - total tasks:', allTasks.length);

            const pendingList = document.getElementById('pending-list');
            const completedList = document.getElementById('completed-list');

            if (!pendingList || !completedList) {
                console.error('Elementos das listas não encontrados!');
                return;
            }

            pendingList.innerHTML = '';
            completedList.innerHTML = '';

            let pendingCount = 0;
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);

            // Define data limite para "Urgente" (hoje e amanhã)
            const urgentThreshold = new Date(today);
            urgentThreshold.setDate(urgentThreshold.getDate() + 1);

            // Se não houver tarefas
            if (allTasks.length === 0) {
                pendingList.innerHTML = `
            <div style="text-align: center; padding: 40px; color: var(--on-surface-variant);">
                <i data-lucide="clipboard-list" width="48" style="opacity: 0.5; margin-bottom: 10px;"></i>
                <p>Nenhuma tarefa encontrada.</p>
                <p style="font-size: 0.9rem; margin-top: 8px;">Clique no botão + para criar sua primeira tarefa.</p>
            </div>
        `;

                // Atualizar contadores
                updateMetrics();
                document.getElementById('pending-count').textContent = '0';

                lucide.createIcons();
                return;
            }

            allTasks.forEach(task => {
                const company = allCompanies.find(c => c.id === task.companyId);
                const companyName = company ? company.name : 'Empresa não encontrada';

                let deadlineHtml = '';
                let isUrgent = false;
                let isToday = false;
                let isCompletedToday = false;

                // Verificar se a tarefa deve ser mostrada com base no filtro atual e busca
                let showTask = true;

                // 1. Filtro de Busca Texto
                if (currentTaskSearch) {
                    const searchStr = `${task.title} ${task.description || ''} ${companyName} ${task.category || ''} ${task.obligation || ''}`.toLowerCase();
                    if (!searchStr.includes(currentTaskSearch)) {
                        showTask = false;
                    }
                }

                // 2. Filtros de Status
                if (showTask) {
                    if (currentTaskFilter === 'today') {
                        if (task.completed) {
                            showTask = false;
                        } else if (task.deadline) {
                            const [y, m, d] = task.deadline.split('-').map(Number);
                            const deadlineDate = new Date(y, m - 1, d);
                            isToday = deadlineDate.getTime() === today.getTime();
                            if (!isToday) showTask = false;
                        } else {
                            showTask = false;
                        }
                    }

                    if (currentTaskFilter === 'urgent') {
                        if (task.completed) {
                            showTask = false;
                        } else if (task.deadline) {
                            const [y, m, d] = task.deadline.split('-').map(Number);
                            const deadlineDate = new Date(y, m - 1, d);
                            isUrgent = deadlineDate <= tomorrow;
                            if (!isUrgent) showTask = false;
                        } else {
                            showTask = false;
                        }
                    }

                    if (currentTaskFilter === 'completed') {
                        if (!task.completed) {
                            showTask = false;
                        } else if (task.updatedAt) {
                            const updatedDate = new Date(task.updatedAt.seconds * 1000);
                            isCompletedToday = updatedDate.getDate() === today.getDate() &&
                                updatedDate.getMonth() === today.getMonth() &&
                                updatedDate.getFullYear() === today.getFullYear();
                            if (!isCompletedToday && currentTaskFilter === 'completed') showTask = false;
                        }
                    }

                    // Se filtro "all", mostrar apenas pendentes no pending list
                    if (currentTaskFilter === 'all' && task.completed) {
                        showTask = false; // As concluídas vão para completed-list
                    }
                }

                if (!showTask && !task.completed) {
                    return; // Não mostrar esta tarefa no pending list
                }

                // Criar HTML do deadline
                if (task.deadline) {
                    const [y, m, d] = task.deadline.split('-').map(Number);
                    const deadlineDate = new Date(y, m - 1, d);

                    // Verifica urgência: Se data prazo <= amanhã E não concluída
                    if (!task.completed && deadlineDate <= urgentThreshold) {
                        isUrgent = true;
                    }

                    const dateFormatted = deadlineDate.toLocaleDateString('pt-BR');
                    const badgeClass = isUrgent ? 'urgent' : 'normal';
                    const icon = isUrgent ? 'alert-circle' : 'calendar';
                    deadlineHtml = `<span class="deadline-badge ${badgeClass}"><i data-lucide="${icon}" width="10"></i> ${dateFormatted}</span>`;
                }

                const div = document.createElement('div');
                // Aplica classes
                div.className = `card ${task.completed ? 'completed-card' : ''} ${isUrgent ? 'urgent' : ''} ${taskToHighlight === task.id ? 'highlighted' : ''}`;

                if (task.id) {
                    div.setAttribute('data-task-id', task.id);
                }

                div.onclick = (e) => {
                    if (!e.target.closest('.check-btn') && !e.target.closest('.delete-btn')) {
                        openTaskModal(task);
                    }
                };

                // Determinar cor da categoria
                let categoryColor = '';
                let categoryIcon = 'file-text';
                if (task.category === 'FISCAL') {
                    categoryColor = '#ef4444';
                    categoryIcon = 'receipt';
                } else if (task.category === 'TRABALHISTA') {
                    categoryColor = '#3b82f6';
                    categoryIcon = 'users';
                } else if (task.category === 'CONTABIL') {
                    categoryColor = '#10b981';
                    categoryIcon = 'calculator';
                } else if (task.category === 'MUNICIPAL') {
                    categoryColor = '#8b5cf6';
                    categoryIcon = 'building';
                } else {
                    categoryColor = '#6b7280';
                    categoryIcon = 'file-text';
                }

                // Valor formatado
                let valueHtml = '';
                if (task.value) {
                    const value = parseFloat(task.value);
                    if (!isNaN(value)) {
                        valueHtml = `• R$ ${value.toFixed(2)}`;
                    }
                }

                div.innerHTML = `
            <div class="card-content">
                <div class="card-header-row">
                    <div class="card-company">
                        <i data-lucide="building-2" width="12"></i> ${escapeHtml(companyName)}
                    </div>
                    ${deadlineHtml}
                </div>
                <div class="card-title">${escapeHtml(task.title)}</div>
                <div class="card-desc">
                    <span style="color: ${categoryColor}; display: flex; align-items: center; gap: 5px;">
                        <i data-lucide="${categoryIcon}" width="12"></i>
                        ${task.category || 'Sem categoria'} • ${task.obligation || 'Sem obrigação'}
                        ${valueHtml}
                    </span>
                </div>
                ${task.description ? `<div class="card-desc" style="margin-top: 8px;">${escapeHtml(task.description)}</div>` : ''}
            </div>
            <div class="card-actions">
                <button class="delete-btn" onclick="event.stopPropagation(); confirmDeleteTask('${task.id}', '${escapeHtml(task.title).replace(/'/g, "\\'")}')">
                    <i data-lucide="trash-2" width="18"></i>
                </button>
                <button class="check-btn" onclick="event.stopPropagation(); toggleTask('${task.id}', ${!task.completed})">
                    <i data-lucide="${task.completed ? 'rotate-ccw' : 'check'}" width="18"></i>
                </button>
            </div>
        `;

                if (task.completed) {
                    // Para tarefas concluídas, só mostrar se for filtro "completed" ou "all"
                    if (currentTaskFilter === 'completed' || currentTaskFilter === 'all') {
                        completedList.appendChild(div);
                    }
                } else {
                    pendingList.appendChild(div);
                    pendingCount++;
                }
            });

            // Atualizar contador baseado no filtro atual
            let filteredCount = pendingCount;

            if (currentTaskFilter === 'today') {
                filteredCount = allTasks.filter(task => {
                    if (task.completed) return false;
                    if (!task.deadline) return false;
                    const [y, m, d] = task.deadline.split('-').map(Number);
                    const deadlineDate = new Date(y, m - 1, d);
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    return deadlineDate.getTime() === today.getTime();
                }).length;
            } else if (currentTaskFilter === 'urgent') {
                filteredCount = allTasks.filter(task => {
                    if (task.completed) return false;
                    if (!task.deadline) return false;
                    const [y, m, d] = task.deadline.split('-').map(Number);
                    const deadlineDate = new Date(y, m - 1, d);
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    const tomorrow = new Date(today);
                    tomorrow.setDate(tomorrow.getDate() + 1);
                    return deadlineDate <= tomorrow;
                }).length;
            } else if (currentTaskFilter === 'completed') {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                filteredCount = allTasks.filter(task => {
                    if (!task.completed || !task.updatedAt) return false;
                    const updatedDate = new Date(task.updatedAt.seconds * 1000);
                    return updatedDate.getDate() === today.getDate() &&
                        updatedDate.getMonth() === today.getMonth() &&
                        updatedDate.getFullYear() === today.getFullYear();
                }).length;
            }

            const pendingCountElement = document.getElementById('pending-count');
            if (pendingCountElement) {
                pendingCountElement.textContent = filteredCount;
            }

            // Atualizar métricas
            updateMetrics();

            // Se não há tarefas para mostrar na lista pendente
            if (pendingList.children.length === 0 && currentTaskFilter !== 'completed') {
                pendingList.innerHTML = `
            <div style="text-align: center; padding: 40px; color: var(--on-surface-variant);">
                <i data-lucide="check-circle" width="48" style="opacity: 0.5; margin-bottom: 10px;"></i>
                <p>Nenhuma tarefa ${currentTaskFilter === 'today' ? 'para hoje' : currentTaskFilter === 'urgent' ? 'urgente' : 'pendente'}.</p>
            </div>
        `;
            }

            // Se não há tarefas concluídas para mostrar
            if (completedList.children.length === 0 && (currentTaskFilter === 'completed' || currentTaskFilter === 'all')) {
                completedList.innerHTML = `
            <div style="text-align: center; padding: 40px; color: var(--on-surface-variant);">
                <i data-lucide="archive" width="48" style="opacity: 0.5; margin-bottom: 10px;"></i>
                <p>Nenhuma tarefa concluída.</p>
            </div>
        `;
            }

            // Atualizar pins nos cards após renderizar
            setTimeout(() => {
                updateAllPins();
            }, 100);

            lucide.createIcons();
        }

        // RENDER COMPANIES
        function renderCompanies() {
            const list = document.getElementById('company-list');
            const empty = document.getElementById('empty-companies');
            list.innerHTML = '';

            let companiesToShow = allCompanies;

            // Filtro de Busca
            if (currentCompanySearch) {
                companiesToShow = allCompanies.filter(comp =>
                    comp.name.toLowerCase().includes(currentCompanySearch) ||
                    (comp.cnpj && comp.cnpj.includes(currentCompanySearch)) ||
                    (comp.type && comp.type.toLowerCase().includes(currentCompanySearch))
                );
            }

            document.getElementById('company-count').textContent = companiesToShow.length;

            if (companiesToShow.length === 0) {
                empty.classList.remove('hidden');
                // Se for busca, mostrar mensagem específica? Para manter simples, usa o empty padrão ou limpa
                if (currentCompanySearch) {
                    list.innerHTML = `
                        <div style="text-align: center; padding: 50px; color: var(--text-sec); width: 100%;">
                            <p>Nenhuma empresa encontrada para "${currentCompanySearch}"</p>
                        </div>
                     `;
                    empty.classList.add('hidden'); // Esconder o empty genérico "Cadastre sua primeira empresa"
                }
                return;
            }
            empty.classList.add('hidden');

            companiesToShow.forEach(comp => {
                const div = document.createElement('div');
                div.className = 'company-card';

                div.setAttribute('data-company-id', comp.id);

                // Determinar badge pelo regime/tipo
                let badgeClass = '';
                let badgeText = comp.regime || comp.type || '';
                if (comp.type === 'MEI') {
                    badgeClass = 'badge-mei';
                    badgeText = 'MEI';
                } else if (comp.regime === 'SIMPLES') {
                    badgeClass = 'badge-simples';
                    badgeText = 'Simples';
                } else if (comp.regime === 'PRESUMIDO') {
                    badgeClass = 'badge-presumido';
                    badgeText = 'Presumido';
                } else if (comp.regime === 'REAL') {
                    badgeClass = 'badge-real';
                    badgeText = 'Real';
                } else if (comp.type === 'LTDA') {
                    badgeClass = 'badge-ltda';
                    badgeText = 'LTDA';
                }

                div.innerHTML = `
                <h4>${escapeHtml(comp.name)} ${badgeText ? `<span class="company-badge ${badgeClass}">${badgeText}</span>` : ''}</h4>
                ${comp.cnpj ? `<p><i data-lucide="file-text" width="12"></i> ${escapeHtml(comp.cnpj)}</p>` : ''}
                ${comp.phone ? `<p><i data-lucide="phone" width="12"></i> ${escapeHtml(comp.phone)}</p>` : ''}
                ${comp.type ? `<p><i data-lucide="building" width="12"></i> ${comp.type}</p>` : ''}
                ${comp.regime ? `<p><i data-lucide="trending-up" width="12"></i> ${comp.regime}</p>` : ''}
                ${comp.cnae ? `<p><i data-lucide="hash" width="12"></i> CNAE: ${comp.cnae}</p>` : ''}
                <div class="company-actions">
                    <button class="icon-btn" title="Gerar tarefas automáticas" onclick="generateAllCompanyTasks('${comp.id}')">
                        <i data-lucide="refresh-cw" width="16"></i>
                    </button>
                    <button class="icon-btn" onclick='openCompanyModal(${JSON.stringify(comp).replace(/'/g, "&#39;")})'>
                        <i data-lucide="pencil" width="16"></i>
                    </button>
                </div>
            `;
                list.appendChild(div);
            });

            // Atualizar pins nos cards após renderizar
            setTimeout(() => {
                updateCardsPins();
            }, 100);

            lucide.createIcons();
        }

        // TASK ACTIONS
        window.openTaskModal = (task = null) => {
            const modal = document.getElementById('modal-task');
            const select = document.getElementById('task-company');

            select.innerHTML = '<option value="">Selecione a Empresa...</option>';
            allCompanies.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c.id;
                opt.textContent = c.name;
                select.appendChild(opt);
            });

            if (allCompanies.length === 0) {
                showToast('Cadastre uma empresa primeiro!', 'error');
                switchTab('companies');
                return;
            }

            if (task) {
                document.getElementById('modal-task-title').textContent = 'Editar Tarefa';
                document.getElementById('task-id').value = task.id;
                document.getElementById('task-title').value = task.title;
                document.getElementById('task-desc').value = task.description || '';
                document.getElementById('task-deadline').value = task.deadline || '';
                document.getElementById('task-category').value = task.category || '';
                document.getElementById('task-obligation').value = task.obligation || '';
                document.getElementById('task-periodicity').value = task.periodicity || 'UNICA';
                document.getElementById('task-reference').value = task.reference || '';
                document.getElementById('task-value').value = task.value || '';
                document.getElementById('task-payment-status').value = task.paymentStatus || 'PENDENTE';
                document.getElementById('task-file-link').value = task.fileLink || '';
                document.getElementById('task-internal-notes').value = task.internalNotes || '';
                select.value = task.companyId || '';
                document.getElementById('btn-delete-task').classList.remove('hidden');
            } else {
                document.getElementById('modal-task-title').textContent = 'Nova Tarefa';
                document.getElementById('task-id').value = '';
                document.getElementById('task-title').value = '';
                document.getElementById('task-desc').value = '';
                document.getElementById('task-deadline').value = '';
                document.getElementById('task-category').value = '';
                document.getElementById('task-obligation').value = '';
                document.getElementById('task-periodicity').value = 'UNICA';
                document.getElementById('task-reference').value = '';
                document.getElementById('task-value').value = '';
                document.getElementById('task-payment-status').value = 'PENDENTE';
                document.getElementById('task-file-link').value = '';
                document.getElementById('task-internal-notes').value = '';
                select.value = '';
                document.getElementById('btn-delete-task').classList.add('hidden');
            }

            modal.classList.remove('hidden');
            lucide.createIcons();
        };

        // Função para sugerir prazos baseados na obrigação
        window.saveTask = async () => {
            const id = document.getElementById('task-id').value;
            const isUpdate = !!id;

            // Capturar dados antigos se for update
            let oldData = null;
            if (isUpdate) {
                oldData = allTasks.find(t => t.id === id);
            }

            // Coletar dados do formulário (seu código atual)
            const companyId = document.getElementById('task-company').value;
            const title = document.getElementById('task-title').value;
            const description = document.getElementById('task-desc').value;
            const deadline = document.getElementById('task-deadline').value;
            const category = document.getElementById('task-category').value;
            const obligation = document.getElementById('task-obligation').value;
            const periodicity = document.getElementById('task-periodicity').value;
            const reference = document.getElementById('task-reference').value;
            const value = document.getElementById('task-value').value;
            const paymentStatus = document.getElementById('task-payment-status').value;
            const fileLink = document.getElementById('task-file-link').value;
            const internalNotes = document.getElementById('task-internal-notes').value;

            if (!companyId || !title || !category) {
                showToast('Campos obrigatórios faltando', 'error');
                return;
            }

            const data = {
                companyId,
                title,
                description,
                deadline,
                category,
                obligation,
                periodicity,
                reference,
                value: value ? parseFloat(value) : null,
                paymentStatus,
                fileLink,
                internalNotes,
                updatedAt: serverTimestamp(),
                lastUpdatedBy: currentUser.email,
                lastUpdatedAt: serverTimestamp(),
                updatedByUserId: currentUser.uid
            };

            // Adquirir lock de edição
            if (isUpdate) {
                await RealTimeCollaboration.acquireLock('task', id);
            }

            try {
                if (id) {
                    // LOG ANTES DE ATUALIZAR
                    await AuditLogger.autoLogUpdate('task', id, oldData, data);

                    // Atualizar no Firestore
                    await updateDoc(doc(db, 'artifacts', appId, 'users', window.currentWorkspaceOwnerId, 'tasks', id), data);

                    // Notificar colaboradores se houver mudanças importantes
                    if (oldData?.completed !== data.completed) {
                        await AuditLogger.logAction('status_change', 'task', id, {
                            completed: { old: oldData?.completed, new: data.completed }
                        }, oldData, { priority: 'high' });
                    }

                    showToast('Tarefa atualizada', 'success');
                } else {
                    // LOG DE CRIAÇÃO
                    data.createdAt = serverTimestamp();
                    data.createdBy = currentUser.email;
                    data.createdByUserId = currentUser.uid;

                    const newDoc = await addDoc(collection(db, 'artifacts', appId, 'users', window.currentWorkspaceOwnerId, 'tasks'), data);

                    await AuditLogger.logAction('create', 'task', newDoc.id, {
                        created: { old: null, new: data }
                    });

                    showToast('Tarefa criada', 'success');
                }

                closeModals();
            } catch (e) {
                console.error(e);
                showToast('Erro ao salvar', 'error');
            } finally {
                // Liberar lock
                if (isUpdate) {
                    await RealTimeCollaboration.releaseLock('task', id);
                }
            }
        };

        // FUNÇÃO NOVA: Gerar tarefas recorrentes automaticamente
        async function generateRecurringTasks(baseTask, periodicity, reference) {
            if (!periodicity || periodicity === 'UNICA') return 0;

            const [refAno, refMes] = reference.split('-').map(Number);
            let createdCount = 0;

            // Quantas tarefas futuras criar
            let futureCount = 0;
            if (periodicity === 'MENSAL') futureCount = 11; // Próximos 11 meses (total 12)
            if (periodicity === 'TRIMESTRAL') futureCount = 3; // Próximos 3 trimestres (total 4)
            if (periodicity === 'ANUAL') futureCount = 1; // Próximo ano (total 2)

            for (let i = 1; i <= futureCount; i++) {
                try {
                    // Clonar a tarefa base
                    const newTask = { ...baseTask };

                    // Calcular nova referência
                    let newRefAno = refAno;
                    let newRefMes = refMes;

                    if (periodicity === 'MENSAL') {
                        newRefMes += i;
                        if (newRefMes > 12) {
                            newRefMes -= 12;
                            newRefAno += 1;
                        }
                    } else if (periodicity === 'TRIMESTRAL') {
                        newRefMes += (i * 3);
                        while (newRefMes > 12) {
                            newRefMes -= 12;
                            newRefAno += 1;
                        }
                    } else if (periodicity === 'ANUAL') {
                        newRefAno += i;
                    }

                    const newReference = `${newRefAno}-${newRefMes.toString().padStart(2, '0')}`;

                    // Calcular novo prazo baseado na obrigação
                    const novoPrazo = calculateNextDeadline(baseTask.obligation, newReference);

                    // Atualizar dados da nova tarefa
                    newTask.reference = newReference;
                    newTask.deadline = novoPrazo;
                    newTask.title = `${baseTask.obligation || 'Tarefa'} - ${newReference}`;
                    newTask.createdAt = serverTimestamp();
                    newTask.updatedAt = serverTimestamp();
                    newTask.completed = false;

                    // Salvar no banco
                    await addDoc(collection(db, 'artifacts', appId, 'users', window.currentWorkspaceOwnerId, 'tasks'), newTask);
                    createdCount++;

                } catch (error) {
                    console.error(`Erro ao criar tarefa recorrente ${i}:`, error);
                }
            }

            return createdCount;
        }

        // FUNÇÃO: Gerar todas as obrigações recorrentes para uma empresa
        window.generateAllCompanyTasks = async (companyId) => {
            const company = allCompanies.find(c => c.id === companyId);
            if (!company) {
                showToast('Empresa não encontrada', 'error');
                return;
            }

            // Criar modal de seleção de templates
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
        <div class="modal" style="max-width: 700px;">
            <div class="modal-header">
                <h3><i data-lucide="sparkles"></i> Gerar Tarefas para ${company.name}</h3>
                <button onclick="this.closest('.modal-overlay').remove()"><i data-lucide="x"></i></button>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 20px; color: var(--text-sec);">
                    <p>Selecione as categorias de tarefas para gerar automaticamente:</p>
                </div>
                
                <div class="template-categories" style="display: flex; flex-direction: column; gap: 15px;">
                    <!-- Categorias serão preenchidas via JavaScript -->
                </div>
                
                <div style="margin-top: 25px; padding-top: 20px; border-top: 1px solid var(--outline-variant);">
                    <div class="input-group">
                        <label>Período de Geração</label>
                        <select id="template-period" class="std-input">
                            <option value="3">Próximos 3 meses</option>
                            <option value="6" selected>Próximos 6 meses</option>
                            <option value="12">Próximo ano (12 meses)</option>
                        </select>
                    </div>
                    
                    <div class="input-group">
                        <label>
                            <input type="checkbox" id="include-recurring" checked>
                            Incluir tarefas recorrentes automaticamente
                        </label>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button onclick="this.closest('.modal-overlay').remove()" 
                        style="color: var(--text-sec); font-weight: 600; padding: 0 15px;">
                    Cancelar
                </button>
                <button onclick="executeTemplateGeneration('${companyId}')" class="btn-main">
                    <i data-lucide="zap"></i> Gerar Tarefas Selecionadas
                </button>
            </div>
        </div>
    `;

            document.body.appendChild(modal);

            // Preencher categorias após o modal ser adicionado ao DOM
            setTimeout(() => {
                const categoriesContainer = modal.querySelector('.template-categories');

                // 1. Categoria Fiscal (baseada no regime)
                if (company.regime && TASK_TEMPLATES.FISCAL[company.regime]) {
                    const fiscalDiv = createCategoryCheckbox('fiscal', '📊 Fiscal',
                        `Regime ${company.regime} - Obrigações principais`,
                        TASK_TEMPLATES.FISCAL[company.regime]);
                    categoriesContainer.appendChild(fiscalDiv);
                }

                // 2. Categoria Trabalhista (se tiver funcionários)
                if (company.hasEmployees === 'true' && TASK_TEMPLATES.TRABALHISTA.default) {
                    const trabalhistaDiv = createCategoryCheckbox('trabalhista', '👥 Trabalhista',
                        'Folha de pagamento e encargos',
                        TASK_TEMPLATES.TRABALHISTA.default);
                    categoriesContainer.appendChild(trabalhistaDiv);
                }

                // 3. Categoria Contábil
                if (TASK_TEMPLATES.CONTABIL.default) {
                    const contabilDiv = createCategoryCheckbox('contabil', '🧾 Contábil',
                        'Balanço, DRE e demonstrações',
                        TASK_TEMPLATES.CONTABIL.default);
                    categoriesContainer.appendChild(contabilDiv);
                }

                // 4. Categoria Municipal
                if (TASK_TEMPLATES.MUNICIPAL.default) {
                    const municipalDiv = createCategoryCheckbox('municipal', '🏛️ Municipal',
                        'ISS e obrigações municipais',
                        TASK_TEMPLATES.MUNICIPAL.default);
                    categoriesContainer.appendChild(municipalDiv);
                }

                lucide.createIcons();
            }, 100);
        };

        // FUNÇÃO AUXILIAR para criar checkbox de categoria
        function createCategoryCheckbox(id, title, description, templates) {
            const div = document.createElement('div');
            div.className = 'template-category';
            div.style.background = 'var(--surface-variant)';
            div.style.padding = '15px';
            div.style.borderRadius = '12px';
            div.style.border = '1px solid var(--outline-variant)';

            const templateCount = templates.length;
            const estimatedTime = templates.reduce((sum, t) => sum + (t.estimatedTime || 0), 0);

            div.innerHTML = `
        <div style="display: flex; align-items: flex-start; gap: 12px;">
            <input type="checkbox" id="category-${id}" checked 
                   style="margin-top: 4px;">
            <div style="flex: 1;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <strong style="font-size: 16px;">${title}</strong>
                        <span style="font-size: 12px; color: var(--text-sec); margin-left: 8px;">
                            ${templateCount} template${templateCount > 1 ? 's' : ''}
                        </span>
                    </div>
                    <span style="font-size: 12px; color: var(--text-sec);">
                        ~${Math.ceil(estimatedTime / 60)}h estimadas
                    </span>
                </div>
                <p style="margin: 8px 0 12px 0; color: var(--text-sec); font-size: 14px;">
                    ${description}
                </p>
                <div class="template-list" style="font-size: 13px; color: var(--text-sec);">
                    ${templates.map(t => `
                        <div style="display: flex; align-items: center; gap: 8px; padding: 4px 0;">
                            <i data-lucide="check-circle" width="12" style="color: var(--success);"></i>
                            <span>${t.title} (${t.periodicity.toLowerCase()})</span>
                        </div>
                    `).join('')}
                </div>
            </div>
        </div>
    `;

            return div;
        }

        // FUNÇÃO para executar a geração de templates
        async function executeTemplateGeneration(companyId) {
            // 1. Encontrar a empresa
            const company = allCompanies.find(c => c.id === companyId);
            if (!company) {
                showToast('Empresa não encontrada', 'error');
                return;
            }

            // 2. Pegar valores do modal
            const periodElement = document.getElementById('template-period');
            const recurringElement = document.getElementById('include-recurring');

            // Validação básica caso os elementos não existam
            if (!periodElement || !recurringElement) {
                console.error('Elementos do modal não encontrados');
                return;
            }

            const period = parseInt(periodElement.value);
            const includeRecurring = recurringElement.checked;

            // 3. Coletar categorias selecionadas
            const selectedCategories = [];
            document.querySelectorAll('.template-category input[type="checkbox"]:checked').forEach(cb => {
                const categoryId = cb.id.replace('category-', '');
                selectedCategories.push(categoryId);
            });

            // 4. Validação se nenhuma categoria foi marcada
            if (selectedCategories.length === 0) {
                showToast('Selecione pelo menos uma categoria', 'warning');
                return;
            }

            // 5. Fechar modal (remove o overlay do DOM)
            const overlay = document.querySelector('.modal-overlay');
            if (overlay) overlay.remove();

            let totalCreated = 0;

            // 6. Loop de geração
            // Para cada categoria selecionada...
            for (const categoryId of selectedCategories) {
                // Pega os templates daquela categoria (Fiscal, Trabalhista, etc)
                const templates = getTemplatesForCategory(categoryId, company);

                // Para cada template dentro da categoria...
                for (const template of templates) {
                    try {
                        // Verificar condições (ex: se o template exige funcionários e a empresa não tem)
                        if (template.conditions) {
                            if (template.conditions.includes('hasEmployees') && company.hasEmployees !== 'true') {
                                continue;
                            }
                        }

                        // Gerar tarefas para o período selecionado
                        // (Chama a função auxiliar generateTasksFromTemplate)
                        const created = await generateTasksFromTemplate(template, company, period, includeRecurring);
                        totalCreated += created;

                    } catch (error) {
                        console.error(`Erro ao gerar template "${template.title}":`, error);
                    }
                }
            }

            // 7. Feedback e Redirecionamento
            if (totalCreated > 0) {
                showToast(`✅ ${totalCreated} tarefas geradas para ${company.name}!`, 'success');

                // Navegar para a view de tarefas para ver o resultado
                setTimeout(() => {
                    if (typeof switchTab === 'function') {
                        switchTab('tasks');
                    }
                }, 1000);
            } else {
                showToast('Nenhuma tarefa foi gerada (verifique as condições).', 'warning');
            }
        }

        // *** ESSENCIAL: Torna a função global para que o botão HTML consiga chamá-la ***
        window.executeTemplateGeneration = executeTemplateGeneration;


        // *** ESSENCIAL: Torna a função global para que o botão HTML consiga chamá-la ***
        window.executeTemplateGeneration = executeTemplateGeneration;


        // FUNÇÃO AUXILIAR para obter templates de uma categoria
        function getTemplatesForCategory(categoryId, company) {
            switch (categoryId) {
                case 'fiscal':
                    return company.regime ? (TASK_TEMPLATES.FISCAL[company.regime] || []) : [];
                case 'trabalhista':
                    return TASK_TEMPLATES.TRABALHISTA.default || [];
                case 'contabil':
                    return TASK_TEMPLATES.CONTABIL.default || [];
                case 'municipal':
                    return TASK_TEMPLATES.MUNICIPAL.default || [];
                default:
                    return [];
            }
        }

        // FUNÇÃO para gerar tarefas a partir de um template
        async function generateTasksFromTemplate(template, company, monthsCount, includeRecurring = true) {
            let createdCount = 0;
            const hoje = new Date();

            // Determinar quantas ocorrências gerar
            let occurrences = 1;
            if (includeRecurring && template.autoGenerate) {
                if (template.periodicity === 'MENSAL') occurrences = monthsCount;
                else if (template.periodicity === 'TRIMESTRAL') occurrences = Math.ceil(monthsCount / 3);
                else if (template.periodicity === 'ANUAL') occurrences = Math.min(monthsCount / 12, 1);
            }

            for (let i = 0; i < occurrences; i++) {
                try {
                    // Calcular data de referência
                    let refMonth = hoje.getMonth() + 1 + i;
                    let refYear = hoje.getFullYear();

                    if (template.periodicity === 'TRIMESTRAL') {
                        refMonth = hoje.getMonth() + 1 + (i * 3);
                    } else if (template.periodicity === 'ANUAL') {
                        refMonth = template.month || 1;
                        refYear = hoje.getFullYear() + i;
                    }

                    // Ajustar se passar de dezembro
                    while (refMonth > 12) {
                        refMonth -= 12;
                        refYear += 1;
                    }

                    const reference = `${refYear}-${refMonth.toString().padStart(2, '0')}`;

                    // Calcular deadline
                    const deadline = calculateTemplateDeadline(template, refYear, refMonth);

                    // Criar tarefa
                    const taskData = {
                        companyId: company.id,
                        title: `${template.title} - ${reference}`,
                        description: template.description,
                        deadline: deadline,
                        category: template.category,
                        obligation: template.obligation,
                        periodicity: template.periodicity,
                        reference: reference,
                        value: template.value,
                        paymentStatus: 'PENDENTE',
                        fileLink: '',
                        internalNotes: `Gerada automaticamente do template ${template.id} para ${company.name}`,
                        completed: false,
                        templateId: template.id,
                        estimatedTime: template.estimatedTime,
                        tags: template.tags || [],
                        createdAt: serverTimestamp(),
                        updatedAt: serverTimestamp()
                    };

                    await addDoc(collection(db, 'artifacts', appId, 'users', window.currentWorkspaceOwnerId, 'tasks'), taskData);
                    createdCount++;

                } catch (error) {
                    console.error(`Erro ao criar ocorrência ${i} de ${template.title}:`, error);
                }
            }

            return createdCount;
        }

        // FUNÇÃO para calcular deadline do template
        function calculateTemplateDeadline(template, year, month) {
            let day = template.deadlineDay || 20;

            // Ajustar para o último dia do mês se necessário
            const lastDay = new Date(year, month, 0).getDate();
            if (day > lastDay) day = lastDay;

            // Se for anual e tem mês específico
            if (template.periodicity === 'ANUAL' && template.month) {
                month = template.month;
            }

            return `${year}-${month.toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
        }

        // FUNÇÃO AUXILIAR: Calcular próximo prazo
        function calculateNextDeadline(obligation, reference) {
            const [ano, mes] = reference.split('-').map(Number);

            // Datas de vencimento padrão
            const vencimentosPadrao = {
                'DAS': 20,
                'GPS': 20,
                'IRPJ': 30,
                'CSLL': 30,
                'PIS_COFINS': 20,
                'EFD': 15,
                'DIRF': 30,
                'DCTF': 30,
                'RAIS': 30,
                'CAGED': 20,
                'SEFIP': 20,
                'DARF': 30
            };

            const dia = vencimentosPadrao[obligation] || 20;
            return `${ano}-${mes.toString().padStart(2, '0')}-${dia.toString().padStart(2, '0')}`;
        }

        window.toggleTask = async (id, status) => {
            try {
                const task = allTasks.find(t => t.id === id);
                if (!task) return;

                // LOG ANTES DE ALTERAR
                await AuditLogger.logAction('status_change', 'task', id, {
                    completed: { old: task.completed, new: status }
                }, task, {
                    priority: 'medium',
                    action: status ? 'completed' : 'reopened'
                });

                await updateDoc(doc(db, 'artifacts', appId, 'users', window.currentWorkspaceOwnerId, 'tasks', id), {
                    completed: status,
                    updatedAt: serverTimestamp(),
                    lastUpdatedBy: currentUser.email,
                    lastUpdatedAt: serverTimestamp(),
                    updatedByUserId: currentUser.uid
                });

                showToast(status ? '✅ Tarefa concluída!' : '↩️ Tarefa reaberta', 'success');
            } catch (e) {
                console.error(e);
                showToast('Erro ao atualizar', 'error');
            }
        };

        window.addNewCollaborator = async () => {
            const email = document.getElementById('collaborator-email').value;
            const permission = document.getElementById('collaborator-permission').value;

            if (!email || !email.includes('@')) {
                showToast('Digite um e-mail válido', 'error');
                return;
            }

            const success = await CollaboratorManager.addCollaborator(email, permission);
            if (success) {
                document.getElementById('collaborator-email').value = '';
                refreshCollaboratorsList();
            }
        };

        // Função para atualizar lista de colaboradores
        window.refreshCollaboratorsList = async () => {
            const container = document.getElementById('collaborators-list');
            if (!container) return;

            container.innerHTML = `
    <div style="text-align: center; padding: 20px;">
      <i data-lucide="loader" width="20" class="loading-spinner"></i>
      <p style="margin-top: 8px; color: var(--on-surface-variant);">Carregando colaboradores...</p>
    </div>
  `;
            lucide.createIcons();

            const collaborators = await CollaboratorManager.listCollaborators();
            const countElement = document.getElementById('collaborator-count');
            if (countElement) {
                countElement.textContent = collaborators.length;
            }

            if (collaborators.length === 0) {
                container.innerHTML = `
      <div style="text-align: center; padding: 40px; color: var(--on-surface-variant);">
        <i data-lucide="users" width="48" style="opacity: 0.5; margin-bottom: 12px;"></i>
        <p>Nenhum colaborador convidado ainda.</p>
        <p style="font-size: 0.9rem; margin-top: 8px;">Convide alguém para começar a colaborar!</p>
      </div>
    `;
                return;
            }

            container.innerHTML = collaborators.map(collab => {
                const statusColors = {
                    'pending': '#f59e0b',
                    'active': '#10b981',
                    'rejected': '#ef4444',
                    'revoked': '#6b7280'
                };

                const permissionIcons = {
                    'viewer': 'eye',
                    'editor': 'edit',
                    'admin': 'crown'
                };

                const statusTexts = {
                    'pending': 'Convite pendente',
                    'active': 'Ativo',
                    'rejected': 'Recusado',
                    'revoked': 'Revogado'
                };

                return `
      <div style="background: var(--surface); border: 1px solid var(--outline-variant); 
                  border-radius: var(--radius-lg); padding: 16px; margin-bottom: 12px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
          <div style="display: flex; align-items: center; gap: 12px;">
            <div style="width: 40px; height: 40px; border-radius: 50%; 
                        background: linear-gradient(135deg, #8b5cf6, #ec4899);
                        color: white; display: flex; align-items: center; 
                        justify-content: center; font-weight: bold; font-size: 16px;">
              ${collab.email.charAt(0).toUpperCase()}
            </div>
            <div>
              <div style="font-weight: 600;">${collab.email}</div>
              <div style="font-size: 13px; color: var(--on-surface-variant);">
                Convidado em ${collab.invitedAtFormatted}
              </div>
            </div>
          </div>
          
          <div style="display: flex; align-items: center; gap: 8px;">
            <span style="padding: 4px 10px; border-radius: 12px; font-size: 12px; 
                         background: ${statusColors[collab.status] || '#6b7280'}20; 
                         color: ${statusColors[collab.status] || '#6b7280'};">
              ${statusTexts[collab.status] || collab.status}
            </span>
            
            <div style="display: flex; gap: 4px;">
              <button onclick="updateCollaboratorPermission('${collab.id}', 'viewer')" 
                      class="icon-btn ${collab.permissionLevel === 'viewer' ? 'active' : ''}"
                      title="Somente leitura">
                <i data-lucide="eye" width="14"></i>
              </button>
              <button onclick="updateCollaboratorPermission('${collab.id}', 'editor')" 
                      class="icon-btn ${collab.permissionLevel === 'editor' ? 'active' : ''}"
                      title="Editor">
                <i data-lucide="edit" width="14"></i>
              </button>
              <button onclick="updateCollaboratorPermission('${collab.id}', 'admin')" 
                      class="icon-btn ${collab.permissionLevel === 'admin' ? 'active' : ''}"
                      title="Administrador">
                <i data-lucide="crown" width="14"></i>
              </button>
            </div>
          </div>
        </div>
        
        <div style="display: flex; justify-content: space-between; align-items: center; 
                    padding-top: 12px; border-top: 1px solid var(--surface-variant);">
          <div style="display: flex; gap: 12px; font-size: 13px;">
            <div style="display: flex; align-items: center; gap: 4px; color: var(--on-surface-variant);">
              <i data-lucide="${permissionIcons[collab.permissionLevel] || 'user'}" width="12"></i>
              ${collab.permissionLevel === 'viewer' ? 'Somente leitura' :
                        collab.permissionLevel === 'editor' ? 'Pode editar' :
                            'Administrador completo'}
            </div>
            <div style="display: flex; align-items: center; gap: 4px; color: var(--on-surface-variant);">
              <i data-lucide="mail" width="12"></i>
              ${collab.invitedBy}
            </div>
          </div>
          
          <button onclick="removeCollaborator('${collab.id}', '${collab.email}')" 
                  class="icon-btn" style="color: var(--error);">
            <i data-lucide="user-minus" width="16"></i>
          </button>
        </div>
      </div>
    `;
            }).join('');

            lucide.createIcons();

            // Carregar histórico de auditoria
            loadAuditHistory();
        };

        // Função para atualizar permissão do colaborador
        window.updateCollaboratorPermission = async (collaboratorId, permissionLevel) => {
            const success = await CollaboratorManager.updateCollaborator(collaboratorId, {
                permissionLevel: permissionLevel
            });

            if (success) {
                refreshCollaboratorsList();
            }
        };

        // Função para remover colaborador
        window.removeCollaborator = async (collaboratorId, email) => {
            if (!confirm(`Tem certeza que deseja remover ${email} como colaborador?`)) {
                return;
            }

            const success = await CollaboratorManager.removeCollaborator(collaboratorId);
            if (success) {
                refreshCollaboratorsList();
            }
        };

        // Função para carregar histórico de auditoria
        async function loadAuditHistory() {
            const container = document.getElementById('audit-history');
            if (!container) return;

            try {
                const historyRef = collection(db, 'artifacts', appId, 'audit_logs');
                const q = query(
                    historyRef,
                    orderBy('timestamp', 'desc'),
                    limit(15)
                );

                const snapshot = await getDocs(q);

                if (snapshot.empty) {
                    container.innerHTML = `
        <div style="text-align: center; padding: 20px; color: var(--on-surface-variant);">
          <i data-lucide="history" width="32" style="opacity: 0.5; margin-bottom: 8px;"></i>
          <p>Nenhuma atividade registrada ainda.</p>
        </div>
      `;
                    return;
                }

                container.innerHTML = snapshot.docs.map(doc => {
                    const data = doc.data();
                    const time = data.timestamp?.toDate();
                    const timeStr = time ? time.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }) : 'Agora';
                    const dateStr = time ? time.toLocaleDateString('pt-BR') : 'Hoje';

                    const actionColors = {
                        'create': '#10b981',
                        'update': '#3b82f6',
                        'delete': '#ef4444',
                        'view': '#6b7280',
                        'status_change': '#8b5cf6'
                    };

                    const actionIcons = {
                        'create': 'plus-circle',
                        'update': 'edit-2',
                        'delete': 'trash-2',
                        'view': 'eye',
                        'status_change': 'refresh-cw'
                    };

                    const actionTexts = {
                        'create': 'criou',
                        'update': 'atualizou',
                        'delete': 'excluiu',
                        'view': 'visualizou',
                        'status_change': 'alterou status de'
                    };

                    const entityTexts = {
                        'task': 'tarefa',
                        'company': 'empresa',
                        'note': 'nota',
                        'pin': 'etiqueta',
                        'collaborator': 'colaborador'
                    };

                    return `
        <div style="display: flex; align-items: flex-start; gap: 12px; padding: 12px; 
                    border-bottom: 1px solid var(--surface-variant);">
          <div style="width: 32px; height: 32px; border-radius: 50%; 
                      background: ${actionColors[data.action] || '#6b7280'}20;
                      display: flex; align-items: center; justify-content: center;">
            <i data-lucide="${actionIcons[data.action] || 'activity'}" width="14" 
               style="color: ${actionColors[data.action] || '#6b7280'};"></i>
          </div>
          
          <div style="flex: 1;">
            <div style="font-size: 13px; line-height: 1.4;">
              <strong>${data.userEmail?.split('@')[0] || 'Usuário'}</strong> 
              ${actionTexts[data.action] || 'realizou ação em'} 
              <strong>${entityTexts[data.entityType] || data.entityType}</strong>
              ${data.entityId ? `<code style="font-size: 11px; background: var(--surface-variant); padding: 1px 4px; border-radius: 3px;">${data.entityId.substring(0, 8)}...</code>` : ''}
            </div>
            
            ${data.changes ? `
              <div style="margin-top: 4px; font-size: 12px; color: var(--on-surface-variant);">
                ${Object.keys(data.changes).slice(0, 2).map(field => `
                  <span style="display: inline-block; margin-right: 6px;">
                    ${field}: <strong>${JSON.stringify(data.changes[field]?.new)}</strong>
                  </span>
                `).join('')}
                ${Object.keys(data.changes).length > 2 ? `+${Object.keys(data.changes).length - 2} campos` : ''}
              </div>
            ` : ''}
            
            <div style="margin-top: 4px; font-size: 11px; color: var(--outline);">
              ${dateStr} às ${timeStr}
            </div>
          </div>
        </div>
      `;
                }).join('');

                lucide.createIcons();
            } catch (error) {
                console.error('Erro ao carregar histórico:', error);
                container.innerHTML = `
      <div style="text-align: center; padding: 20px; color: var(--error);">
        <i data-lucide="alert-circle" width="20"></i>
        <p style="margin-top: 8px;">Erro ao carregar histórico</p>
      </div>
    `;
                lucide.createIcons();
            }
        }

        // Função para exportar logs de auditoria
        window.exportAuditLogs = async () => {
            try {
                showToast('Gerando relatório de auditoria...', 'info');

                const historyRef = collection(db, 'artifacts', appId, 'audit_logs');
                const q = query(
                    historyRef,
                    orderBy('timestamp', 'desc'),
                    limit(100)
                );

                const snapshot = await getDocs(q);
                const logs = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data(),
                    timestamp: doc.data().timestamp?.toDate().toISOString()
                }));

                // Criar CSV
                const headers = ['Data/Hora', 'Usuário', 'Ação', 'Entidade', 'ID', 'Alterações', 'IP'];
                const csvRows = logs.map(log => [
                    new Date(log.timestamp).toLocaleString('pt-BR'),
                    log.userEmail,
                    log.action,
                    log.entityType,
                    log.entityId,
                    JSON.stringify(log.changes || {}),
                    log.ipAddress || 'N/A'
                ]);

                const csv = [headers, ...csvRows]
                    .map(row => row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(','))
                    .join('\n');

                // Criar e baixar arquivo
                const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `auditoria_${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                showToast('Relatório de auditoria exportado!', 'success');
            } catch (error) {
                console.error('Erro ao exportar logs:', error);
                showToast('Erro ao exportar logs', 'error');
            }
        };

        // Função para confirmar exclusão de tarefa
        window.confirmDeleteTask = (taskId = null, taskTitle = null) => {
            if (taskId) {
                // Exclusão direta da lista
                deletePending = { type: 'task', id: taskId };
                document.getElementById('delete-confirm-title').textContent = 'Excluir Tarefa';
                document.getElementById('delete-confirm-message').textContent = `Tem certeza que deseja excluir a tarefa "${taskTitle || 'esta tarefa'}"? Esta ação não pode ser desfeita.`;
            } else {
                // Exclusão do modal de edição
                const taskIdFromModal = document.getElementById('task-id').value;
                const taskTitleFromModal = document.getElementById('task-title').value;
                deletePending = { type: 'task', id: taskIdFromModal };
                document.getElementById('delete-confirm-title').textContent = 'Excluir Tarefa';
                document.getElementById('delete-confirm-message').textContent = `Tem certeza que deseja excluir a tarefa "${taskTitleFromModal || 'esta tarefa'}"? Esta ação não pode ser desfeita.`;
            }

            document.getElementById('modal-delete-confirm').classList.remove('hidden');
        };

        // Função para excluir tarefas de uma empresa antes de excluir a empresa
        async function deleteCompanyTasks(companyId) {
            try {
                const tasksRef = collection(db, 'artifacts', appId, 'users', window.currentWorkspaceOwnerId, 'tasks');
                const q = query(tasksRef, where('companyId', '==', companyId));
                const querySnapshot = await getDocs(q);

                const deletePromises = [];
                querySnapshot.forEach((docSnapshot) => {
                    deletePromises.push(deleteDoc(docSnapshot.ref));
                });

                await Promise.all(deletePromises);
                return querySnapshot.size; // Retorna quantas tarefas foram excluídas
            } catch (error) {
                console.error('Erro ao excluir tarefas da empresa:', error);
                throw error;
            }
        }

        // Função para confirmar exclusão de empresa
        window.confirmDeleteCompany = () => {
            const companyId = document.getElementById('company-id').value;
            const companyName = document.getElementById('company-name').value;

            deletePending = { type: 'company', id: companyId };
            document.getElementById('delete-confirm-title').textContent = 'Excluir Empresa';
            document.getElementById('delete-confirm-message').textContent = `Tem certeza que deseja excluir a empresa "${companyName}"? Todas as tarefas vinculadas a esta empresa também serão excluídas. Esta ação não pode ser desfeita.`;

            document.getElementById('modal-delete-confirm').classList.remove('hidden');
        };

        // Função para executar a exclusão confirmada
        window.confirmDelete = async () => {
            if (!deletePending.type || !deletePending.id) {
                showToast('Erro ao excluir: item não identificado', 'error');
                closeModals();
                return;
            }

            try {
                // LOG ANTES DE EXCLUIR
                let entityData = null;
                let entityType = deletePending.type;

                switch (deletePending.type) {
                    case 'task':
                        entityData = allTasks.find(t => t.id === deletePending.id);
                        break;
                    case 'company':
                        entityData = allCompanies.find(c => c.id === deletePending.id);
                        break;
                    case 'note':
                        entityData = allNotes.find(n => n.id === deletePending.id);
                        break;
                    case 'pin':
                        entityData = allPins.find(p => p.id === deletePending.id);
                        break;
                    default:
                        entityData = null;
                }

                await AuditLogger.logAction('delete', entityType, deletePending.id, {
                    deleted: { old: entityData, new: null }
                }, entityData, {
                    deletedBy: currentUser.email,
                    deletedAt: new Date().toISOString()
                });

                // Executar exclusão específica
                if (deletePending.type === 'task') {
                    await deleteDoc(doc(db, 'artifacts', appId, 'users', window.currentWorkspaceOwnerId, 'tasks', deletePending.id));
                } else if (deletePending.type === 'company') {
                    // Excluir tarefas da empresa primeiro
                    const tasksDeleted = await deleteCompanyTasks(deletePending.id);
                    await deleteDoc(doc(db, 'artifacts', appId, 'users', window.currentWorkspaceOwnerId, 'companies', deletePending.id));
                    showToast(`Empresa excluída (${tasksDeleted} tarefas removidas)`, 'success');
                } else if (deletePending.type === 'pin') {
                    await deleteDoc(doc(db, 'artifacts', appId, 'users', window.currentWorkspaceOwnerId, 'pins', deletePending.id));
                    showToast('Etiqueta excluída', 'success');
                } else if (deletePending.type === 'note') {
                    await deleteDoc(doc(db, 'artifacts', appId, 'users', window.currentWorkspaceOwnerId, 'notes', deletePending.id));
                    showToast('Nota excluída', 'success');
                }

                closeModals();
                deletePending = { type: null, id: null };
            } catch (e) {
                console.error(e);
                showToast('Erro ao excluir', 'error');
                deletePending = { type: null, id: null };
            }
        };

        window.openCompanyModal = (comp = null) => {
            if (comp) {
                document.getElementById('modal-company-title').textContent = 'Editar Empresa';
                document.getElementById('company-id').value = comp.id;
                document.getElementById('company-name').value = comp.name;
                document.getElementById('company-cnpj').value = comp.cnpj || '';
                document.getElementById('company-phone').value = comp.phone || '';
                document.getElementById('company-type').value = comp.type || '';
                document.getElementById('company-regime').value = comp.regime || '';
                document.getElementById('company-percentual').value = comp.percentual || '8';
                document.getElementById('company-cnae').value = comp.cnae || '';
                document.getElementById('company-open-date').value = comp.openDate || '';
                document.getElementById('company-address').value = comp.address || '';
                document.getElementById('company-email').value = comp.email || '';
                document.getElementById('company-responsible').value = comp.responsible || '';
                document.getElementById('company-has-employees').value = comp.hasEmployees || '';
                document.getElementById('company-status').value = comp.status || 'ATIVA';
                document.getElementById('btn-delete-company').classList.remove('hidden');

                // Atualizar campos do regime
                updateRegimeFields();
            } else {
                document.getElementById('modal-company-title').textContent = 'Cadastrar Empresa';
                document.getElementById('company-id').value = '';
                document.getElementById('company-name').value = '';
                document.getElementById('company-cnpj').value = '';
                document.getElementById('company-phone').value = '';
                document.getElementById('company-type').value = '';
                document.getElementById('company-regime').value = '';
                document.getElementById('company-percentual').value = '8';
                document.getElementById('company-cnae').value = '';
                document.getElementById('company-open-date').value = '';
                document.getElementById('company-address').value = '';
                document.getElementById('company-email').value = '';
                document.getElementById('company-responsible').value = '';
                document.getElementById('company-has-employees').value = '';
                document.getElementById('company-status').value = 'ATIVA';
                document.getElementById('btn-delete-company').classList.add('hidden');

                // Esconder campos do regime presumido
                document.getElementById('presumido-fields').style.display = 'none';
            }
            document.getElementById('modal-company').classList.remove('hidden');
            lucide.createIcons();

            // ADICIONE ESTA PARTE - CONFIGURAÇÃO DO CNPJ-SERVICE
            setTimeout(() => {
                // Configurar formatação automática do CNPJ
                const cnpjInput = document.getElementById('company-cnpj');
                if (cnpjInput) {
                    // Limpar eventos anteriores
                    const newInput = cnpjInput.cloneNode(true);
                    cnpjInput.parentNode.replaceChild(newInput, cnpjInput);

                    // Formatar enquanto digita
                    newInput.addEventListener('input', (e) => {
                        if (window.cnpjService) {
                            window.cnpjService.formatarEnquantoDigita(e);
                        }
                    });

                    // Consultar automaticamente ao perder foco
                    newInput.addEventListener('blur', async (e) => {
                        if (!window.cnpjService) return;

                        const cleaned = e.target.value.replace(/\D/g, '');
                        if (cleaned.length === 14 && window.cnpjService.isValidCNPJ(cleaned)) {
                            try {
                                // Mostrar loading
                                const loadingEl = document.getElementById('cnpj-loading');
                                if (loadingEl) loadingEl.classList.remove('hidden');

                                // Consultar CNPJ
                                const dados = await window.cnpjService.consultarCNPJ(cleaned);

                                // Preencher campos automaticamente
                                preencherCamposEmpresa(dados);

                                showToast('Dados da empresa carregados automaticamente!', 'success');
                            } catch (error) {
                                console.warn('Consulta automática falhou:', error.message);
                                // Não mostrar erro para não incomodar o usuário
                            } finally {
                                const loadingEl = document.getElementById('cnpj-loading');
                                if (loadingEl) loadingEl.classList.add('hidden');
                            }
                        }
                    });
                }

                // Configurar botão de consulta manual (se existir)
                const cnpjBtn = document.querySelector('#modal-company .btn-cnpj-search');
                if (cnpjBtn && window.cnpjService) {
                    // Clonar para remover eventos antigos
                    const newBtn = cnpjBtn.cloneNode(true);
                    cnpjBtn.parentNode.replaceChild(newBtn, cnpjBtn);

                    // Adicionar evento de clique
                    newBtn.addEventListener('click', async () => {
                        const cnpjInput = document.getElementById('company-cnpj');
                        if (!cnpjInput) return;

                        const cnpj = cnpjInput.value;
                        if (!cnpj || cnpj.replace(/\D/g, '').length < 14) {
                            showToast('Digite um CNPJ válido (14 dígitos)', 'error');
                            return;
                        }

                        try {
                            // Mostrar loading
                            const loadingEl = document.getElementById('cnpj-loading');
                            if (loadingEl) loadingEl.classList.remove('hidden');

                            // Consultar CNPJ
                            const dados = await window.cnpjService.consultarCNPJ(cnpj);

                            // Preencher campos automaticamente
                            preencherCamposEmpresa(dados);

                            showToast('Dados da empresa carregados com sucesso!', 'success');
                        } catch (error) {
                            showToast(error.message || 'Erro ao consultar CNPJ', 'error');
                        } finally {
                            const loadingEl = document.getElementById('cnpj-loading');
                            if (loadingEl) loadingEl.classList.add('hidden');
                        }
                    });

                    lucide.createIcons();
                }
            }, 100);
        };

        // FUNÇÃO PARA PREENCHER CAMPOS DA EMPRESA (ADICIONE ESTA FUNÇÃO NO SEU CÓDIGO)
        function preencherCamposEmpresa(dados) {
            console.log('Dados recebidos da API:', dados);

            // Função auxiliar PARA FORMATAR ENDEREÇO (definida localmente)
            function formatarEnderecoCompleto(dados) {
                const partes = [];

                if (dados.logradouro) partes.push(dados.logradouro);
                if (dados.numero && dados.numero !== 'S/N') partes.push(dados.numero);
                if (dados.complemento) partes.push(dados.complemento);
                if (dados.bairro) partes.push(dados.bairro);
                if (dados.municipio) partes.push(dados.municipio);
                if (dados.uf) partes.push(dados.uf);
                if (dados.cep) partes.push(`CEP: ${dados.cep}`);

                return partes.join(', ');
            }

            // 1. PREENCHER TODOS OS CAMPOS VISÍVEIS
            const camposParaPreencher = {
                // Campos principais
                'company-name': dados.nome || dados.fantasia || '',
                'company-cnpj': dados.cnpj ? dados.cnpj.replace(/^(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})/, '$1.$2.$3/$4-$5') : '',
                'company-nome': dados.nome || dados.fantasia || '',
                'company-fantasia': dados.fantasia || dados.nome || '',
                'company-city-state': `${dados.municipio || ''}${dados.uf ? '/' + dados.uf : ''}`.trim(),
                'company-situation': dados.situacao || 'ATIVA',
                'company-cnae': dados.cnae || '',
                'company-phone': dados.telefone || '',
                'company-open-date': dados.abertura ?
                    dados.abertura.split('/').reverse().join('-') :
                    (dados.data_inicio_atividade ? dados.data_inicio_atividade.split('/').reverse().join('-') : ''),
                'company-address': formatarEnderecoCompleto(dados),
                'company-email': dados.email || '',
                'company-responsible': dados.socios && dados.socios.length > 0 ?
                    dados.socios[0].nome_socio || dados.socios[0].nome || '' : ''
            };

            // Preencher cada campo
            Object.entries(camposParaPreencher).forEach(([id, value]) => {
                const element = document.getElementById(id);
                if (element && value && value !== 'undefined') {
                    element.value = value;
                }
            });

            // 2. SUGERIR VALORES PARA OS SELECTS
            if (window.cnpjService && window.cnpjService.sugerirTipoEmpresa) {
                // Tipo da empresa
                const tipoSugerido = window.cnpjService.sugerirTipoEmpresa(dados);
                const tipoSelect = document.getElementById('company-type');
                if (tipoSelect) {
                    tipoSelect.value = tipoSugerido;
                }

                // Regime tributário
                const regimeSugerido = window.cnpjService.sugerirRegimeTributario(dados);
                const regimeSelect = document.getElementById('company-regime');
                if (regimeSelect) {
                    regimeSelect.value = regimeSugerido;
                    // Atualizar campos dinâmicos do regime
                    if (window.updateRegimeFields) {
                        window.updateRegimeFields();
                    }
                }

                // Tem funcionários?
                const temFuncSugerido = window.cnpjService.sugerirTemFuncionarios(dados);
                const funcSelect = document.getElementById('company-has-employees');
                if (funcSelect) {
                    funcSelect.value = temFuncSugerido;
                }

                // Status da empresa
                const statusSelect = document.getElementById('company-status');
                if (statusSelect) {
                    const situacao = (dados.situacao || '').toLowerCase();
                    if (situacao.includes('ativa') || situacao.includes('regular')) {
                        statusSelect.value = 'ATIVA';
                    } else if (situacao.includes('suspensa') || situacao.includes('baixada')) {
                        statusSelect.value = 'SUSPENSA';
                    } else {
                        statusSelect.value = 'ATIVA';
                    }
                }
            } else {
                // Fallback básico se o serviço não estiver disponível
                const tipoSelect = document.getElementById('company-type');
                if (tipoSelect && !tipoSelect.value) {
                    tipoSelect.value = 'LTDA'; // Padrão
                }

                const regimeSelect = document.getElementById('company-regime');
                if (regimeSelect && !regimeSelect.value) {
                    regimeSelect.value = 'SIMPLES'; // Padrão
                }
            }

            // 3. ADICIONAR INFORMAÇÕES ADICIONAIS
            const infoAdicionais = [];

            if (dados.capital_social && dados.capital_social !== 'R$ 0,00') {
                infoAdicionais.push(`Capital Social: ${dados.capital_social}`);
            }

            if (dados.natureza_juridica_descricao || dados.natureza_juridica) {
                infoAdicionais.push(`Natureza Jurídica: ${dados.natureza_juridica_descricao || dados.natureza_juridica}`);
            }

            if (dados.porte) {
                infoAdicionais.push(`Porte: ${dados.porte}`);
            }

            if (dados.cnae_descricao) {
                infoAdicionais.push(`Atividade: ${dados.cnae_descricao}`);
            }

            // Adicionar informações adicionais no campo de endereço
            if (infoAdicionais.length > 0) {
                const addressField = document.getElementById('company-address');
                if (addressField) {
                    const enderecoAtual = addressField.value;
                    const infoTexto = '\n\n--- INFORMAÇÕES ADICIONAIS ---\n' + infoAdicionais.join('\n');
                    addressField.value = enderecoAtual + infoTexto;

                    // Ajustar altura do textarea se necessário
                    if (addressField.scrollHeight > addressField.clientHeight) {
                        addressField.style.height = addressField.scrollHeight + 'px';
                    }
                }
            }

            // 4. MOSTRAR FEEDBACK VISUAL
            showToast('Dados da empresa carregados com sucesso!', 'success');

            // Destacar campos preenchidos automaticamente
            setTimeout(() => {
                Object.keys(camposParaPreencher).forEach(fieldId => {
                    const element = document.getElementById(fieldId);
                    if (element && element.value) {
                        element.classList.add('auto-filled');
                        setTimeout(() => {
                            element.classList.remove('auto-filled');
                        }, 2000);
                    }
                });
            }, 500);

            return dados;
        }

        function formatarEnderecoCompleto(dados) {
            const partes = [];

            if (dados.logradouro) partes.push(dados.logradouro);
            if (dados.numero && dados.numero !== 'S/N') partes.push(dados.numero);
            if (dados.complemento) partes.push(dados.complemento);
            if (dados.bairro) partes.push(dados.bairro);
            if (dados.municipio) partes.push(dados.municipio);
            if (dados.uf) partes.push(dados.uf);
            if (dados.cep) partes.push(`CEP: ${dados.cep}`);

            return partes.join(', ');
        }

        window.saveCompany = async () => {
            const id = document.getElementById('company-id').value;
            const isUpdate = !!id;

            // Capturar dados antigos se for update
            let oldData = null;
            if (isUpdate) {
                oldData = allCompanies.find(c => c.id === id);
            }

            // Coletar dados (seu código atual)
            const name = document.getElementById('company-name').value;
            const cnpj = document.getElementById('company-cnpj').value;
            const phone = document.getElementById('company-phone').value;
            const type = document.getElementById('company-type').value;
            const regime = document.getElementById('company-regime').value;
            const percentual = document.getElementById('company-percentual')?.value || null;
            const cnae = document.getElementById('company-cnae').value;
            const openDate = document.getElementById('company-open-date').value;
            const address = document.getElementById('company-address').value;
            const email = document.getElementById('company-email').value;
            const responsible = document.getElementById('company-responsible').value;
            const hasEmployees = document.getElementById('company-has-employees').value;
            const status = document.getElementById('company-status').value;

            if (!name || !type || !regime) {
                showToast('Campos obrigatórios faltando', 'error');
                return;
            }

            const data = {
                name, cnpj, phone,
                type, regime, percentual, cnae, openDate,
                address, email, responsible, hasEmployees, status,
                updatedAt: serverTimestamp(),
                lastUpdatedBy: currentUser.email,
                lastUpdatedAt: serverTimestamp(),
                updatedByUserId: currentUser.uid
            };

            // Adquirir lock de edição
            if (isUpdate) {
                await RealTimeCollaboration.acquireLock('company', id);
            }

            try {
                if (id) {
                    // LOG ANTES DE ATUALIZAR
                    await AuditLogger.autoLogUpdate('company', id, oldData, data);

                    await updateDoc(doc(db, 'artifacts', appId, 'users', window.currentWorkspaceOwnerId, 'companies', id), data);
                    showToast('Empresa atualizada', 'success');
                } else {
                    data.createdAt = serverTimestamp();
                    data.createdBy = currentUser.email;
                    data.createdByUserId = currentUser.uid;

                    await addDoc(collection(db, 'artifacts', appId, 'users', window.currentWorkspaceOwnerId, 'companies'), data);

                    await AuditLogger.logAction('create', 'company', id, {
                        created: { old: null, new: data }
                    });

                    showToast('Empresa cadastrada', 'success');
                }

                closeModals();
            } catch (e) {
                console.error(e);
                showToast('Erro ao salvar', 'error');
            } finally {
                // Liberar lock
                if (isUpdate) {
                    await RealTimeCollaboration.releaseLock('company', id);
                }
            }
        };

        // UI HELPERS
        window.closeModals = () => {
            document.querySelectorAll('.modal-overlay').forEach(el => el.classList.add('hidden'));
            deletePending = { type: null, id: null }; // Resetar ao fechar modais
        };

        function showToast(msg, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = type === 'success' ? `<i data-lucide="check"></i> ${msg}` :
                type === 'warning' ? `<i data-lucide="alert-triangle"></i> ${msg}` :
                    `<i data-lucide="alert-circle"></i> ${msg}`;
            document.getElementById('toast-container').appendChild(toast);
            lucide.createIcons();
            setTimeout(() => toast.remove(), 3000);
        }

        function escapeHtml(text) {
            if (!text) return "";
            return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
        }

        // Inicializar ícones e definir filtro inicial
        lucide.createIcons();
        setTimeout(() => {
            if (document.getElementById('filter-all')) {
                setTaskFilter('all');
            }
        }, 100);

        // ============================================
        // NOVO GERENCIADOR DE DASHBOARD (DashboardManager)
        // Cole isso dentro do seu <script type="module">
        // ============================================

        const DashboardManager = {
            charts: {}, // Armazena instâncias dos gráficos para destruir antes de recriar

            // Chamado quando clica na aba Dashboard ou quando os dados mudam
            init: function () {
                if (currentTab !== 'dashboard') return;

                console.log("Inicializando Dashboard...");
                this.updateDate();
                this.calculateKPIs();
                this.renderCharts();
                this.renderLists();
                lucide.createIcons();
            },

            refresh: function () {
                this.init();
                showToast("Dashboard atualizada", "success");
            },

            updateDate: function () {
                const dateEl = document.getElementById('dashboard-date');
                if (dateEl) {
                    const now = new Date();
                    const options = { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' };
                    dateEl.textContent = now.toLocaleDateString('pt-BR', options).replace(/^\w/, c => c.toUpperCase());
                }
            },

            calculateKPIs: function () {
                // 1. Total Empresas
                const activeCompanies = allCompanies.filter(c => c.status !== 'BAIXADA').length;
                document.getElementById('kpi-companies').textContent = activeCompanies;

                // 2. Pendências
                const pending = allTasks.filter(t => !t.completed).length;
                document.getElementById('kpi-pending').textContent = pending;

                // 3. Eficiência (Tarefas concluídas / Total tarefas)
                const total = allTasks.length;
                const completed = allTasks.filter(t => t.completed).length;
                const efficiency = total > 0 ? Math.round((completed / total) * 100) : 0;
                document.getElementById('kpi-efficiency').textContent = `${efficiency}%`;

                // 4. Receita Estimada (Cálculo Fictício ou baseado em campo 'value')
                // Soma valores de tarefas ou estima R$ 200 por empresa
                let revenue = allTasks.reduce((acc, t) => acc + (parseFloat(t.value) || 0), 0);
                if (revenue === 0) revenue = activeCompanies * 200; // Fallback: estimativa base
                document.getElementById('kpi-revenue').textContent = revenue.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            },

            renderCharts: function () {
                // Destruir gráficos antigos se existirem para evitar sobreposição/erro
                if (this.charts.regimes) this.charts.regimes.destroy();
                if (this.charts.tasks) this.charts.tasks.destroy();

                // --- Gráfico 1: Regimes Tributários (Doughnut) ---
                const regimesCount = { 'SIMPLES': 0, 'PRESUMIDO': 0, 'REAL': 0, 'MEI': 0, 'OUTROS': 0 };
                allCompanies.forEach(c => {
                    if (c.type === 'MEI') regimesCount['MEI']++;
                    else if (c.regime && regimesCount[c.regime] !== undefined) regimesCount[c.regime]++;
                    else regimesCount['OUTROS']++;
                });

                const ctxRegime = document.getElementById('chart-regimes').getContext('2d');
                this.charts.regimes = new Chart(ctxRegime, {
                    type: 'doughnut',
                    data: {
                        labels: ['Simples', 'Presumido', 'Real', 'MEI', 'Outros'],
                        datasets: [{
                            data: Object.values(regimesCount),
                            backgroundColor: ['#10b981', '#3b82f6', '#8b5cf6', '#f59e0b', '#94a3b8'],
                            borderWidth: 2,
                            borderColor: '#ffffff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'right', labels: { usePointStyle: true, font: { family: "'Outfit', sans-serif" } } }
                        },
                        cutout: '70%'
                    }
                });

                // --- Gráfico 2: Status das Obrigações (Bar) ---
                const pending = allTasks.filter(t => !t.completed).length;
                const completed = allTasks.filter(t => t.completed).length;
                // Atrasadas: não completas e prazo menor que hoje
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const overdue = allTasks.filter(t => !t.completed && t.deadline && new Date(t.deadline + 'T00:00:00') < today).length;

                const ctxTasks = document.getElementById('chart-tasks').getContext('2d');
                this.charts.tasks = new Chart(ctxTasks, {
                    type: 'bar',
                    data: {
                        labels: ['Concluídas', 'Pendentes', 'Atrasadas'],
                        datasets: [{
                            label: 'Tarefas',
                            data: [completed, pending, overdue],
                            backgroundColor: ['#10b981', '#f59e0b', '#ef4444'],
                            borderRadius: 6,
                            barPercentage: 0.6
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            y: { beginAtZero: true, grid: { borderDash: [2, 4] } },
                            x: { grid: { display: false } }
                        }
                    }
                });
            },

            renderLists: function () {
                const upcomingList = document.getElementById('dashboard-upcoming-list');
                const alertsList = document.getElementById('dashboard-alerts-list');

                upcomingList.innerHTML = '';
                alertsList.innerHTML = '';

                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const nextWeek = new Date(today);
                nextWeek.setDate(today.getDate() + 7);

                let upcomingCount = 0;
                let alertsCount = 0;

                // Ordenar tarefas por prazo
                const sortedTasks = [...allTasks].sort((a, b) => {
                    if (!a.deadline) return 1;
                    if (!b.deadline) return -1;
                    return new Date(a.deadline) - new Date(b.deadline);
                });

                sortedTasks.forEach(task => {
                    if (task.completed) return; // Ignora concluídas

                    const company = allCompanies.find(c => c.id === task.companyId) || { name: 'Desconhecida' };

                    // Lógica de Datas
                    let deadlineDate = null;
                    if (task.deadline) {
                        const parts = task.deadline.split('-');
                        deadlineDate = new Date(parts[0], parts[1] - 1, parts[2]);
                    }

                    // --- Renderizar Alertas (Atrasados ou sem empresa válida) ---
                    if (deadlineDate && deadlineDate < today) {
                        alertsCount++;
                        const div = document.createElement('div');
                        div.className = 'card urgent';
                        div.style.padding = '12px';
                        div.style.marginBottom = '8px';
                        div.onclick = () => openTaskModal(task);
                        div.innerHTML = `
                    <div style="display:flex; justify-content:space-between; width:100%;">
                        <div style="font-weight:600; font-size:0.9rem;">${escapeHtml(task.title)}</div>
                        <span style="font-size:0.75rem; color:var(--error); font-weight:bold;">Atrasada</span>
                    </div>
                    <div style="font-size:0.8rem; color:var(--text-sec); margin-top:4px;">
                        ${escapeHtml(company.name)} • ${new Date(task.deadline).toLocaleDateString('pt-BR')}
                    </div>
                `;
                        alertsList.appendChild(div);
                    }

                    // --- Renderizar Próximos Vencimentos (Hoje até 7 dias) ---
                    if (deadlineDate && deadlineDate >= today && deadlineDate <= nextWeek) {
                        upcomingCount++;
                        const isToday = deadlineDate.getTime() === today.getTime();
                        const div = document.createElement('div');
                        div.className = 'card';
                        div.style.padding = '12px';
                        div.style.marginBottom = '8px';
                        div.style.borderLeft = isToday ? '4px solid var(--primary)' : '1px solid var(--outline-variant)';
                        div.onclick = () => openTaskModal(task);

                        div.innerHTML = `
                    <div style="display:flex; justify-content:space-between; width:100%;">
                        <div style="font-weight:600; font-size:0.9rem;">${escapeHtml(task.title)}</div>
                        <span style="font-size:0.75rem; background:${isToday ? 'var(--primary)' : 'var(--surface-variant)'}; color:${isToday ? 'white' : 'var(--on-surface-variant)'}; padding:2px 6px; border-radius:4px;">
                            ${isToday ? 'HOJE' : new Date(task.deadline).toLocaleDateString('pt-BR').slice(0, 5)}
                        </span>
                    </div>
                    <div style="font-size:0.8rem; color:var(--text-sec); margin-top:4px;">
                        ${escapeHtml(company.name)} • ${task.category || 'Geral'}
                    </div>
                `;
                        upcomingList.appendChild(div);
                    }
                });

                // Atualizar badges
                document.getElementById('count-upcoming').textContent = upcomingCount;
                document.getElementById('count-alerts').textContent = alertsCount;

                // Mensagens vazias
                if (upcomingCount === 0) upcomingList.innerHTML = '<div style="text-align:center; padding:20px; color:var(--text-sec); font-size:0.9rem;">Sem vencimentos para os próximos 7 dias.</div>';
                if (alertsCount === 0) alertsList.innerHTML = '<div style="text-align:center; padding:20px; color:var(--success); font-size:0.9rem;"><i data-lucide="check-circle" style="margin-bottom:5px;"></i><br>Nenhuma pendência crítica!</div>';
            }
        };

    </script>
    <script>
        const SettingsManager = {
            // Configurações Padrão
            config: {
                theme: 'light', // light, dark
                contrast: 'normal', // normal, high
                fontSize: 100, // porcentagem
                lineHeight: 'normal', // normal, relaxed
                wordSpacing: 'normal' // normal, wide
            },

            // Inicialização
            init: function () {
                this.loadSettings();
                this.injectStyles();
                this.injectModal();
                this.applySettings();
                this.setupEventListeners();

                // Intercepta o botão de configurações existente
                setTimeout(() => {
                    this.hijackSettingsButton();
                }, 1000);

                console.log('SettingsManager inicializado');
            },

            // Carregar do LocalStorage
            loadSettings: function () {
                const saved = localStorage.getItem('app_settings');
                if (saved) {
                    this.config = { ...this.config, ...JSON.parse(saved) };
                }
            },

            // Salvar no LocalStorage
            saveSettings: function () {
                localStorage.setItem('app_settings', JSON.stringify(this.config));
                this.applySettings();
            },

            // Injetar CSS necessário para temas e acessibilidade
            injectStyles: function () {
                const style = document.createElement('style');
                style.textContent = `
            /* --- TEMAS --- */
            /* Dark Mode */
            body.theme-dark {
                --primary: #d0bcff;
                --primary-variant: #ccc2dc;
                --secondary: #ccc2dc;
                --surface: #141218;
                --surface-variant: #49454f;
                --background: #141218;
                --on-primary: #381e72;
                --on-surface: #e6e1e5;
                --on-surface-variant: #cac4d0;
                --outline: #938f99;
                --outline-variant: #49454f;
            }

            /* Alto Contraste */
            body.contrast-high {
                --primary: #ffff00 !important;
                --primary-variant: #ff0000 !important;
                --secondary: #ffffff !important;
                --surface: #000000 !important;
                --surface-variant: #1a1a1a !important;
                --background: #000000 !important;
                --on-primary: #000000 !important;
                --on-surface: #ffffff !important;
                --on-surface-variant: #ffff00 !important;
                --outline: #ffffff !important;
                --error: #ff0000 !important;
                --success: #00ff00 !important;
                --warning: #ffff00 !important;
                --info: #00ffff !important;
            }
            
            /* Ajustes Específicos para Alto Contraste */
            body.contrast-high .card, 
            body.contrast-high .modal, 
            body.contrast-high input, 
            body.contrast-high select,
            body.contrast-high .app-header {
                border: 2px solid #ffffff !important;
            }

            /* --- MODAL DE CONFIGURAÇÕES --- */
            .settings-section {
                margin-bottom: 24px;
                background: var(--surface-variant);
                padding: 16px;
                border-radius: var(--radius-lg);
                opacity: 0.9;
            }
            
            .settings-section h4 {
                margin-bottom: 12px;
                display: flex;
                align-items: center;
                gap: 8px;
                color: var(--on-surface);
            }

            .settings-controls {
                display: flex;
                gap: 10px;
                flex-wrap: wrap;
            }

            .setting-btn {
                padding: 10px 16px;
                border: 1px solid var(--outline);
                border-radius: var(--radius-md);
                background: var(--surface);
                color: var(--on-surface);
                cursor: pointer;
                transition: all 0.2s;
                flex: 1;
                text-align: center;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 6px;
                min-width: 100px;
            }

            .setting-btn:hover {
                background: var(--primary);
                color: var(--on-primary);
                border-color: var(--primary);
            }

            .setting-btn.active {
                background: var(--primary);
                color: var(--on-primary);
                border-color: var(--primary);
                font-weight: 700;
                box-shadow: 0 0 0 2px var(--surface), 0 0 0 4px var(--primary);
            }

            /* Slider de Tamanho da Fonte */
            .range-container {
                width: 100%;
                padding: 10px 0;
            }
            
            .range-labels {
                display: flex;
                justify-content: space-between;
                font-size: 12px;
                color: var(--on-surface-variant);
                margin-top: 5px;
            }
            
            input[type=range] {
                width: 100%;
                accent-color: var(--primary);
            }
        `;
                document.head.appendChild(style);
            },

            // Criar o Modal HTML
            injectModal: function () {
                const modalHtml = `
            <div id="modal-settings" class="modal-overlay hidden" style="z-index: 9999;">
                <div class="modal" style="max-width: 500px;">
                    <div class="modal-header">
                        <h3><i data-lucide="settings"></i> Configurações de Visualização</h3>
                        <button onclick="SettingsManager.close()"><i data-lucide="x"></i></button>
                    </div>
                    <div class="modal-body">
                        
                        <div class="settings-section">
                            <h4><i data-lucide="moon" width="18"></i> Aparência</h4>
                            <div class="settings-controls">
                                <button class="setting-btn" onclick="SettingsManager.setTheme('light')" id="btn-theme-light">
                                    <i data-lucide="sun" width="14"></i> Claro
                                </button>
                                <button class="setting-btn" onclick="SettingsManager.setTheme('dark')" id="btn-theme-dark">
                                    <i data-lucide="moon" width="14"></i> Escuro
                                </button>
                            </div>
                        </div>

                        <div class="settings-section">
                            <h4><i data-lucide="eye" width="18"></i> Contraste</h4>
                            <div class="settings-controls">
                                <button class="setting-btn" onclick="SettingsManager.setContrast('normal')" id="btn-contrast-normal">
                                    Normal
                                </button>
                                <button class="setting-btn" onclick="SettingsManager.setContrast('high')" id="btn-contrast-high">
                                    <i data-lucide="zap" width="14"></i> Alto Contraste
                                </button>
                            </div>
                        </div>

                        <div class="settings-section">
                            <h4><i data-lucide="type" width="18"></i> Tamanho da Fonte: <span id="font-size-display">100%</span></h4>
                            <div class="range-container">
                                <input type="range" min="85" max="150" step="5" value="100" id="font-size-slider" oninput="SettingsManager.setFontSize(this.value)">
                                <div class="range-labels">
                                    <span>Pequeno</span>
                                    <span>Normal</span>
                                    <span>Grande</span>
                                    <span>Extra</span>
                                </div>
                            </div>
                        </div>

                        <div class="settings-section">
                            <h4><i data-lucide="move-vertical" width="18"></i> Espaçamento de Texto</h4>
                            <div class="settings-controls">
                                <button class="setting-btn" onclick="SettingsManager.setSpacing('normal')" id="btn-spacing-normal">
                                    Padrão
                                </button>
                                <button class="setting-btn" onclick="SettingsManager.setSpacing('relaxed')" id="btn-spacing-relaxed">
                                    <i data-lucide="align-justify" width="14"></i> Expandido
                                </button>
                            </div>
                        </div>

                    </div>
                    <div class="modal-footer">
                        <button onclick="SettingsManager.reset()" style="color: var(--error); border-color: var(--error); margin-right: auto;" class="btn-cancel">
                            <i data-lucide="rotate-ccw" width="14"></i> Restaurar Padrão
                        </button>
                        <button onclick="SettingsManager.close()" class="btn-main">Concluído</button>
                    </div>
                </div>
            </div>
        `;
                document.body.insertAdjacentHTML('beforeend', modalHtml);
            },

            // Aplicar configurações ao Body/Root
            applySettings: function () {
                const body = document.body;

                // 1. Tema
                if (this.config.theme === 'dark') {
                    body.classList.add('theme-dark');
                } else {
                    body.classList.remove('theme-dark');
                }

                // 2. Contraste
                if (this.config.contrast === 'high') {
                    body.classList.add('contrast-high');
                } else {
                    body.classList.remove('contrast-high');
                }

                // 3. Tamanho da Fonte (aplica no HTML root para usar REM)
                document.documentElement.style.fontSize = (this.config.fontSize / 100 * 16) + 'px';

                // 4. Espaçamento
                if (this.config.lineHeight === 'relaxed') {
                    body.style.lineHeight = '1.8';
                    body.style.letterSpacing = '0.5px';
                } else {
                    body.style.lineHeight = '1.5';
                    body.style.letterSpacing = 'normal';
                }

                this.updateUI();
            },

            // Atualizar botões do modal para refletir estado
            updateUI: function () {
                // Remove active class
                document.querySelectorAll('.setting-btn').forEach(btn => btn.classList.remove('active'));

                // Add active class
                const themeBtn = document.getElementById(`btn-theme-${this.config.theme}`);
                if (themeBtn) themeBtn.classList.add('active');

                const contrastBtn = document.getElementById(`btn-contrast-${this.config.contrast}`);
                if (contrastBtn) contrastBtn.classList.add('active');

                const spacingBtn = document.getElementById(`btn-spacing-${this.config.lineHeight === 'relaxed' ? 'relaxed' : 'normal'}`);
                if (spacingBtn) spacingBtn.classList.add('active');

                // Slider
                const slider = document.getElementById('font-size-slider');
                const display = document.getElementById('font-size-display');
                if (slider) slider.value = this.config.fontSize;
                if (display) display.textContent = this.config.fontSize + '%';
            },

            // --- Setters ---

            setTheme: function (mode) {
                this.config.theme = mode;
                // Se ativar modo escuro, desativa alto contraste (conflito visual)
                if (mode === 'dark') this.config.contrast = 'normal';
                this.saveSettings();
            },

            setContrast: function (mode) {
                this.config.contrast = mode;
                // Se ativar alto contraste, força tema claro (melhor legibilidade)
                if (mode === 'high') this.config.theme = 'light';
                this.saveSettings();
            },

            setFontSize: function (val) {
                this.config.fontSize = parseInt(val);
                // Aplica imediatamente para preview
                document.documentElement.style.fontSize = (val / 100 * 16) + 'px';
                document.getElementById('font-size-display').textContent = val + '%';
                // Debounce do save não necessário aqui, mas ideal
                this.saveSettings();
            },

            setSpacing: function (mode) {
                this.config.lineHeight = mode === 'relaxed' ? 'relaxed' : 'normal';
                this.saveSettings();
            },

            reset: function () {
                this.config = {
                    theme: 'light',
                    contrast: 'normal',
                    fontSize: 100,
                    lineHeight: 'normal',
                    wordSpacing: 'normal'
                };
                this.saveSettings();
                showToast("Configurações restauradas", "success");
            },

            // --- Controle do Modal ---

            open: function () {
                document.getElementById('modal-settings').classList.remove('hidden');
                lucide.createIcons();
            },

            close: function () {
                document.getElementById('modal-settings').classList.add('hidden');
            },

            setupEventListeners: function () {
                // Fechar com ESC
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') this.close();
                });
            },

            // --- "Hack" para substituir o botão existente ---
            hijackSettingsButton: function () {
                // Procura todos os botões no dropdown
                const dropdownItems = document.querySelectorAll('.dropdown-item');

                dropdownItems.forEach(btn => {
                    // Verifica se o botão tem o ícone de settings ou texto "Configurações"
                    if (btn.innerHTML.includes('settings') || btn.textContent.includes('Configurações')) {
                        // Remove o onclick antigo (clonando o nó)
                        const newBtn = btn.cloneNode(true);
                        btn.parentNode.replaceChild(newBtn, btn);

                        // Adiciona o novo evento
                        newBtn.addEventListener('click', (e) => {
                            e.preventDefault();
                            e.stopPropagation();
                            // Fecha o dropdown do usuário se estiver aberto
                            document.getElementById('user-dropdown')?.classList.remove('show');
                            // Abre nossas configurações
                            this.open();
                        });

                        console.log('Botão de configurações atualizado com sucesso');
                    }
                });
            }
        };

        // Inicializar quando o DOM estiver pronto
        document.addEventListener('DOMContentLoaded', () => {
            SettingsManager.init();
        });

        document.addEventListener('DOMContentLoaded', function () {
            // Inicializar ícones
            lucide.createIcons();

            // Inicializar filtro padrão
            setTimeout(() => {
                if (document.getElementById('filter-all')) {
                    setTaskFilter('all');
                }
            }, 500);

            // Configurar busca
            const taskSearch = document.getElementById('task-search');
            if (taskSearch) {
                taskSearch.addEventListener('input', function (e) {
                    searchTasks(e.target.value);
                });
            }

            // Inicializar sistema de colaboração após login
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    setTimeout(() => {
                        RealTimeCollaboration.init();
                    }, 3000);
                }
            });
        });
    </script>

</body>

</html>
